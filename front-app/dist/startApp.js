var yr=Object.defineProperty;var a=(e,t)=>yr(e,"name",{value:t,configurable:!0});var b=(e,t)=>()=>(e&&(t=e(e=0)),t);var ae=(e,t)=>{for(var n in t)yr(e,n,{get:t[n],enumerable:!0})};var br,ke,dt=b(()=>{globalThis.lo=console.log;globalThis.delay=e=>new Promise(t=>setTimeout(t,e));br={proto:{html(e){return e!==void 0?(this.innerHTML=e,this):this.innerHTML},v(e){return e!==void 0?(this.value=e,this):this.value},on(e,t){this.addEventListener(e,t)},css(e,t=null){typeof e=="string"?t!==null?this.style[e]=t:this.style.cssText=e:Object.assign(this.style,e)},attrib(e,t=null){return t!==null?(this.setAttribute(e,t),this):this.getAttribute(e)||""},clA(e){return this.classList.add(e),this},clR(e){return this.classList.remove(e),this},clT(e){return this.classList.toggle(e),this},animateFade(e,t={}){let{time:n=200,cb:r}=t,s=this.style,i=50,o=n/i,l=(e===0?1:-1)/i,d=0;s.opacity=e.toString();let u=setInterval(()=>{if(d>=i){clearInterval(u),r?.();return}s.opacity=(parseFloat(s.opacity||"0")+l).toString(),d++},o);return this},fadeIn(e="block",t){return typeof e=="function"&&(t=e,e="block"),this.css("display",e),this.animateFade(0,{cb:t}),this.fade=!0,this},fadeOut(e){return this.animateFade(1,{time:300,cb:e}),setTimeout(()=>this.css("display","none"),300),this.fade=!1,this},fadeToggle(){return this.fade?this.fadeOut():this.fadeIn(),this},add(e){return this.appendChild(e),this},addUp(e){return this.insertBefore(e,this.firstChild),this},fade:!0},init(){Object.assign(HTMLElement.prototype,this.proto)},rand(e,t){return Math.round(Math.random()*(t-e)+e)},round(e,t){let n=Math.pow(10,t);return Math.round(e*n)/n},get(e){if(!e)return"";let t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),t.status===200?t.responseText:(t.status===404,"")}};br.init();ke=br});var _n,kt,g,Er,Mr,wr,Tr,T=b(()=>{_n=["apis","file","warning","cacheControllers/socketGeneral","mess/format/embed","mess/format/list","mess/format/media","mess/format/respone","mess/format/table","mess/format/text","mess/cmd","mess/format","mess/interact","mess/listeners","mess","mess/socket","mess/style","socket/_evt","socket/evt","socket/mess","socket/engine","socket","coreFunc","debug","features","init","start","contextMenuLib","swipeLib","components/contextMenu","components/emoji","components/mainView","components/media","components/realmUserProfile","components/voice","helpers/reloadImages","helpers/stateManager","helpers/uiFunc","interact/context","interact/mainView","interact/realmUser","interact/relations","interact/subscribeEventChnl","interact/ui","render/dm","render/event","render/realm","render/realmInit","render/user","render/utils","render/var","realmSettings","rs/channels","rs/emoji","rs/meta","rs/nav","rs/roles","rs/save","rs/users","rs/utils","rs/var","rs/webhooks","settings","settingsData","settingsLib","genId","perm","translate","utils","var/api","var/html","var/keys","var/staticData","var"],kt=[],g=a(e=>{kt.includes(e)||kt.push(e)},"default"),Er=a(()=>_n.filter(e=>!kt.includes(e)),"reqButNotReg"),Mr=a(()=>kt.filter(e=>!_n.includes(e)),"regButNotReq"),wr=a(()=>_n,"getReq"),Tr=a(()=>kt,"getReg")});var Bi={};var Lr=b(()=>{dt();T();g("init");localStorage.getItem("token")||(window.location.href="/login");document.querySelectorAll("[loadInner]").forEach(e=>{e.innerHTML=ke.get(e.getAttribute("loadInner"))});document.querySelectorAll(".delete").forEach(e=>{let t=parseInt(e.getAttribute("time"));setTimeout(()=>e.remove(),t)})});var Q,G,ee=b(()=>{Q={},G={};window.mglInt=Q;window.mglVar=G});var Cr={};ae(Cr,{default:()=>m,getEmptyRealmConfig:()=>$t});function $t(){return{users:[],roles:[],permission:0,text:[],desc:{},chnlPerms:{},threads:[]}}var kr,m,R=b(()=>{T();ee();g("var");kr={user:{_id:localStorage.getItem("user_id"),fr:localStorage.getItem("from"),status:"online",statusText:""},chat:{to:"main",chnl:"main",actMess:0,pinned:[],selectedMess:null},temp:{scrollBlock:!1,replyId:null,editId:null},privs:[],realms:[],realm:$t(),mainView:{friends:[],requests:[],page:"online"},settings:{notifications:localStorage.getItem("notifications")=="true"||!1,desktopHandling:localStorage.getItem("desktopHandling")=="true"||!1},blocked:[]},m=kr;G.vars=kr;a($t,"getEmptyRealmConfig")});var Sr={};ae(Sr,{coreHTML:()=>Ut,emojiHTML:()=>ne,mainViewHTML:()=>$,messHTML:()=>M,mglHTML:()=>xr,navHTML:()=>D,otherHTML:()=>Ot,renderHTML:()=>X,voiceHTML:()=>ge});function k(e,t){return(t||document).querySelector(e)}function Vi(){let e=k("#messages_nav");return{div:k("#messages"),input:document.querySelector("#mess-input"),replyClose:k("#replyClose"),editClose:k("#editClose"),sendBtn:document.querySelector("#barc__sendBtn"),linkClick:k("#linkClick"),nav:e,nav_priv:k("#messages_nav__priv",e),nav_realm:k("#messages_nav__realm",e),sendBtnImg:document.querySelector("#barc__sendBtn__img"),bar:k("#bar"),barc__commads:k("#barc__commads")}}function Ni(){return{nav:k("#navs"),priv:k("#navs__priv"),realm:k("#navs__realm"),main:k("#navs__main"),realms:k("#navs__realms"),main__call:k("#navs__main__call"),navs__user:k("#navs__user"),user__name:k("#navs__user__name"),user__status:k("#navs__user__status"),realm__name:k("#navs__realm__name"),realm__panel:k("#navs__realm__panel"),realm__channels:k("#navs__realm__channels"),realm__users:k("#navs__realms__users")}}function Wi(){return{messages_nav__realm__description:k("#messages_nav__realm__description")}}function zi(){let e=k("#realmEvents");return{navs__priv:k("#navs__priv"),realms__content:k("#realms__content"),userProfile:k("#userProfile"),events:e,events__container:k("#realmEvents__container",e),events__add:k("#realmEvents__add",e),realmUserProfile:k("#realmUserProfile")}}function Ki(){let e=k("#main__view");return{div:e,nav:k("#main__view__nav"),friends:k("#main__view__friends",e),requests:k("#main__view__requests",e),requestCount:k("#main__view__requests__count",e),noFriends:k("#main__view__noFriends",e),noRequests:k("#main__view__noRequests",e),friendsContainer:k("#main__view__friends_container",e),requestsContainer:k("#main__view__requests_container",e)}}function Xi(){return{makeRealm:k("#makeRealm")}}function Yi(){return{div:k("#voice_call"),mediaContainer:k("#voice_call_media"),users:k("#voice_call_users"),muteMic:k("#voice_call_mute_mic"),voiceShow:k("#realms__voice_show")}}function Ji(){return{div:k("#emojiDiv"),input:document.querySelector("#emocji-input"),container:k("#emoji__container"),nav:k("#emoji__nav")}}var M,D,Ut,X,$,Ot,ge,ne,xr,W=b(()=>{T();g("var/html");a(k,"qd");a(Vi,"mess");a(Ni,"nav");a(Wi,"core");a(zi,"render");a(Ki,"mainView");a(Xi,"other");a(Yi,"voice");a(Ji,"emoji");M=Vi(),D=Ni(),Ut=Wi(),X=zi(),$=Ki(),Ot=Xi(),ge=Yi(),ne=Ji(),xr={mess:M,nav:D,core:Ut,render:X,mainView:$,other:Ot,voice:ge,emoji:ne};window.mglHTML=xr});var Hr={};ae(Hr,{default:()=>p});var Ir,p,F=b(()=>{T();ee();g("socket");Ir=io("/",{transports:["websocket"],auth:{token:localStorage.getItem("token")},autoConnect:!1,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:1/0}),p=Ir;G.socket=Ir});var ut,x,ie=b(()=>{T();B();ee();g("debug");ut={isDebug:localStorage.getItem("config.debug")=="true",lvl:parseInt(localStorage.getItem("config.debugLvl"),10)||0,init(){setTimeout(()=>{E.app.apiType=="rn"&&(this.isDebug=!0,this.lvl=15)},1e3)},msg(e,...t){this.isDebug&&(this.lvl&e)!==0&&(lo(...t),E.app.apiType=="rn"&&E.api.send({type:"debug",msg:t.length==1?t[0]:t}))}},x=ut;Q.debug={enable(e,t,n,r){ut.isDebug=e||t||n||r;let s=(e?1:0)|(t?2:0)|(n?4:0)|(r?8:0);localStorage.setItem("config.debug",ut.isDebug.toString()),localStorage.setItem("config.debugLvl",s.toString())},disable(){ut.isDebug=!1,ut.lvl=0,localStorage.setItem("config.debug",ut.isDebug.toString()),localStorage.setItem("config.debugLvl","0")}}});var Gi,J,qe=b(()=>{T();R();g("perm");Gi={hasAllPermissions(e,t){return t.every(n=>(e&n)!==0)},hasAnyPermission(e,t){return t.some(n=>(e&n)!==0)},canAction(e){let t=m.realm.permission||0;return Array.isArray(e)||(e=[e]),this.hasPermission(t,1)||this.hasAnyPermission(t,e)},isAdmin(){return this.hasPermission(m.realm.permission||0,1)},hasPermission(e,t){return(e&t)!==0}},J=Gi});var Dr,H,_e=b(()=>{T();ee();g("var/api");Dr={temp:{user:{main:{}},realm:{}},user_state:{},lastMess:{}},H=Dr;G.apiVars=Dr});function Pr(e){de=e}var Ke,Xe,de,V,Vt,vn=b(()=>{T();$e();R();oe();F();W();j();U();qe();_e();g("mess/cmd");Ke=M.barc__commads;Ke.style.display="none";Xe={system:{silent:{args:[{name:"silent",type:"boolean"},{name:"message",type:"text"}],exe(e,t){if(t.length==0)return 1;t[0]&&(e.silent=!0),e.msg=t[1]}},search:{args:[{name:"from",type:"user",optional:!0},{name:"mentions",type:"text",optional:!0},{name:"before",type:"date",optional:!0},{name:"during",type:"date",optional:!0},{name:"after",type:"date",optional:!0},{name:"pinned",type:"boolean",optional:!0},{name:"message",type:"text",optional:!0}],exe(e,t){if(t.length==0)return 1;let n={from:t[0],mentions:t[1],before:t[2],during:t[3],after:t[4],pinned:t[5],message:t[6]};return p.emit("message.search",m.chat.to,m.chat.chnl,n),1}},createLinkEmbed:{args:[{name:"url",type:"text"}],exe(e,t){return t.length==0||p.emit("send.embed.og",m.chat.to,m.chat.chnl,t[0]),1}},createDataEmbed:{args:[{name:"title",type:"text"},{name:"description",type:"text",optional:!0},{name:"url",type:"text",optional:!0},{name:"image",type:"text",optional:!0},{name:"custom fields",type:"map",optional:!0}],exe(e,t){if(t.length==0)return 1;let n={title:t[0],description:t[1],url:t[2],image:t[3],customFields:t[4]};return p.emit("send.embed.data",m.chat.to,m.chat.chnl,n),1}},clear:{args:[{name:"delete",type:"number"}],exe(e,t){if(t.length==0)return 1;let n=!1;if(m.chat.to.startsWith("$"))n=!1;else{if(m.chat.to=="main")return 1;if(!m.realm)return 1;n=J.canAction(2)}let r=Array.from(document.querySelectorAll(".mess_message")).slice(-t[0]).map(s=>{let i=s.id.replace("mess__","");return s.querySelector(".mess_meta").getAttribute("_author")==m.user._id||n?i:null}).filter(s=>s);return p.emit("messages.delete",m.chat.to,r),1}}}};Object.keys(Xe).forEach(e=>{Object.keys(Xe[e]).forEach(t=>{Xe[e][t].name=t})});de=null;a(Pr,"setCurrentCmd");V={temp:[],check(){let e=M.input.value;if(de){(!e.trim()||e=="/")&&V.close();return}if(!e.startsWith("/")&&e!="/"){Ke.style.display="none";return}if(e.split(`
`).length>1)return V.close();Ke.style.display="",Ke.innerHTML="";let t=e.trim().split(" ")[0].substring(1),n={};Object.keys(Xe).forEach(i=>{Object.keys(Xe[i]).forEach(o=>{(o.startsWith(t)||t=="")&&(n[i]||(n[i]={}),n[i][o]=Xe[i][o])})});let r=[],s=[];if(Object.keys(n).forEach(i=>{Object.keys(n[i]).forEach(o=>{r.push(n[i][o]),s.push({c:i,name:o})})}),r.length==0){Ke.innerHTML="<h2>No commands</h2>",de=null;return}if(r.length==1){de=r[0];let{name:i}=s[0],o=e.split(" ");o[0]="/"+i,M.input.value=o.join(" ")+" ",V.handleCommandInput(),setTimeout(()=>{P.setSelectionStart()},100),C.focusInp();return}de=null,Object.keys(n).forEach(i=>{let o=document.createElement("div");o.innerHTML=`<h2>${i}</h2>`;let l=document.createElement("ul");o.appendChild(l),Object.keys(n[i]).forEach(u=>{let h=document.createElement("li");h.innerHTML=u,h.style.cursor="pointer",h.tabIndex=0,h.addEventListener("click",f),h.addEventListener("keydown",y=>{y.key=="Enter"&&f()}),l.appendChild(h);function f(){de=n[i][u];let y=e.split(" ");y[0]="/"+u,M.input.value=y.join(" ")+" ",V.handleCommandInput(),setTimeout(()=>{P.setSelectionStart()},100),C.focusInp()}a(f,"selectCmd")});function d(u){u.key==="Tab"&&(u.preventDefault(),l.querySelector("li")?.focus(),document.removeEventListener("keydown",d))}a(d,"tab"),document.addEventListener("keydown",d),Ke.appendChild(o)})},close(){de=null,Ke.style.display="none",M.input.value="",V.temp=[]},send(e){if(!de)return this.close(),0;if(!this.checkArgs())return 2;this.changeArgs();let n=V.temp,r=de.exe(e,n)||0;return this.close(),r},checkArgs(){let e=V.temp,t=de.args;for(let n=0;n<t.length;n++){let r=t[n],s=e[n];if(r.type!="map"){if(!s||s.trim()==""){if(r.optional)continue;return!1}}else if(Object.keys(s).length==0){if(r.optional)continue;return!1}if(r.type=="boolean"&&s!="true"&&s!="false")return!1;if(r.type=="number"&&isNaN(s))return!1;if(r.type=="text"&&s.trim()=="")return!1;if(r.type=="user"&&s.trim()=="")return!1;if((r.type=="date"||r.type=="date-time")&&isNaN(Date.parse(s)))return!1;if(r.type=="time"){let[i,o]=s.split(":");if(isNaN(i)||isNaN(o))return!1}else{if(r.type=="list"&&!r.list.includes(s))return!1;if(r.type=="map"&&Object.keys(s).length==0)return!1}}return!0},changeArgs(){let e=V.temp,t=de.args;for(let n=0;n<t.length;n++){let r=t[n],s=e[n];if(!s||r.type!="map"&&s.trim()==""){if(r.optional)continue;return!1}if(r.type=="boolean")e[n]=s=="true";else if(r.type=="number")e[n]=Number(s);else if(r.type=="user"){if(s.split("-").length==0)continue;let i=H.temp.user,o=new Map;if(Object.keys(i).forEach(l=>{o.set(i[l],l)}),!o.has(s)){v.uiMsgT(c.ui.message.user_not_found),delete e[n];continue}e[n]=o.get(s)}else if(r.type=="map"){if(Object.keys(s).length==0){e[n]={};continue}let i={};Object.keys(s).forEach(o=>{let l=s[o];!l.key||!l.value||(i[l.key]=l.value)}),e[n]=i}}},handleCommandInput(){if(!de)return;let e=Ke,t=document.createElement("div");t.innerHTML="<h2>"+c.ui.message.command+" ("+de.name+")</h2>";let n=document.createElement("ul"),r=de.args;V.temp=new Array(r.length);let s=null,i=document.createElement("ul");r.forEach((l,d)=>{let u=document.createElement("li");u.innerHTML=l.name;let h="",f;switch(l.type){case"boolean":h="true/false",f=document.createElement("select"),["false","true"].forEach(w=>{let I=document.createElement("option");I.value=w,I.text=w,f.appendChild(I)}),f.value="false",V.temp[d]="false",f.addEventListener("change",()=>{V.temp[d]=f.value==="true"?"true":"false"});break;case"number":h="number",f=document.createElement("input"),f.type="number",f.addEventListener("input",()=>{V.temp[d]=f.value});break;case"text":h="text",f=document.createElement("input"),f.type="text",f.addEventListener("input",()=>{V.temp[d]=f.value});break;case"user":h="text",f=document.createElement("input"),f.type="text",f.addEventListener("input",()=>{V.temp[d]=f.value});break;case"date":h="date",f=document.createElement("input"),f.type="date",f.addEventListener("input",()=>{V.temp[d]=f.value});break;case"time":h="time",f=document.createElement("input"),f.type="time",f.addEventListener("input",()=>{V.temp[d]=f.value});break;case"date-time":h="date-time",f=document.createElement("input"),f.type="datetime-local",f.addEventListener("input",()=>{V.temp[d]=f.value});break;case"list":let y=l;h="list",f=document.createElement("select"),y.list.forEach(w=>{let I=document.createElement("option");I.value=w,I.text=w,f.appendChild(I)}),f.value=y.list[0],V.temp[d]=y.list[0],f.addEventListener("change",()=>{V.temp[d]=f.value});break;case"map":h="map",f=document.createElement("div"),V.temp[d]={};let _=document.createElement("button");_.innerHTML="Create Map",_.style.marginTop="5px",f.appendChild(_),f.appendChild(document.createElement("br")),_.addEventListener("click",()=>{let w=document.createElement("input"),I=document.createElement("input"),Z=document.createElement("span");f.appendChild(w),f.appendChild(Z),f.appendChild(I),f.appendChild(document.createElement("br")),w.style.marginTop="5px",Z.innerHTML=": ";let he=Object.keys(V.temp[d]).length;V.temp[d][he]={},w.addEventListener("input",()=>{V.temp[d][he].key=w.value}),I.addEventListener("input",()=>{V.temp[d][he].value=I.value})});break}u.innerHTML+=` (${h})${l.optional?" (optional)":""} &nbsp;`,f&&u.appendChild(f),!s&&f&&(s=f),i.appendChild(u)}),n.appendChild(i);function o(){s&&(s.focus(),document.removeEventListener("keydown",o))}a(o,"tab"),document.addEventListener("keydown",o),t.appendChild(n),e.innerHTML="",e.appendChild(t)}};M.input.addEventListener("input",V.check);Vt=V});var Fr={};ae(Fr,{MediaPopup:()=>Nt,default:()=>Wt});function Ar(e,t={}){return new Nt(Zi,e,t)}var Zi,Nt,Wt,yn=b(()=>{T();j();ee();g("components/media");Zi=document.querySelector("#mediaPopup"),Nt=class{static{a(this,"MediaPopup")}container;url;options;state;overlay;content;media;controlsResets=[];constructor(t,n,r){this.container=t,this.url=n,this.options={maxScale:r.maxScale||10,minScale:r.minScale||.1,scaleStep:r.scaleStep||.1,rotationStep:r.rotationStep||15,doubleTapDelay:r.doubleTapDelay||300,isVideo:"auto",...r},this.state={scale:1,rotation:0,position:{x:0,y:0},brightness:100,contrast:100,saturation:100,blur:0,isDragging:!1,dragStart:{x:0,y:0},lastTap:0,lastTapPosition:{x:0,y:0},initialPinchDistance:null,initialRotation:null,previousTouches:null,isAnimating:!1},this.init()}init(){this.overlay=document.createElement("div"),this.overlay.className="media-popup-overlay",this.overlay.fadeIn(""),this.content=document.createElement("div"),this.content.className="media-popup-content";let t=this.options.isVideo;t==="auto"&&(t=/\.(mp4|webm|ogg|mkv|webm|avi)$/i.test(this.url)),this.media=document.createElement(t?"video":"img"),this.media.className="media-popup-media",this.media.src=this.url,t&&(this.media.controls=!0);let n=document.createElement("div");n.className="media-popup-controls",this.controlsResets=[];let r=c.media;this.addControlGroup(n,[{icon:r.zoom+"+",action:a(()=>this.zoom(1+this.options.scaleStep),"action"),title:r.zoom_in},{icon:r.zoom+"-",action:a(()=>this.zoom(1-this.options.scaleStep),"action"),title:r.zoom_out},{icon:r.rotate+" <",action:a(()=>this.rotate(-this.options.rotationStep),"action"),title:r.rotate_left},{icon:r.rotate+" >",action:a(()=>this.rotate(this.options.rotationStep),"action"),title:r.rotate_right},{icon:r.flip,action:a(()=>this.flip(),"action"),title:r.flip},{icon:r.reset,action:a(()=>this.resetTransforms(),"action"),title:r.reset_transforms},{icon:"\u2716",action:a(()=>this.close(),"action"),title:c.uni.close}]),n.appendChild(document.createElement("br"));let s=document.createElement("div");s.className="media-popup-sliders",this.addSlider(s,"brightness",r.brightness,0,200),this.addSlider(s,"contrast",r.contrast,0,200),this.addSlider(s,"saturation",r.saturation,0,200),this.addSlider(s,"blur",r.blur,0,10),n.appendChild(s),this.content.appendChild(this.media),this.overlay.appendChild(this.content),this.overlay.appendChild(n),this.container.appendChild(this.overlay),this.setupEventListeners(),this.updateTransform()}addControlGroup(t,n){let r=document.createElement("div");r.className="media-popup-control-group",n.forEach(s=>{let i=document.createElement("button");i.className="media-popup-btn",i.textContent=s.icon,i.title=s.title,i.onclick=s.action,r.appendChild(i)}),t.appendChild(r)}addSlider(t,n,r,s,i){let o=document.createElement("div");o.className="media-popup-slider-container";let l=document.createElement("span");l.textContent=r;let d=document.createElement("input");d.type="range",d.className="media-popup-slider",d.min=s.toString(),d.max=i.toString();let u=this.state[n]??100;d.value=u,this.controlsResets.push(()=>d.value=u);let h=document.createElement("span");h.className="media-popup-value",h.textContent=d.value,d.addEventListener("input",f=>{let y=f.target;this.state[n]=y.value,h.textContent=y.value,this.updateFilters()}),o.appendChild(l),o.appendChild(d),o.appendChild(h),t.appendChild(o)}setupEventListeners(){this.content.addEventListener("wheel",t=>{t.preventDefault();let n=t.deltaY>0?-this.options.scaleStep:this.options.scaleStep;this.zoom(1+n)}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.close(),t.key==="+"&&this.zoom(1+this.options.scaleStep),t.key==="-"&&this.zoom(1-this.options.scaleStep),t.key==="ArrowLeft"&&this.rotate(-this.options.rotationStep),t.key==="ArrowRight"&&this.rotate(this.options.rotationStep)}),this.media.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.media.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.media.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.media.addEventListener("touchend",this.handleTouchEnd.bind(this)),this.media.addEventListener("touchcancel",this.handleTouchEnd.bind(this))}handleMouseDown(t){t.preventDefault(),this.state.isDragging=!0,this.state.dragStart={x:t.clientX-this.state.position.x,y:t.clientY-this.state.position.y}}handleMouseMove(t){this.state.isDragging&&(this.state.position={x:t.clientX-this.state.dragStart.x,y:t.clientY-this.state.dragStart.y},this.updateTransform())}handleMouseUp(){this.state.isDragging=!1}handleTouchStart(t){t.preventDefault();let n=t.touches;if(this.state.previousTouches=Array.from(n).map(r=>({identifier:r.identifier,pageX:r.pageX,pageY:r.pageY})),n.length===1){let r=n[0],s=Date.now(),i=this.state.lastTap,o=this.state.lastTapPosition;s-i<this.options.doubleTapDelay&&this.getDistance({x:r.pageX,y:r.pageY},o)<30&&this.handleDoubleTap(r),this.state.lastTap=s,this.state.lastTapPosition={x:r.pageX,y:r.pageY},this.startDrag(r)}else n.length===2&&(this.state.initialPinchDistance=this.getPinchDistance(n),this.state.initialRotation=this.getRotationAngle(n),this.state.isDragging=!1)}handleTouchMove(t){t.preventDefault();let n=t.touches;if(this.state.previousTouches){if(n.length===1&&this.state.isDragging)this.drag(n[0]);else if(n.length===2){let r=this.getPinchDistance(n),s=this.getRotationAngle(n);if(this.state.initialPinchDistance>0){let i=r/this.state.initialPinchDistance;this.handlePinch(i)}if(this.state.initialRotation!==null){let i=s-this.state.initialRotation;this.handleRotation(i)}this.state.previousTouches=Array.from(n).map(i=>({identifier:i.identifier,pageX:i.pageX,pageY:i.pageY}))}}}handleTouchEnd(t){t.preventDefault(),t.touches.length===0&&(this.state.isDragging=!1,this.state.initialPinchDistance=null,this.state.initialRotation=null,this.state.previousTouches=null)}handleDoubleTap(t){let n=this.state.scale>1?1:2;this.zoom(n,t.pageX,t.pageY)}startDrag(t){this.state.isDragging=!0,this.state.dragStart={x:t.pageX-this.state.position.x,y:t.pageY-this.state.position.y}}drag(t){this.state.position={x:t.pageX-this.state.dragStart.x,y:t.pageY-this.state.dragStart.y},this.updateTransform()}handlePinch(t){this.zoom(t)}handleRotation(t){this.state.rotation=t,this.updateTransform()}zoom(t,n=void 0,r=void 0){let s=this.state.scale*t;s<this.options.minScale||s>this.options.maxScale||(n!==void 0&&r!==void 0&&(this.state.position.x+=(this.media.clientWidth/2-n)*(1-t),this.state.position.y+=(this.media.clientHeight/2-r)*(1-t)),this.state.scale=s,this.updateTransform())}rotate(t){this.state.rotation+=t,this.updateTransform()}flip(){this.state.rotation+=180,this.updateTransform()}resetTransforms(){this.state={...this.state,scale:1,rotation:0,position:{x:0,y:0},brightness:100,contrast:100,saturation:100,blur:0},this.updateFilters(),this.updateTransform(),this.controlsResets.forEach(t=>t())}updateTransform(){this.media.style.transform=`
        translate(${this.state.position.x}px, ${this.state.position.y}px)
        scale(${this.state.scale})
        rotate(${this.state.rotation}deg)
      `}updateFilters(){this.media.style.filter=`
        brightness(${this.state.brightness}%)
        contrast(${this.state.contrast}%)
        saturate(${this.state.saturation}%)
        blur(${this.state.blur}px)
      `}close(){let t=this;this.overlay.fadeOut(()=>t.container.removeChild(t.overlay))}getPinchDistance(t){let n=t[0].pageX-t[1].pageX,r=t[0].pageY-t[1].pageY;return Math.sqrt(n*n+r*r)}getRotationAngle(t){return Math.atan2(t[1].pageY-t[0].pageY,t[1].pageX-t[0].pageX)*(180/Math.PI)}getDistance(t,n){return Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2))}};a(Ar,"createMediaPopup");Wt=Ar;Q.createMediaPopup=Ar});function bn(e){if(!e)return;function t(n){let r=new XMLHttpRequest;return r.open("HEAD",n,!1),r.send(),r.status==200}if(a(t,"check"),/\.(mp3|wav|ogg|.m4a)$/i.test(e)){if(!t(e))return;let n=document.createElement("audio");return n.src=e,n.controls=!0,n}if(/\.(mp4|mkv|webm|avi)$/i.test(e)){if(!t(e))return;let n=document.createElement("video");return n.src=e,n.controls=!0,n.style.maxWidth="65%",n.style.height="auto",n.style.borderRadius="2rem",n.style.cursor="zoom-in",n.onclick=()=>Wt(e,{isVideo:!0}),n}if(/\.(png|jpg|gif|ico|jpeg|webp|svg)$/i.test(e)){if(!t(e))return;let n=document.createElement("img");return n.src=e,n.style.maxWidth="100%",n.style.height="auto",n.style.cursor="zoom-in",n.onclick=()=>Wt(e,{isVideo:!1}),n}if(e.includes("youtube.com")||e.includes("youtu.be")){let n=function(i){let o=i.match(/(?:\?v=|\/embed\/|\.be\/|\/v\/|\/\d{1,2}\/|\/e\/|watch\?v=|youtu\.be\/|youtube\.com\/(?:v|e|embed)\/|youtube\.com\/user\/[^#\/]+#p\/[^#\/]+\/)([^"&?\/ ]{11})/);return o&&o[1]?o[1]:null};a(n,"extractYouTubeVideoId");let r=n(e),s=document.createElement("iframe");return s.src=`https://www.youtube.com/embed/${r}`,s.allowFullscreen=!0,s.style.maxWidth="100%",s.style.width="500px",s.style.height="300px",s.style.borderRadius="2rem",s}if(e.includes("tiktok.com")){let r=function(i){let o=/tiktok\.com\/(?:@[\w.-]+\/video\/|v\/|embed\/v2\/)([\w-]+)/,l=i.match(o);return l?l[1]:null};a(r,"extractTikTokVideoId");let n=document.createElement("iframe"),s=r(e);return n.src=`https://www.tiktok.com/embed/v2/${s}`,n.allowFullscreen=!0,n.style.maxWidth="100%",n.style.width="400px",n.style.height="700px",n.style.borderRadius="2rem",n}if(e.includes("reddit.com")){e=(e.split("?")||[e])[0],e.endsWith("/")||(e+="/");let s=JSON.parse(ke.get(`${e}.json?limit=2`))[0]?.data.children[0]?.data,i=document.createElement("div"),o=s.title,l=s.author;return i.innerHTML=`autor: ${l}<br />tytu\u0142: ${o}`,i}if(e.includes("spotify.com")){let r=function(i){let o=i.match(/track\/([a-zA-Z0-9]+)/);if(o&&o[1])return"track/"+o[1];let l=i.match(/playlist\/([a-zA-Z0-9]+)/);return l&&l[1]?"playlist/"+l[1]:null};a(r,"extractSpotifyId");let n=document.createElement("iframe"),s=r(e);return s?(n.src=`https://open.spotify.com/embed/${s}`,n.allowFullscreen=!0,n.style.maxWidth="100%",n.style.width="400px",n.style.height="84px",n.style.borderRadius="1rem",n):null}}var Rr=b(()=>{dt();T();yn();g("mess/format/media");a(bn,"format_media")});var zt,jr,qr=b(()=>{T();g("mess/format/list");zt={calculateLevels(e){let t=[],n=null;return e.forEach((r,s)=>{if(r.trim()===""){t.push({line:r,lvl:0});return}let o=r.length-r.trimStart().length;if(n===null&&s>0&&o>0){let l=e[s-1].length-e[s-1].trimStart().length;o>l&&(n=o-l)}if(n!==null&&o%n!==0){let l=Math.round(o/n)*n;t.push({line:r,lvl:l/n})}else{let l=n?o/n:o>0?1:0;t.push({line:r,lvl:l})}}),t},buildTree(e){let t=/^(?:[-*]|\d+[.)]?|[a-zA-Z][.)])\s/,n=[],r=[{children:n,lvl:-1}];function s(i){let o=i.trim();return/^[-*]\s/.test(o)?"bullet":/^\d[.)]?\s/.test(o)?"decimal":/^[a-z][.)]?\s/.test(o)?"lower-alpha":/^[A-Z][.)]?\s/.test(o)?"upper-alpha":null}return a(s,"getBulletType"),e.forEach(({line:i,lvl:o})=>{let l=i.trim(),u=t.test(l)?s(l):null,h={line:i,children:[],bulletType:u};for(;r.length>0&&r[r.length-1].lvl>=o;)r.pop();r[r.length-1].children.push(h),r.push({...h,lvl:o})}),n},treeToHtml(e,t,n){let r="",s=["decimal","lower-alpha","upper-alpha","lower-roman","upper-roman"],i=!0;function o(l,d=0){if(l.bulletType===null)r+=l.line.trim()+"<br />",i=!0;else{let u=s.includes(l.bulletType)?"ol":"ul",[,...h]=l.line.trim().split(/\s+/);i&&(r+=`<${u} style="list-style-type: ${l.bulletType};">`),r+=`<li style="margin-left: ${t*(d+1)}${n}; list-style-type: ${l.bulletType};">${h}</li>`,l.children.length>0&&(i=!0,l.children.forEach(f=>{o(f,d+1)}),i=!1),i&&(r+=`</${u}>`),i=!1}}return a(o,"processNode"),e.forEach(l=>{o(l)}),r},cpu(e,t=0,n=""){let r=e.split(/\n|\<br\>|\<br\/\>|\<br \/>/),s=zt.calculateLevels(r),i=zt.buildTree(s);return zt.treeToHtml(i,t,n).replace(/<br\s*\/?>\s*$/i,"")}},jr=zt});function En(e){let t=e.trim().split(`
`),n='<div class="table_wrap"><table>';return t.forEach((r,s)=>{let i=r.split("|").map(o=>o.trim()).filter(o=>o);s===0?(n+="<thead><tr>",i.forEach(o=>{n+=`<th>${o}</th>`}),n+="</tr></thead><tbody>"):(n+="<tr>",i.forEach(o=>{n+=`<td>${o}</td>`}),n+="</tr>")}),n+="</tbody></table></div>",n}var $r=b(()=>{T();g("mess/format/table");a(En,"format_wrapTable")});function Mn(e){e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;");let t=/\`\`\`(.*?)\`\`\`/gs,n=e.match(t),r=[];if(n)for(let s of n){let i=s.slice(3,-3);r.push(i);let o=`@EXCLUSION${r.length}@`;e=e.replace(s,o)}e=e.replace(/((?:^\|.*\|$\n?)+)/gm,s=>En(s)),e=Kt(e,"**","b"),e=Kt(e,"//","i"),e=Kt(e,"--","strike"),e=Kt(e,"__","u"),e=e.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" onclick="mglInt.mess.linkClick(event)">$1</a>').replace(/(\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b)/g,'<a href="mailto:$1">$1</a>').replace(/##([0-9A-Fa-f]{3,6})\s(.*?)\s#c/g,'<span style="color:#$1">$2</span>').replace(/#([a-zA-Z]+)\s(.*?)\s#c/g,'<span style="color:$1">$2</span>').replace(/#(fc)\s(.*?)\s#c/gi,'<span style="color:var(--accent)">$2</span>').replace(/(?:&lt;|<)\!\s*(.*?)\s*!(?:&gt;|>)/g,'<span class="spoiler" onclick="mglInt.mess.spoiler(event)">$1</span>').replaceAll(`
`,"<br />").replaceAll("\\n","<br />").replace(/(?<=^|\s)---(?=\s|$)/g,"<hr />"),e=jr.cpu(e,1,"rem");for(let s=0;s<r.length;s++){let i=`<pre>${r[s]}</pre>`,o=`@EXCLUSION${s+1}@`;e=e.replace(o,i)}return e=e.replace(/:([a-z0-9]+-[a-z0-9]+-[a-z0-9]+):/g,(s,i)=>`<img src="/userFiles/realms/${m.chat.to}/emojis/${i}.png" class="message_emoji" alt=":${i}:">`),e}function Kt(e,t,n){let r="",s=!1,i="";for(let o=0;o<e.length;o++)e.slice(o,o+t.length)===t?(s?(i.trim()===""||i.startsWith(" ")||i.endsWith(" ")?r+=t+i+t:r+=`<${n}>${i}</${n}>`,i="",s=!1):(i===""?s=!0:r+=i,i=""),o+=t.length-1):s?i+=e[o]:r+=e[o];return s&&(r+=t+i),r}var Ur=b(()=>{T();R();qr();$r();g("mess/format/text");a(Mn,"format_text");a(Kt,"markCpu")});function Qi(e,t){let n=/^[\p{Extended_Pictographic}]+$/u.test(e),r=/^(:[a-z0-9]+-[a-z0-9]+-[a-z0-9]+:)+$/g.test(e);return r&&t.querySelectorAll("img").forEach(s=>{function i(){s.removeEventListener("error",i),t.clR("mess__text__emoji")}a(i,"notLoaded"),s.addEventListener("error",i)}),n||r}var Or,Qe,Xt=b(()=>{T();Rr();Ur();g("mess/format");Or={formatMess(e,t){let n=Mn(e);t.innerHTML=n;let r=Or.getElements(e);for(let s of r)t.appendChild(document.createElement("br")),t.appendChild(s);Qi(e,t)&&t.classList.add("mess__text__emoji")},getElements(e){let t=/(https?:\/\/[^\s]+)/g,n=e.match(t);return n?n.map(r=>bn(r)).filter(r=>!!r):[]}};a(Qi,"isEmojiMessage");Qe=Or});var Yt,Ye,Ct=b(()=>{T();U();ie();j();g("file");Yt={read(e){let{file:t,callback:n,maxSize:r,maxName:s,endpoint:i}=e;if(!t||!n||!r||!s||!i)return;if(t.size>r){v.uiMsgT(c.ui.file.size_limit,r/1024/1024+"MB");return}if(t.name.length>s){v.uiMsgT(c.ui.file.name_limit,s);return}let o=new FileReader;o.onload=()=>{let l=new XMLHttpRequest;l.open("POST",i),l.onload=()=>{l.status===200?(v.uiMsgT(c.ui.file.uploaded),n(l)):v.uiMsgT(c.ui.file.upload_error,[": "+l.statusText])},l.onerror=()=>{v.uiMsgT(c.ui.file.upload_error)};let d=localStorage.getItem("token");if(!d){v.uiMsgT(c.api.auth_error);return}l.setRequestHeader("Authorization",d);let u=new FormData;u.append("file",t),e.additionalFields&&e.additionalFields(l,u),l.send(u)},o.readAsArrayBuffer(t)},profile(e){let t={file:e,callback:a(()=>{x.msg(1,c.ui.file.uploaded)},"callback"),maxSize:4194304,maxName:60,endpoint:"/api/profile/upload"};Yt.read(t)},realm(e,t){let n={file:e,callback:a(()=>{x.msg(1,c.ui.file.uploaded)},"callback"),maxSize:4194304,maxName:60,endpoint:"/api/realm/profile/upload",additionalFields:a(r=>{r.setRequestHeader("realm",t)},"additionalFields")};Yt.read(n)},emocji(e,t){let n={file:e,callback:a(()=>{x.msg(1,c.ui.file.uploaded)},"callback"),maxSize:4194304,maxName:100,endpoint:"/api/emoji/upload",additionalFields:a(r=>{r.setRequestHeader("realm",t)},"additionalFields")};Yt.read(n)}},Ye=Yt});var Br,Ce,Ue,wn,Tn=b(()=>{dt();T();W();ee();R();g("components/emoji");Br=JSON.parse(ke.get("/assets/emoji.json")),Ce={categories:[],emojis:{}},Ue={getMathEmojisName(e){let t=[...Ce.categories,...Br.categories],n={};function r(s,i){i.includes(e)?(n[s]||(n[s]=[]),n[s].push(i)):Ue.getEmojiFromName(i).keywords.filter(l=>l.includes(e)).length>0&&(n[s]||(n[s]=[]),n[s].push(i))}a(r,"processEmoji");for(let s of t)for(let i of s.emojis)r(s.id,i);return n},getEmojiFromName(e){let t=Ce.emojis[e];return t||(t=Br.emojis[e],t||null)},renderEmoji(){let e=ne.input.value,t=Ue.getMathEmojisName(e);ne.container.innerHTML="",ne.nav.innerHTML="";for(let n of Object.keys(t)){let r=t[n];if(!r)continue;let s=document.createElement("button");s.classList.add("btn"),s.innerHTML=n,ne.nav.appendChild(s);let i=document.createElement("div");i.innerHTML=`<h1>${n}</h1>`;let o=document.createElement("div");o.classList.add("emoji__category"),i.appendChild(o);for(let l of r){let d=Ue.getEmojiFromName(l);if(!d)continue;let u;d.html?(u=document.createElement("img"),u.src=`/userFiles/realms/${m.chat.to}/emojis/${d.id}.png`,u.setAttribute("data-name",d.name),u.classList.add("emoji__img")):(u=document.createElement("span"),u.innerHTML=d.skins[0]?.native),u.classList.add("emoji__item"),o.appendChild(u),u.addEventListener("click",Ue.emojiClick)}ne.container.appendChild(i),s.addEventListener("click",()=>{ne.container.scrollTop=i.offsetTop-ne.container.offsetTop-5})}},emojiClick(e){let t="";if(e){let r=e.target,s=r.getAttribute("data-name");if(s){let i=Ue.getEmojiFromName(s);i&&(t=`:${i.id}:`)}else t=r.innerHTML}let n=new CustomEvent("emocji",{detail:t});ne.div.dispatchEvent(n)}};ne.input.addEventListener("input",Ue.renderEmoji);Ue.renderEmoji();wn=Ue;G.emojiFunc=Ue;G.customEmoji=Ce});var xt,et,Jt=b(()=>{T();pt();$e();R();B();oe();F();U();vn();W();ee();Tn();j();g("mess/interact");xt={replyClose(){M.replyClose.style.display="none",m.temp.replyId&&(document.querySelector("#mess__"+m.temp.replyId).style.backgroundColor=""),m.temp.replyId=null},editMessClose(){M.editClose.style.display="none",M.input.value="",m.temp.editId=null,C.focusInp(),P.sendBtnStyle(),P.messageHeight(),P.setSelectionStart()},linkClick(e){e.preventDefault();let t=e.target.getAttribute("href");if(!t)return;/^(https?:\/\/)/i.test(t)||(t="http://"+t);let n=t.split("/");if(n.length<2)return v.uiMsgT(c.ui.message.invalid_link);let r=n[0]+"//<span>"+n[2]+"</span>/"+n.slice(3).join("/"),s=a(()=>{M.linkClick.fadeOut(),M.linkClick.querySelector("#linkClick_yes").removeEventListener("click",i),M.linkClick.querySelector("#linkClick_no").removeEventListener("click",s)},"end"),i=a(()=>{window.open(t,"_blank"),s()},"handleYesClick");M.linkClick.fadeIn(),M.linkClick.querySelector("#linkClick_link").innerHTML=r,M.linkClick.querySelector("#linkClick_yes").addEventListener("click",i),M.linkClick.querySelector("#linkClick_no").addEventListener("click",s)},emocjiPopup(e){ne.div.fadeIn();function t(n){e(n.detail),ne.div.removeEventListener("emocji",t),ne.div.fadeOut(),setTimeout(()=>{C.focusInp(),P.setSelectionStart()},100)}a(t,"evt"),setTimeout(()=>{ne.div.addEventListener("emocji",t),ne.input.value="",wn.renderEmoji();let n=m.chat.to;n=="main"||n.startsWith("$")||p.emit("realm.emojis.sync",n,r=>{Ce.categories=[{id:"Custom",emojis:[...r.map(s=>s.name)]}],Ce.emojis={},r.forEach(s=>{Ce.emojis[s.name]={id:s.emoji,name:s.name,keywords:[s.name],skins:[],html:!0}}),wn.renderEmoji()})},100)},emocji(){xt.emocjiPopup(e=>{xt.handleEmocji(e),setTimeout(()=>{P.setSelectionStart()},100)})},handleEmocji(e){e&&(M.input.value+=e)},search(){M.input.value="/search ",Pr(Xe.system.search);let e=new Event("input");M.input.dispatchEvent(e),Vt.handleCommandInput()},displayPinned(){if(M.div.innerHTML="<h2>"+c.ui.pinned_messages+"</h2>",m.chat.pinned.length==0){M.div.innerHTML+=c.ui.no_pinned_messages;return}m.chat.pinned.forEach(e=>{Me.addMess(e)})},spoiler(e){e.preventDefault(),e.target.clT("spoiler__show")},thread(e,t){if(!e||!t)return;let{_id:n,name:r,author:s}=e;if(t.querySelector("#thread__"+n))return;let i=document.createElement("div");i.classList.add("thread"),i.id="thread__"+n,i.innerHTML=`
            \`- <span class="thread__author">${E.www.changeUserID(s)}</span> |  
            <span class="thread__name">${r}</span>`,i.addEventListener("click",()=>{C.changeChnl("&"+n)}),t.add(i)}};xt.replyClose();et=xt;Q.mess=xt});var Vr,Nr,Wr=b(()=>{T();g("contextMenuLib");Vr={menuShower(e,t){e.style.display="block",n(t);function n(i){window.getSelection().removeAllRanges(),Vr.menuMax(i,e),document.body.addEventListener("click",r)}a(n,"_handleClick");function r(){s(),e.style.display="none"}a(r,"_click");function s(){document.body.removeEventListener("click",r)}a(s,"_removeClick")},menuMax(e,t){let n=e.clientX,r=e.clientY,s=t.clientWidth,i=t.clientHeight;t.style.setProperty("--left",n+10+"px"),t.style.setProperty("--top",r+10+"px"),t.style.setProperty("--right","auto"),t.style.setProperty("--bottom","auto"),n<0&&t.style.setProperty("--left","10px"),r<0&&t.style.setProperty("--top","10px");let o=window.innerWidth,l=window.innerHeight;n+s>o&&(t.style.setProperty("--left","auto"),t.style.setProperty("--right","10px")),r+i>l&&(t.style.setProperty("--top","auto"),t.style.setProperty("--bottom","10px"))}},Nr=Vr});function to(e){let t=e.touches[0];return new MouseEvent(e.type,{clientX:t.clientX,clientY:t.clientY})}function no(e,t){return e.querySelector(`[data-id='${t}']`).style}function xe(e,t,n){no(e,t).display=n?"":"none"}function ro(e){let t=[1,512,32,256,64],n=m.realms.find(r=>r.realm===e)?.p||0;return J.hasAnyPermission(n,t)}var eo,pe,St=b(()=>{T();Wr();qe();re();R();g("components/contextMenu");eo={showMenu(e,t,n){return t.setAttribute("_id",n),Nr.menuShower(t,e)},message(e,t,n){let r=document.querySelector("#message_context_menu");xe(r,"pin",n.pin),xe(r,"unpin",!n.pin),xe(r,"delete",n.delete),xe(r,"edit",n.edit),xe(r,"add_reaction",m.realm.chnlPerms[m.chat.chnl]?.react),xe(r,"create_thread",m.realm.chnlPerms[m.chat.chnl]?.threadCreate),this.showMenu(e,r,t)},realm(e,t){let n=document.querySelector("#realm_context_menu");xe(n,"settings",ro(t)),this.showMenu(e,n,t)},channel(e,t,n){n={type:"text",...n};let r=document.querySelector("#channel_context_menu");xe(r,"subscribe",["announcement","open_announcement"].includes(n.type)),xe(r,"create_thread",m.realm.chnlPerms[m.chat.chnl]?.threadCreate),this.showMenu(e,r,t)},thread(e,t){let n=document.querySelector("#thread_context_menu"),r=m.user._id===t.author||J.isAdmin();xe(n,"delete",r),this.showMenu(e,n,t._id)},menuClickEvent(e,t,n){if(!L.isMobile()){e.addEventListener("contextmenu",l=>{if(!(n&&!n(l.target)))return l.preventDefault(),t(l),!1});return}let r,s;e.addEventListener("mousedown",i),e.addEventListener("touchstart",i),e.addEventListener("mouseup",o),e.addEventListener("touchend",o);function i(l){r=new Date().getTime();let d;l instanceof TouchEvent?d=to(l):d=l,s=setTimeout(()=>{t(d)},1300)}a(i,"startHold");function o(l){if(clearTimeout(s),r=new Date().getTime()-r,!(r<2e3))return l.preventDefault(),!1}a(o,"cancelHold")}};a(to,"convertTouchEventToMouseEvent");a(no,"getByDataIdStyle");a(xe,"setDisplayByDataId");a(ro,"canUserManageRealm");pe=eo});var so,me,tt=b(()=>{T();g("var/staticData");so={baseTitle:"Fusion Chat",messCount:40,uploadImgTypes:["image/png","image/jpeg","image/jpg","image/gif"],contextmenuTags:["img","video","audio","a","input","textarea"]},me=so});function zr(e,t){let n=document.createElement("div");if(n.classList.add("embed"),n.innerHTML=`
        <div style="display: flex;">
            ${e.image?`<div style="width: 35%;">
                <img src="${e.image}" style="width: 90%;" />
            </div>`:""}
            <div ${e.image?'style="width: 65%;"':""}>
                ${e.title?`<h1>${e.title}</h1><br />`:""}
                ${e.description?`<p>${e.description}</p><br />`:""}
                ${e.url?`
                    <b>Link: </b>
                    <a href="${e.url}" onclick="mglInt.mess.linkClick(event)">${e.url}</a>
                `:""}
            </div>
        </div>
    `,e.customFields){n.innerHTML+="<br /><hr>";let r=document.createElement("div");r.classList.add("custom-fields");for(let[s,i]of Object.entries(e.customFields)){let o=document.createElement("div");o.classList.add("custom-field");let l=document.createElement("strong");l.innerText=s+": ",o.appendChild(l);let d=document.createElement("span");d.innerText=i,o.appendChild(d),r.appendChild(o)}n.appendChild(r)}t.appendChild(n)}var Kr=b(()=>{T();g("mess/format/embed");a(zr,"format_embed")});function Ln(e,t){let n=document.querySelector(`#mess__${e}`);if(!n)return;let r=n.querySelector(".mess_content").getAttribute("_plain"),s=document.createElement("div");s.innerHTML=r,s.classList.add("res_msg"),s.addEventListener("click",()=>{n.classList.add("res_msg__animate"),setTimeout(()=>n.classList.remove("res_msg__animate"),3e3)}),t.addUp(s)}var Xr=b(()=>{T();g("mess/format/respone");a(Ln,"format_responeMess")});var It,kn,Yr,Me,pt=b(()=>{T();vn();R();$e();B();Xt();oe();re();F();Ct();Jt();W();ee();St();qe();tt();Kr();Xr();g("mess");It=2e3,kn='<span class="editMessText noneselect" title="edit $$">(edit)</span>',Yr={sendMess(){if(!m.chat.to||!m.chat.chnl||m.chat.to=="main")return;let e=M.input.value.trim();if(e&&!(e.length>It)){if(m.temp.editId)p.emit("message.edit",m.chat.to,m.temp.editId,e),et.editMessClose();else{let t={to:m.chat.to,chnl:m.chat.chnl,msg:e,res:m.temp.replyId};Vt.send(t)==0&&p.emit("mess",t)}M.input.value="",et.replyClose(),C.focusInp(),P.sendBtnStyle(),P.messageHeight()}},addMess(e,t=!0,n=!1){if(!e)return;let r=document.createElement("div");r.classList.add("mess_message"),r.id="mess__"+e._id,e.res&&r.setAttribute("resMsgID",e.res);let s=document.createElement("div");s.classList.add("mess_meta"),s.setAttribute("_author",e.fr);let i=document.createElement("img");i.src="/api/profile/img?id="+e.fr,s.appendChild(i);let o=document.createElement("div");o.classList.add("mess_meta_text");let l=document.createElement("span");l.innerHTML=E.www.changeUserID(e.fr),l.classList.add("mess_author_name"),["%","^","("].includes(e.fr[0])||l.addEventListener("click",()=>{p.emit("user.profile",e.fr)}),o.appendChild(l);let d=document.createElement("span");d.classList.add("mess_time"),d.innerHTML=L.formatDateFormUnix(L.extractTimeFromId(e._id)),o.appendChild(d),s.appendChild(o),r.appendChild(s);let u=document.createElement("div");if(u.classList.add("mess_content"),Qe.formatMess(e.msg,u),u.setAttribute("_plain",e.msg),r.appendChild(u),e.lastEdit){let h=L.formatDateFormUnix(parseInt(e.lastEdit,36)*1e3);u.innerHTML+=kn.replace("$$",h)}if(e.embed&&zr(e.embed,u),e.reacts){let h=document.createElement("div");h.classList.add("mess_reacts");let f=Object.keys(e.reacts);for(let y of f){let _=e.reacts[y],w=document.createElement("span");w.setAttribute("_key",y),w.setAttribute("_users",_.join(",")),w.addEventListener("click",()=>{p.emit("message.react",m.chat.to,e._id,y)}),h.appendChild(w)}P.styleMessReacts(h),r.appendChild(h)}n?M.div.addUp(r):M.div.add(r),setTimeout(()=>{let f=M.div.scrollTop+M.div.clientHeight+r.clientHeight+70>=M.div.scrollHeight;e.res&&Ln(e.res,r),t&&f&&r.scrollIntoView({behavior:"smooth"})},100),pe.menuClickEvent(r,h=>{let f=m.chat.pinned.findIndex(_=>_._id==e._id)!=-1,y=e.fr==m.user._id||J.canAction(2);pe.message(h,e._id,{pin:!f,edit:e.fr==m.user._id,delete:y})},h=>!me.contextmenuTags.includes(h.tagName.toLowerCase())),r.addEventListener("click",()=>{m.chat.selectedMess=e._id})},sendFile(e){if(e)t(e);else{let n=document.createElement("input");n.type="file",n.click(),n.addEventListener("change",r=>{let i=r.target.files?.[0];i?t(i):console.error("No file selected.")})}function t(n){let r={file:n,callback:a(s=>{let i=JSON.parse(s.responseText).path,o=location.origin+i,l={to:m.chat.to,chnl:m.chat.chnl,msg:o};p.emit("mess",l)},"callback"),maxSize:8388608,maxName:60,endpoint:"/api/file/upload"};Ye.read(r)}a(t,"read")}},Me=Yr;G.messFunc=Yr});var Ht,ft,P,$e=b(()=>{T();W();re();R();B();pt();g("mess/style");({input:Ht}=M),ft={sendBtnStyle(){let e=Ht.value.trim().length,t="";e==0?t="grey":e<=It?t="green":e>It&&(t="red"),M.sendBtnImg.style.setProperty("--fil",t),M.sendBtn.disabled=e==0||e>It},messageHeight(){let e=Ht.value.split(`
`).length-1;e=e>=2?Math.min(e,20):0,Ht.style.setProperty("--messHeight",e+"rem")},hideFromMessageInfo(){function e(r){let s=r.id.replace("mess__","");return L.extractTimeFromId(s)}a(e,"getTimeFromMess");let t=20,n=document.querySelectorAll(".mess_message");for(let r=1;r<n.length;r++){let s=n[r],i=n[r-1],o=s.querySelector(".mess_meta").getAttribute("_author"),l=i.querySelector(".mess_meta").getAttribute("_author");if(o!=l)continue;let d=e(s),u=e(i),h=s.querySelector(".mess_meta");h.style.display=d-u<t?"none":""}},colorRole(){let e=document.querySelectorAll(".mess_message"),t=m.realm.roles,n=m.realm.users,r=new Map;e.forEach(s=>{let i=s.querySelector(".mess_meta").getAttribute("_author");if(r.has(i)){ft.colorRoleMess(s,r.get(i));return}let o=n.find(d=>d.uid==i);if(!o||o.roles.length==0)return;let l;for(let d=0;d<t.length;d++)if(o.roles.includes(t[d].name)){l=t[d].c,r.set(i,l),ft.colorRoleMess(s,l);return}ft.colorRoleMess(s,"")})},colorRoleMess(e,t){e.querySelector(".mess_author_name").style.color=t},styleMessReacts(e){e.querySelectorAll("span").forEach(n=>{let r=n.getAttribute("_users").split(",");if(r.length==0||r[0]==""){n.remove();return}n.classList.remove("userReacted"),r.includes(m.user._id)&&n.classList.add("userReacted"),n.title=r.map(s=>E.www.changeUserID(s)).join(", "),n.innerHTML=n.getAttribute("_key")+" "+r.length})},setSelectionStart(e=void 0){e||(e=Ht.value.length),Ht.setSelectionRange(e,e)}};setTimeout(()=>{ft.sendBtnStyle(),ft.messageHeight()},100);P=ft});var nt,Cn=b(()=>{T();g("render/var");nt={chnl_user:!1}});function ve(e,t){let n=document.querySelectorAll(`.userStatusMarker[data-status-id="${e}"]`);n.length!=0&&n.forEach(r=>r.setAttribute("data-status",t||"offline"))}var ht=b(()=>{a(ve,"updateUserProfileMarker")});var oo,Se,Dt=b(()=>{T();re();_e();g("render/utils");oo={sortPrivs(e){let t=[...e];return t.sort((n,r)=>{let s=H.lastMess["$"+n]?.main,i=H.lastMess["$"+r]?.main;return!s||!i?0:L.extractTimeFromId(i.mess)-L.extractTimeFromId(s.mess)}),t},initPopup(e){if(!e)return;if(e.getAttribute("opened")){e.setAttribute("opened","2");return}e.setAttribute("opened","1"),e.fadeIn();let n=a(r=>{e&&(e===r.target||e.contains(r.target))||setTimeout(()=>{if(e.getAttribute("opened")==="2"){e.setAttribute("opened","1");return}e.fadeOut(),document.body.removeEventListener("click",n),setTimeout(()=>{e.removeAttribute("opened")},800)},100)},"closePopup");setTimeout(()=>{document.body.addEventListener("click",n)},100)},createUpdater(e,t){return{_value:t,get(){return this._value},set(n){this._value=n,e(n)}}}},Se=oo});var Zr={};ae(Zr,{default:()=>xn});function Jr(){return X.realmUserProfile.getAttribute("data-id")}var Gr,xn,Sn=b(()=>{B();F();T();j();re();W();ee();R();U();g("interact/realmUser");a(Jr,"getId");Gr={removeRole(e,t){p.emit("realm.user.role.remove",m.chat.to,e,t)},async addRole(){let e=Jr(),t=m.realm.roles,n=L.getHighestRoleIndex(m.realm.users.find(d=>d.uid==m.user._id)?.roles||[],m.realm.roles.map(d=>d.name));if(n===-1)return;let r=m.realm.users.find(d=>d.uid==e)?.roles||[],i=t.map((d,u)=>({name:d.name,i:u})).slice(n).filter(d=>!r.includes(d.name)),o=await v.selectPrompt(c.ui.realm_user_profile.add_role,["",...i.map(d=>d.name)],[""]);if(!o)return;let l=i.find(d=>d.name==o);l&&p.emit("realm.user.role.add",m.chat.to,e,l.i)},async kick(){let e=Jr();await v.confirm(c.settings_realm.kick_user+"? <b>"+E.www.changeUserID(e)+"</b>")&&p.emit("realm.user.kick",m.chat.to,e)}},xn=Gr;Q.realmUserProfile=Gr});var Je,Qr,es,ts=b(()=>{T();R();W();Dt();B();_e();qe();Sn();re();g("components/realmUserProfile");Je=X.realmUserProfile,Qr={renderRoles(e,t=!1){let n=m.realm.users.find(l=>l.uid==e)?.roles||[],r=m.realm.roles,s=new Map;r.forEach(l=>s.set(l.name,l.c));let i=Je.querySelector("[data-id=roles]");i.innerHTML="";let o=-1;if(t){let l=m.realm.users.find(d=>d.uid==m.user._id)?.roles||[];o=L.getHighestRoleIndex(l,m.realm.roles.map(d=>d.name))}n.forEach(l=>{let d=document.createElement("li");if(d.style.color=s.get(l)||"var(--txt)",d.innerHTML=l,i.appendChild(d),!t)return;let u=r.findIndex(f=>f.name==l);if(u===-1||o===-1||u<o||e===m.user._id&&u===o)return;let h=document.createElement("button");h.innerHTML="X",h.clA("btn"),h.addEventListener("click",()=>{xn.removeRole(e,r.findIndex(f=>f.name==l)),d.remove()}),d.prepend(h)})},render(e){Je.querySelector("img").src="/api/profile/img?id="+e.replace("^",""),Je.querySelector("[data-id=name]").innerHTML=E.www.changeUserID(e),Je.setAttribute("data-id",e);let t=H.user_state[e.replace("^","")];Je.querySelector("[data-id=status]").innerHTML=t.status.get()+" | "+t.statusText.get();let n=J.hasPermission(m.realm.permission||0,32);Qr.renderRoles(e,n),Je.querySelector("[data-role=role]").style.display=n?"":"none",Je.querySelector("[data-role=kick]").style.display=e!=m.user._id&&J.hasPermission(m.realm.permission||0,16)?"":"none",Se.initPopup(Je)}},es=Qr});var ns,gt,Gt=b(()=>{T();R();B();re();oe();F();St();W();ht();_e();ts();g("render/realm");ns={realms(e){X.realms__content.innerHTML="",m.realms=e,e.forEach(t=>{let n=t.realm,r=document.createElement("div");r.classList.add("realm"),r.id="realm_chat_"+n,t.img?r.innerHTML=`<img src="/userFiles/realms/${n}.png?time=${Date.now()}" alt="${E.www.changeChat(n)}">`:r.innerHTML=E.www.changeChat(n),X.realms__content.appendChild(r),r.addEventListener("click",()=>{C.changeChat(n)}),pe.menuClickEvent(r,s=>{pe.realm(s,n)})}),C.markSelectedChat()},usersInChat(){D.realm__users.innerHTML="";let e=m.realm.roles,t=m.realm.users,n=new Map;function r(s){if(n.has(s))return n.get(s);let i=t.find(o=>o.uid==s);if(i){if(i.roles.length==0)return"";for(let o=0;o<e.length;o++)if(i.roles.includes(e[o].name)){let l=e[o].c;return n.set(s,l),l}return""}}a(r,"getColor"),t.map(s=>s.uid).forEach(s=>{let i=s[0]=="^",o=document.createElement("div");o.classList.add("realm_user_div"),o.classList.add("userStatusMarker"),o.setAttribute("data-status-id",s),i||o.addEventListener("click",()=>{p.emit("user.profile",s)}),pe.menuClickEvent(o,f=>{es.render(s)});let l=document.createElement("img");l.src="/api/profile/img?id="+s.replace("^",""),o.appendChild(l);let d=document.createElement("div"),u=document.createElement("div");u.innerHTML=E.www.changeUserID(s),u.style.color=r(s),u.classList.add("realm_user_name"),d.appendChild(u);let h=document.createElement("div");h.innerHTML="",h.id="user_status_"+s,h.classList.add("realm_user_status"),d.appendChild(h),o.appendChild(d),D.realm__users.appendChild(o),ns.realmUserStatus(s),ve(s,H.user_state[s]?.status.get())})},realmUserStatus(e){let t=document.querySelector("#user_status_"+L.escape(e));if(!t)return;let n=H.user_state[e];if(!n){ve(e,"offline");return}ve(e,n.status.get()||"offline");let r=n.activity.get();if(!r?.state){t.innerHTML=n.statusText.get()||"";return}t.innerHTML=r.state+" | "+r.name}},gt=ns});var _t,Zt,we,Pt=b(()=>{_e();Gt();ht();Dt();_t=H.user_state,Zt={_initUser(e){if(!_t[e]){let t=a(()=>Zt._updateUI(e),"cb");_t[e]={status:Se.createUpdater(t,"offline"),statusText:Se.createUpdater(t,""),activity:Se.createUpdater(t,null)},Zt._updateUI(e)}},_updateUI(e){gt.realmUserStatus(e),ve(e,_t[e].status.get())},set(e,t){let{status:n,statusText:r,activity:s}=t;Zt._initUser(e),n&&_t[e].status.set(n),r&&_t[e].statusText.set(r),s&&_t[e].activity.set(s)}},we=Zt});function ss(){return new Promise((e,t)=>{let n=indexedDB.open("socket",1);n.onupgradeneeded=()=>{let r=n.result;r.objectStoreNames.contains("general")||r.createObjectStore("general",{keyPath:"id"})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}function ao(e){return new Promise(async(t,n)=>{let r=await ss(),o=r.transaction("general","readwrite").objectStore("general").put(e);o.onsuccess=()=>{r.close(),t()},o.onerror=()=>n(o.error)})}function co(e){return new Promise(async(t,n)=>{let r=await ss(),o=r.transaction("general","readonly").objectStore("general").get(e);o.onsuccess=()=>{r.close(),t(o.result)},o.onerror=()=>n(o.error)})}var In,rs,is=b(()=>{F();T();g("cacheControllers/socketGeneral");In=class{static{a(this,"SocketController")}evtName;cb;constructor(t,n){p.on(t,n),this.evtName=t,this.cb=n}async sendToSocket(t,n,...r){let s=typeof r[r.length-1]=="function"?r.pop():null;p.emit(this.evtName,...r,async(...i)=>{await ao({id:t,data:[...i]}),s?s(...i):this.cb(...i),n()})}async emitId(t="",...n){return new Promise(async r=>{let s=this.evtName+(t?"-"+t:"");if(p.connected)await this.sendToSocket(s,r,...n);else{let i=await co(s),o=typeof n[n.length-1]=="function"?n.pop():null;i?(o?o(...i.data):this.cb(...i.data),r()):await this.sendToSocket(s,r,...n)}})}async emit(...t){await this.emitId("",...t)}async emitDataId(t,...n){await this.emitId(t,t,...n)}},rs=In;a(ss,"openDB");a(ao,"saveToDB");a(co,"getFromDB")});var as={};ae(as,{default:()=>Hn});var os,Hn,Dn=b(()=>{T();U();F();vt();W();ee();j();R();g("interact/mainView");os={showNav(){$.nav.clientHeight==0?$.nav.fadeIn():$.nav.fadeOut()},async addFriend(e){e||(e=await v.prompt(c.ui.enter_friend)),e&&p.emit("friend.request",e)},changeView(e){Ie.changeView(e)},requestFriendResponse(e,t){if(!e)return;let n=$.div.querySelector(`.main__view__friend[data-status-id="${e}"]`);n&&(p.emit("friend.response",e,t),n.remove(),m.mainView.requests=m.mainView.requests.filter(r=>r!=e),$.requestCount.innerHTML=`(${m.mainView.requests.length})`,t&&p.emit("friend.get.all"))}},Hn=os;Q.mainView=os});var cs=b(()=>{});var mo,rt,Qt=b(()=>{T();R();B();Dt();oe();F();vt();Dn();W();cs();re();j();ht();Pt();g("render/user");mo={localUserProfile(){D.user__name.innerHTML=E.www.changeUserID(m.user._id),D.user__status.innerHTML=m.user.statusText||m.user.status||"Online",ve(m.user._id,m.user.status||"online")},userProfile(e){if(!e)return;let t=e._id==m.user._id,n="/api/profile/img?id="+e._id;if(X.userProfile.innerHTML=`
            <div id="userProfileInfo" class="userStatusMarker">
                <img src="${n}" onclick="mglInt.createMediaPopup('${n}')" alt="User logo">
                <div>
                    <h1>${e.name}</h1>
                    <p>${e.status}${e.statusText?" | "+e.statusText:""}</p>
                    <div id="userProfileBtns" style="margin-top: 10px;"></div>
                </div>
            </div>
            <div id="userProfileActivity"></div>
            <div id="userProfileAbout"></div>
        `.trim(),(e.statusText||e.status)&&we.set(e._id,{status:e.status,statusText:e.statusText}),X.userProfile.querySelector("#userProfileInfo").setAttribute("data-status-id",e._id),!t){let s=document.createElement("button");s.classList.add("btn");let i;switch(e.friendStatus){case 0:i=c.ui.friend.add,s.onclick=()=>Hn.addFriend(e._id);break;case 1:i=c.ui.friend.remove,s.onclick=()=>Ie.removeFriend(e._id);break;case 2:i=c.ui.friend.request_sent,s.onclick=()=>Ie.removeFriendRequest(e._id);break;case 3:i=c.ui.friend.request_received,s.onclick=()=>{C.changeChat("main"),Ie.changeView("requests")};break}s.innerHTML=i;let o=X.userProfile.querySelector("#userProfileBtns");o.appendChild(s);let l=document.createElement("button");l.classList.add("btn"),l.style.marginLeft="10px",l.innerHTML=e.isBlocked?c.ui.friend.unblock:c.ui.friend.block,l.onclick=()=>{e.isBlocked=!e.isBlocked,p.emit("dm.block",e._id,e.isBlocked)},o.appendChild(l);let d=document.createElement("button");d.classList.add("btn"),d.style.marginLeft="10px",d.innerHTML=c.ui.friend.open_dm,d.onclick=()=>{C.changeChat("$"+e._id)},o.appendChild(d)}let r=X.userProfile.querySelector("#userProfileActivity");if(e.activity?.state){let s=e.activity;if(r.innerHTML=`
                <h2>Activity</h2>
                <p>${s.state} | ${s.name}</p>
                ${s.details?"<p>"+s.details+"</p>":""}
                ${s.startTime?'<p>Time: <span id="userProfileActivityTime"></span></p>':""}
                ${s.party?"<p>Party: "+s.party.id+" | "+s.party.state+(s.party.max?" / "+s.party.max:"")+"</p>":""}
            `.trim(),we.set(e._id,{activity:L.rmRef(s)}),s.startTime){let o=function(){let d=new Date().getTime()-new Date(s.startTime).getTime(),u=Math.floor(d/1e3/60/60),h=Math.floor(d/1e3/60)-u*60,f=Math.floor(d/1e3)-u*60*60-h*60;i.innerHTML=`${u}:${h}:${f}`};a(o,"update");let i=r.querySelector("#userProfileActivityTime"),l=setInterval(()=>{if(!i)return clearInterval(l);o()},1e3);o()}}Se.initPopup(X.userProfile),we.set(e._id,e)}},rt=mo});var ls={};ae(ls,{default:()=>At});var N,st,At,en=b(()=>{T();W();ee();F();B();U();R();j();ie();g("components/voice");N={local_stream:null,muteMic:!1,sending:!1,joined:!1},st={async initCall(){try{if(ge.voiceShow.style.display="",N.local_stream)return;let e=await this.getStream(!0,!1);N.local_stream=e,ge.div.fadeIn()}catch(e){console.error("initCall",`Error joining voice channel: ${e.message}`)}},async joinToVoiceChannel(e){await this.initCall(),N.joined=e,p.emit("voice.join",e),p.emit("voice.get.users"),ge.muteMic.innerHTML=N.muteMic?c.ui.mute.unmute:c.ui.mute.mute},send(){if(N.sending)return;let e=[],t=new MediaRecorder(N.local_stream,{mimeType:"video/webm; codecs=vp8,opus"});t.ondataavailable=n=>{n.data.size!=0&&e.push(n.data)},t.onstop=()=>{if(e.length==0)return x.msg(2,"no voice data");p.volatile.emit("voice.sendData",e),e=[]},N.sending=setInterval(()=>{t.stop(),setTimeout(()=>{N.sending&&t.start()},10)},100),t.start(100)},endCall(){typeof N.sending=="number"&&clearInterval(N.sending),N.sending=!1,N.joined=!1,p.emit("voice.leave"),ge.div.fadeOut(),ge.mediaContainer.innerHTML="",ge.voiceShow.style.display="none",E.app.apiType=="rn"?E.api.send({type:"stopAudio"}):(N.local_stream.getTracks().forEach(e=>{e.stop()}),N.local_stream=null)},async startCall(){let e=m.chat.to.replace("$","");e=="main"||!await v.confirm(O(c.ui.confirm.call_to,E.www.changeUserID(e))+"?")||p.emit("call.dm.init",e)},toggleMute(){N.muteMic=!N.muteMic,E.app.apiType=="rn"?E.api.send({type:N.muteMic?"stopAudio":"startAudio"}):N.local_stream.getAudioTracks().forEach(t=>{t.enabled=!N.muteMic}),ge.muteMic.innerHTML=N.muteMic?c.ui.mute.unmute:c.ui.mute.mute},async getStream(e=!0,t=!1){if(E.app.apiType==="rn")return await window.processMediaRN.getStream();let n=new MediaStream;async function r(i){if(navigator.mediaDevices?.getUserMedia)return await navigator.mediaDevices.getUserMedia(i);if("webkitGetUserMedia"in navigator){let o=navigator.webkitGetUserMedia.bind(navigator);return new Promise((l,d)=>{o(i,l,d)})}else if("mozGetUserMedia"in navigator){let o=navigator.mozGetUserMedia.bind(navigator);return new Promise((l,d)=>{o(i,l,d)})}}a(r,"getUserMedia");async function s(i,o){if(i.length===0){v.uiMsgT("No devices found");return}let l=i.map(h=>h.label||"Unknown Device"),d=i.map(h=>h.deviceId),u=await v.selectPrompt(o,l,d);return d[u]}a(s,"selectDevice");try{let i=await r({audio:e,video:t});if(!i)return v.uiMsgT("Error getting temporary stream"),n;setTimeout(()=>{i.getTracks().forEach(y=>y.stop())},200);let o=await navigator.mediaDevices.enumerateDevices(),l=o.filter(y=>y.kind==="audioinput"),d=o.filter(y=>y.kind==="videoinput"),u=e?{deviceId:await s(l,c.ui.call.select_audio_device)}:!1,h=t?{deviceId:await s(d,c.ui.call.select_video_device)}:!1,f=await r({audio:u,video:h});return f&&f.getTracks().forEach(y=>n.addTrack(y)),n}catch(i){return console.error(`Error getting stream: ${i.message}`),v.uiMsgT("An error occurred while getting the stream"),n}},isInUserCall(e){return"user_"+[e,m.user._id].sort().join("=")==N.joined}};p.on("voice.sendData",(e,t)=>{let n=new Blob(t,{type:"audio/webm; codecs=vp8,opus"}),r=URL.createObjectURL(n);new Audio(r).play().catch(()=>{})});p.on("connect",()=>{N.joined&&(x.msg(1,"reconnected to voice channel"),st.joinToVoiceChannel(N.joined))});p.on("voice.get.users",e=>{ge.users.innerHTML="",e.forEach(t=>{let n=document.createElement("li");n.innerHTML=E.www.changeUserID(t),ge.users.appendChild(n)}),e.length>1?st.send():e.length==1&&(typeof N.sending=="number"&&clearInterval(N.sending),N.sending=!1)});p.on("call.dm.init",(e,t=!1)=>{if(t){if(v.uiMsgT(c.ui.call.offline,E.www.changeUserID(e)),!confirm(c.ui.call.wait+"?"))return}else{if(st.isInUserCall(e))return p.emit("call.dm.answer",e,!0);let r=confirm(O(c.ui.call.called,E.www.changeUserID(e))+"?");if(p.emit("call.dm.answer",e,r),!r)return}let n="user_"+[e,m.user._id].sort().join("=");st.joinToVoiceChannel(n)});p.on("call.dm.answer",(e,t)=>{if(!t)return alert(c.ui.call.rejected);if(!confirm(O(c.ui.call.answer,E.www.changeUserID(e))+"?"))return;let r="user_"+[e,m.user._id].sort().join("=");st.joinToVoiceChannel(r)});p.on("voice.leave",e=>{v.uiMsgT(c.ui.call.left,E.www.changeUserID(e))});p.on("voice.join",e=>{v.uiMsgT(c.ui.call.joined,E.www.changeUserID(e))});At=st;G.voiceFunc=st});var Ft,yt,nn=b(()=>{T();R();B();ee();en();j();F();qe();Xt();W();Pn();U();g("render/event");Ft={show(){m.chat.to=="main"||m.chat.to.startsWith("$")||p.emit("realm.event.list",m.chat.to,!1,e=>{X.events__container.innerHTML="",X.events__add.style.display=J.isAdmin()?"":"none",e.forEach(Ft.renderEvent),X.events.fadeIn(),D.realm__panel.querySelector("#navs__realm__events").setAttribute("data-count",e.length.toString())})},renderEvent(e){let{type:t,where:n,topic:r,time:s,desc:i,img:o,_id:l,author:d}=e,u=s*1e3,h=new Date(u).getTime(),f=document.createElement("div");f.clA("realm_event"),f.innerHTML+=`
            <img src="${o||"/favicon.svg"}" />
            <div class="realm_event__info">
                <h2>${r}</h2>
                ${i?'<div data-id="eventDesc"></div>':""}
                <p>${c.ui.author}: ${E.www.changeUserID(d)}</p>
                <p>${new Date(u).toLocaleString()} (<span data-id="cutdown"></span>)</p>
            </div>
            <div class="realm_event__users">
                <button data-id="users-join" class="btn">${c.uni.join}</button>
                <div>
                    <p>
                        ${c.ui.users}:
                        <span data-id="users-count"></span>
                        <button data-id="users-show" class="btn">${c.uni.show}</button>
                    </p>
                    <br />
                    <div data-id="users" style="display: none;" class="realm_event__users__list"></div>
                </div>
            </div>
        `;let y=f.querySelector(".realm_event__info");if(i){let K=f.querySelector("[data-id='eventDesc']");Qe.formatMess(i,K)}if(J.isAdmin()){let K=document.createElement("button");K.innerHTML=c.uni.delete,K.clA("btn"),K.addEventListener("click",async()=>{await v.confirm(c.ui.confirm.sure+"?")&&(p.emit("realm.event.delete",m.chat.to,l),setTimeout(()=>{Ft.show()},100))});let q=document.createElement("div");q.clA("realm_event__delete"),q.appendChild(K),f.appendChild(q)}function _(K){return K<10?"0"+K:K}a(_,"addZero");let w=f.querySelector("[data-id='cutdown']"),I,Z=a(()=>{let K=new Date().getTime(),q=h-K;if(q<=0){if(w.textContent="0h 0m 0s",t=="custom"){let z=document.createElement("div");Qe.formatMess(n,z),y.appendChild(z)}else if(t=="voice"){let z=document.createElement("button");z.innerHTML=c.ui.call.call,z.clA("btn"),z.style.marginTop="5px",z.addEventListener("click",()=>{At.joinToVoiceChannel(n)}),y.appendChild(z)}clearInterval(I)}else{let z=Math.floor(q/36e5),se=Math.floor(q%(1e3*60*60)/(1e3*60)),le=Math.floor(q%(1e3*60)/1e3);w.textContent=`${_(z)}h ${_(se)}m ${_(le)}s`}},"updateCutdown");new Date().getTime()<h&&(I=setInterval(Z,1e3)),Z();let he=f.querySelector("[data-id='users-join']"),ze=e.users.includes(m.user._id);he.textContent=ze?c.uni.leave:c.uni.join,he.addEventListener("click",()=>{ze?(p.emit("realm.event.leave",m.chat.to,l),ze=!1,he.textContent=c.uni.join,e.users=e.users.filter(K=>K!=m.user._id)):(p.emit("realm.event.join",m.chat.to,l),ze=!0,he.textContent=c.uni.leave,e.users.push(m.user._id)),Lt()});let Ze=f.querySelector("[data-id='users-count']"),je=f.querySelector("[data-id='users-show']"),Te=f.querySelector("[data-id='users']");je.addEventListener("click",()=>{Te.style.display!="none"?(Te.style.display="none",je.innerHTML=c.uni.show):(Te.style.display="",je.innerHTML=c.uni.hide)});function Lt(){Te.innerHTML="",Ze.textContent=e.users.length.toString();for(let K of e.users){let q=document.createElement("div");q.textContent=E.www.changeUserID(K),q.style.cursor="pointer",q.addEventListener("click",()=>{p.emit("user.profile",K)}),Te.appendChild(q)}}a(Lt,"renderJoinedUsers"),Lt(),X.events__container.appendChild(f)},exit(){X.events.fadeOut(()=>{X.events__container.innerHTML=""})},async create(){if(m.chat.to=="main"||m.chat.to.startsWith("$")||!J.isAdmin())return;let e=X.events__container;e.innerHTML="";function t(_,w){let I=document.createElement("label");I.textContent=_,I.htmlFor=w,I.style.marginRight="1rem",e.appendChild(I),e.appendChild(document.createElement("br"))}a(t,"createLabel");function n(){e.appendChild(document.createElement("br")),e.appendChild(document.createElement("br"))}a(n,"br"),t(c.ui.event.topic,"event-topic");let r=document.createElement("input");r.type="text",r.placeholder=c.ui.event.topic,r.id="event-topic",e.appendChild(r),n(),t(c.ui.event.time,"event-time");let s=document.createElement("input");s.type="datetime-local",s.id="event-time",e.appendChild(s),n(),t(c.ui.event.desc,"event-desc");let i=document.createElement("input");i.type="text",i.placeholder=c.ui.event.desc,i.id="event-desc",e.appendChild(i),n(),t(c.ui.event.type,"event-type");let o=document.createElement("select");o.id="event-type",[{name:c.ui.event.type_custom,type:"custom"},{name:c.ui.event.type_voice,type:"voice"}].forEach(_=>{let w=document.createElement("option");w.value=_.type,w.textContent=_.name,o.appendChild(w)}),o.addEventListener("change",u),e.appendChild(o),n(),t(c.ui.event.where,"event-where");let l=document.createElement("div");e.appendChild(l),n();let d=document.createElement("select");d.id="event-where",h();function u(){if(l.innerHTML="",o.value=="custom"){let _=document.createElement("input");_.type="text",_.placeholder=c.ui.event.where,_.id="event-where",l.appendChild(_)}else o.value=="voice"&&l.appendChild(d)}a(u,"whereRender");function h(){D.realm__channels.querySelectorAll(".channel_voice:not(details .channel_voice)").forEach(_=>{let w=_.id.replace("channel_",""),I=_.textContent.replace(tn("voice")+" | ",""),Z=document.createElement("option");Z.value=w,Z.textContent=I,d.appendChild(Z)}),D.realm__channels.querySelectorAll("details").forEach(_=>{let w=_.querySelector("summary").textContent,I=document.createElement("optgroup");I.label=w,d.appendChild(I),_.querySelectorAll(".channel_voice").forEach(Z=>{let he=Z.id.replace("channel_",""),ze=Z.textContent.replace(tn("voice")+" | ",""),Ze=document.createElement("option");Ze.value=he,Ze.textContent=ze,I.appendChild(Ze)})})}a(h,"renderWhereOptions"),u(),t(c.ui.event.img,"event-img");let f=document.createElement("input");f.type="text",f.placeholder=c.ui.event.img,f.id="event-img",e.appendChild(f),n();let y=document.createElement("button");y.textContent=c.uni.add,y.clA("btn"),y.addEventListener("click",()=>{let _={topic:r.value,time:Math.floor(new Date(s.value).getTime()/1e3),desc:i.value,type:o.value,where:l.querySelector("select, input").value,img:f.value};p.emit("realm.event.create",m.chat.to,_),setTimeout(()=>{Ft.show()},100)}),e.appendChild(y),n()}},yt=Ft;Q.realmEvents=Ft});function uo(e=0){m.realm={users:[],roles:[],permission:e,text:[],desc:{},chnlPerms:{},threads:[]}}function po(e,t){D.realm__name.innerHTML="";let n=document.createElement("div");n.innerHTML=e,n.title=e,n.id="navs__realm__name__text",D.realm__name.appendChild(n),fo(),go(t)}function fo(){let e=document.createElement("span");e.innerHTML="\u{1F465}",e.classList.add("realm_nav_btn"),e.addEventListener("click",ho),D.realm__name.appendChild(e)}function ho(){nt.chnl_user=!nt.chnl_user,D.realm__channels.style.display=nt.chnl_user?"none":"",D.realm__users.style.display=nt.chnl_user?"":"none"}function go(e){let t=document.createElement("span");t.classList.add("realm_nav_btn"),t.innerHTML="\u2B07\uFE0F",t.addEventListener("click",n=>{setTimeout(()=>{pe.realm(n,e)},20)}),D.realm__name.appendChild(t)}function _o(e,t,n){let{name:r,type:s,desc:i,id:o}=e,l=document.createElement("div");l.onclick=()=>vo(s,o,n),l.id="channel_"+o,l.classList.add("channel_"+s),pe.menuClickEvent(l,u=>{pe.channel(u,o,{type:s})});let d=tn(s);l.innerHTML=`${d} | ${r}`,t.appendChild(l),m.realm.desc[o]=i}function tn(e){switch(e){case"text":return"\u{1F4DD}";case"voice":return"\u{1F3A4}";case"announcement":return"\u{1F4E3}";case"open_announcement":return"\u{1F4E3}";case"forum":return"\u{1F4DC}";default:console.error(e)}}function vo(e,t,n){e==="text"||e==="announcement"||e==="open_announcement"?C.changeChnl(t):e==="voice"?yo(t,n):e==="forum"&&C.changeToForum(t)}function yo(e,t){let n=m.realm.chnlPerms[e];if(!n||!n.write){v.uiMsgT(c.ui.channel.no_permission,["!"]);return}At.joinToVoiceChannel(t+"="+e)}function bo(e,t,n){let r=document.createElement("details");r.open=!0;let s=document.createElement("summary");s.innerHTML=e.name,r.appendChild(s),e.chnls.forEach(i=>{_o(i,r,n),m.realm.chnlPerms[i.id]=i.perms}),t.appendChild(r)}function Eo(e){for(let t of e){let n=t.chnls.find(r=>r.type==="text");if(n)return n.id}return null}function Mo(){let e=D.realm__panel;e.innerHTML="",wo(e)}function wo(e){let t=document.createElement("button");t.innerHTML="\u{1FA87}",t.title="Events",t.id="navs__realm__events",t.clA("btn"),t.addEventListener("click",yt.show),e.appendChild(t),p.emit("realm.event.list",m.chat.to,!0,n=>{t.setAttribute("data-count",n.toString())})}function To(e,t,n,r){if(uo(r),po(t,e),D.realm__channels.innerHTML="",n.length===0||n.every(s=>s.chnls.length===0)){D.realm__channels.innerHTML="No channels in this realm",m.chat.chnl=null;return}n.forEach(s=>bo(s,D.realm__channels,e)),Mo(),m.chat.chnl===null&&(m.chat.chnl=Eo(n)),C.changeChnl(m.chat.chnl),fe["realm.thread.list"].emitId(e+"=null",e,null)}var ms,Pn=b(()=>{T();R();Cn();U();oe();en();W();St();j();F();nn();bt();g("render/realmInit");a(uo,"initRealmState");a(po,"createRealmNameSection");a(fo,"addUsersDisplayButton");a(ho,"toggleUserDisplay");a(go,"addMenuButton");a(_o,"createChannel");a(tn,"getChannelTypeEmoticon");a(vo,"handleChannelClick");a(yo,"handleVoiceChannelJoin");a(bo,"createCategory");a(Eo,"findFirstTextChannel");a(Mo,"downPanel");a(wo,"downPanel_events");a(To,"realmInit");ms=To});var rn,Oe,Rt=b(()=>{T();W();R();oe();Dt();re();B();F();ht();_e();g("render/dm");rn={chats(){D.priv.innerHTML="",Se.sortPrivs(m.privs).forEach(e=>{let t=document.createElement("button");t.classList.add("priv_chat"),t.classList.add("btn"),t.classList.add("userStatusMarker"),t.id="priv_chat_"+e,t.setAttribute("data-status-id",e);let n=document.createElement("div"),r=document.createElement("img");r.src="/api/profile/img?id="+e,n.appendChild(r),n.innerHTML+=E.www.changeUserID(e),t.appendChild(n),D.priv.appendChild(t),t.addEventListener("click",()=>{C.changeChat("$"+e),setTimeout(()=>{rn.privsRead()},100)}),t.addEventListener("contextmenu",s=>{s.preventDefault(),p.emit("user.profile",e)}),ve(e,H.user_state[e]?.status.get())}),rn.privsRead(),C.markSelectedChat()},privsRead(){m.privs.forEach(e=>{let t=document.querySelector("#priv_chat_"+e)?.classList;if(!t)return;let n=H.lastMess["$"+e]?.main;if(!n)return;let r=!1;n.read!=null&&n.mess!=null?r=L.extractTimeFromId(n.read)<L.extractTimeFromId(n.mess):n.read==null&&n.mess!=null&&(r=!0),r?t.add("unreadPriv"):t.remove("unreadPriv")})},dm_get(e,t){e.forEach(n=>{let r="$"+n.priv;H.lastMess[r]=H.lastMess[r]||{},H.lastMess[r].main={read:n.last?.main??null,mess:n.lastMessId??null}}),m.privs=e.map(n=>n.priv),rn.chats(),m.blocked=t,m.chat.to.startsWith("$")&&C.dmPlaceholder(m.chat.to.substring(1))}},Oe=rn});function Lo(){return ds||(ds=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ko(){return us||(us=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}function Co(e){let t=new Promise((n,r)=>{let s=a(()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},"unlisten"),i=a(()=>{n(it(e.result)),s()},"success"),o=a(()=>{r(e.error),s()},"error");e.addEventListener("success",i),e.addEventListener("error",o)});return sn.set(t,e),t}function xo(e){if(jn.has(e))return;let t=new Promise((n,r)=>{let s=a(()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},"unlisten"),i=a(()=>{n(),s()},"complete"),o=a(()=>{r(e.error||new DOMException("AbortError","AbortError")),s()},"error");e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});jn.set(e,t)}function gs(e){qn=e(qn)}function So(e){return ko().includes(e)?function(...t){return e.apply($n(this),t),it(this.request)}:function(...t){return it(e.apply($n(this),t))}}function Io(e){return typeof e=="function"?So(e):(e instanceof IDBTransaction&&xo(e),Rn(e,Lo())?new Proxy(e,qn):e)}function it(e){if(e instanceof IDBRequest)return Co(e);if(An.has(e))return An.get(e);let t=Io(e);return t!==e&&(An.set(e,t),sn.set(t,e)),t}function _s(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){let o=indexedDB.open(e,t),l=it(o);return r&&o.addEventListener("upgradeneeded",d=>{r(it(o.result),d.oldVersion,d.newVersion,it(o.transaction),d)}),n&&o.addEventListener("blocked",d=>n(d.oldVersion,d.newVersion,d)),l.then(d=>{i&&d.addEventListener("close",()=>i()),s&&d.addEventListener("versionchange",u=>s(u.oldVersion,u.newVersion,u))}).catch(()=>{}),l}function ps(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(Fn.get(t))return Fn.get(t);let n=t.replace(/FromIndex$/,""),r=t!==n,s=Do.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Ho.includes(n)))return;let i=a(async function(o,...l){let d=this.transaction(o,s?"readwrite":"readonly"),u=d.store;return r&&(u=u.index(l.shift())),(await Promise.all([u[n](...l),s&&d.done]))[0]},"method");return Fn.set(t,i),i}async function*Fo(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;let n=new Proxy(t,Ao);for(vs.set(n,t),sn.set(n,$n(t));t;)yield n,t=await(Un.get(n)||t.continue()),Un.delete(n)}function hs(e,t){return t===Symbol.asyncIterator&&Rn(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&Rn(e,[IDBIndex,IDBObjectStore])}var Rn,ds,us,jn,An,sn,qn,$n,Ho,Do,Fn,Po,fs,Un,vs,Ao,ys=b(()=>{Rn=a((e,t)=>t.some(n=>e instanceof n),"instanceOfAny");a(Lo,"getIdbProxyableTypes");a(ko,"getCursorAdvanceMethods");jn=new WeakMap,An=new WeakMap,sn=new WeakMap;a(Co,"promisifyRequest");a(xo,"cacheDonePromiseForTransaction");qn={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return jn.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return it(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};a(gs,"replaceTraps");a(So,"wrapFunction");a(Io,"transformCachableValue");a(it,"wrap");$n=a(e=>sn.get(e),"unwrap");a(_s,"openDB");Ho=["get","getKey","getAll","getAllKeys","count"],Do=["put","add","delete","clear"],Fn=new Map;a(ps,"getMethod");gs(e=>({...e,get:a((t,n,r)=>ps(t,n)||e.get(t,n,r),"get"),has:a((t,n)=>!!ps(t,n)||e.has(t,n),"has")}));Po=["continue","continuePrimaryKey","advance"],fs={},Un=new WeakMap,vs=new WeakMap,Ao={get(e,t){if(!Po.includes(t))return e[t];let n=fs[t];return n||(n=fs[t]=function(...r){Un.set(this,vs.get(this)[t](...r))}),n}};a(Fo,"iterate");a(hs,"isIteratorProp");gs(e=>({...e,get(t,n,r){return hs(t,n)?Fo:e.get(t,n,r)},has(t,n){return hs(t,n)||e.has(t,n)}}))});async function Bn(e){if(!e&&On)return On;let t=Date.now(),n=await _s(Ro,t,{upgrade(r){e&&e(r)}});return On=n,n}async function Et(e){let t=await Bn();return t.objectStoreNames.contains(e)||(t.close(),t=await Bn(n=>{n.createObjectStore(e,{keyPath:"_id"}).createIndex("chnl","chnl",{unique:!1})})),t}function jo(e){return e.sort((t,n)=>{let r=t._id,s=n._id,i=L.extractTimeFromId(r),o=L.extractTimeFromId(s);if(i!==o)return o-i;let l=r.split("-").slice(1).join("-"),d=s.split("-").slice(1).join("-");return l.localeCompare(d)})}async function bs(e,t,n){let r=e.transaction(t,"readwrite"),s=r.objectStore(t),o=await s.index("chnl").getAll(n);if(o.length<=150)return;o.sort((d,u)=>L.extractTimeFromId(u._id)-L.extractTimeFromId(d._id));let l=o.length-150;for(let d=0;d<l;d++)await s.delete(o[d]._id);await r.done}var Ro,On,Vn,qo,Be,on=b(()=>{re();R();jt();ys();Ro="messages",On=null;a(Bn,"getDB");a(Et,"createCollection");a(jo,"sortMessagesById");Vn=class{static{a(this,"MessageCacheController")}constructor(){Bn()}async addMessage(t,n,r){let s={...r,chnl:n},i=await Et(t);await i.put(t,s),await bs(i,t,n)}async addMessages(t,n,r){if(r.length===0)return;let s=await Et(t),i=s.transaction(t,"readwrite"),o=i.objectStore(t);for(let l of r){let d={...l,chnl:n};o.put(d)}await i.done,await bs(s,t,n)}async getMessagesRaw(t,n){let l=await(await Et(t)).transaction(t,"readonly").objectStore(t).index("chnl").getAll(n);return jo(l)}async getMessages(){let{to:t,chnl:n}=m.chat,r=await this.getMessagesRaw(t,n);m.chat.actMess=r.length,r.reverse(),an(r)}async deleteMessage(t,n){await(await Et(t)).transaction(t,"readwrite").objectStore(t).delete(n)}async deleteMessages(t,n){let s=(await Et(t)).transaction(t,"readwrite"),i=s.objectStore(t);for(let o of n)i.delete(o);await s.done}async editMessage(t,n,r,s){let o=(await Et(s)).transaction(s,"readwrite"),l=o.objectStore(s),d=await l.get(t);if(!d)return;let u={...d,msg:n,lastEdit:r};await l.put(u),await o.done}};a(bs,"enforceChannelCacheLimit");qo=new Vn,Be=qo});function Ms(e){H.lastMess[e.to]=H.lastMess[e.to]||{},H.lastMess[e.to][e.chnl]=H.lastMess[e.to][e.chnl]||{read:null,mess:null},H.lastMess[e.to][e.chnl].mess=e._id,Be.addMessage(e.to,e.chnl,Es(e));let t=e.to.startsWith("$"),n=m.chat.to.startsWith("$"),r=e.fr===m.user._id;if(t&&!n&&!r){let s=O(c.ui.new_message,E.www.changeUserID(e.fr));v.uiMsg(s),m.settings.notifications&&m.user.status!=="dnd"&&L.sendNotification(s,e.msg,{msg:e})}t&&Oe.chats(),!(m.chat.to!==e.to||m.chat.chnl!==e.chnl)&&(H.lastMess[e.to][e.chnl].read=e._id,t&&Oe.privsRead(),Me.addMess(Es(e)),P.hideFromMessageInfo(),P.colorRole(),setTimeout(()=>{H.lastMess[e.to][e.chnl].mess===e._id&&p.emit("message.mark.read",e.to,e.chnl,e._id)},1e3))}function Es(e){let t={_id:e._id,fr:e.fr,msg:e.msg};return e.embed&&(t.embed=e.embed),e.res&&(t.res=e.res),t}function an(e){try{e.forEach(t=>{try{Me.addMess(t,!1,!0)}catch(n){console.error(n),console.error(t);let r=document.createElement("div");r.innerHTML=`<span style="color: red;">${c.ui.failed_to_load_message}!</span>`,M.div.add(r)}}),P.hideFromMessageInfo(),setTimeout(C.scrollToBottom,30)}catch(t){console.error(t);let n=document.createElement("div");n.innerHTML=`<span style="color: red;">${c.ui.failed_to_load_messages}! :(</span>`,M.div.add(n)}P.colorRole()}function ws(e,t){document.querySelector("#mess__"+e)?.remove(),P.hideFromMessageInfo(),Be.deleteMessage(t,e)}function Ts(e,t){e.forEach(n=>{document.querySelector("#mess__"+n)?.remove()}),P.hideFromMessageInfo(),Be.deleteMessages(t,e)}function Ls(e,t,n,r){let s=document.querySelector("#mess__"+e+" .mess_content");if(!s)return;s.setAttribute("_plain",t),Qe.formatMess(t,s),s.innerHTML+=kn.replace("$$",L.formatDateFormUnix(parseInt(n,36)*1e3)),document.querySelectorAll(`[resMsgID=${e}] .res_msg`).forEach(o=>{o.innerHTML=t}),P.hideFromMessageInfo(),Be.editMessage(e,t,n,r)}function ks(e,t,n,r){if(m.chat.to!=t)return;let s=document.querySelector("#mess__"+n);if(!s)return;let i=s.querySelector(`span[_key="${r}"]`);if(!i){let l=document.createElement("span");l.setAttribute("_key",r),l.setAttribute("_users",e),l.innerHTML=r+" 1",l.title=E.www.changeUserID(e),l.addEventListener("click",()=>{p.emit("message.react",t,n,r)}),s.querySelector(".mess_reacts").appendChild(l),P.styleMessReacts(s.querySelector(".mess_reacts"));return}let o=i.getAttribute("_users").split(",");o.includes(e)?o=o.filter(l=>l!=e):o.push(e),i.setAttribute("_users",o.join(",")),P.styleMessReacts(s.querySelector(".mess_reacts"))}function Cs(e){if(e.length==0){M.div.innerHTML+=c.ui.message.search_no_results;return}M.div.innerHTML="<h2>"+c.ui.message.search_results+":</h2>",e.forEach(t=>{Me.addMess(t,!1)})}function xs(e){m.chat.pinned=e}function cn(e){m.realm.threads=[...new Set([...m.realm.threads,...e])],e.forEach(t=>{let n=document.querySelector("#channel_"+t.thread);if(!n)return;if(!document.querySelector("#channel_\\&"+t._id)){let s=document.createElement("div");s.classList.add("channel_text"),s.id="channel_&"+t._id,s.style.paddingLeft="2.4rem",s.innerHTML=`\`- ${t.name}`,s.addEventListener("click",()=>{C.changeChnl("&"+t._id)}),n.insertAdjacentElement("afterend",s),pe.menuClickEvent(s,i=>{pe.thread(i,t)})}if(t.reply){let s=document.querySelector("#mess__"+t.reply);s&&et.thread(t,s)}})}function Ss(e){document.querySelector("#channel_\\&"+e)?.remove(),document.querySelector("#thread__"+e)?.remove()}var jt=b(()=>{T();F();R();B();oe();re();$e();Xt();W();Rt();Jt();U();pt();St();j();_e();on();g("socket/mess");a(Ms,"mess");a(Es,"convertReceivedMessageToDbMessage");a(an,"message_fetch");a(ws,"message_delete");a(Ts,"messages_delete");a(Ls,"message_edit");a(ks,"message_react");a(Cs,"message_search");a(xs,"message_fetch_pinned");a(cn,"realm_thread_list");a(Ss,"realm_thread_delete")});var Is={};ae(Is,{socketEvt:()=>fe});var $o,fe,bt=b(()=>{is();ln();Gt();Qt();Pn();Rt();vt();T();jt();g("socket/engine");$o=[["self.status.get",Ps],["realm.users.sync",As],["realm.users.activity.sync",Fs],["realm.event.notify",Rs],["user.status.update",Nn],["user.status.update",Nn],["dm.get",Oe.dm_get],["realm.get",gt.realms],["realm.setup",ms],["user.profile",rt.userProfile],["friend.get.all",Hs],["friend.requests.get",Ds],["message.fetch.pinned",xs],["realm.thread.list",cn]],fe=Object.fromEntries($o.map(([e,t])=>[e,new rs(e,t)]))});function Hs(e){m.mainView.friends=e,Ve.renderFriends()}function Ds(e){m.mainView.requests=e,Ve.renderRequests()}var Ve,Ie,vt=b(()=>{T();R();W();oe();B();F();U();j();ht();_e();Pt();bt();g("components/mainView");Ve={show(){p.emit("friend.get.all"),p.emit("friend.requests.get")},renderFriends(){if($.friendsContainer.innerHTML="",m.mainView.friends.length==0){$.noFriends.style.display="";return}else $.noFriends.style.display="none";m.mainView.friends.forEach(e=>{let t=document.createElement("div");t.classList.add("main__view__friend"),t.classList.add("userStatusMarker"),t.setAttribute("data-status-id",e._id),t.innerHTML=`
                <img class="friend__avatar" src="/api/profile/img?id=${e._id}" />
                <div>
                    <span class="friend__name">${E.www.changeUserID(e._id)}</span>
                    <br />
                    <span class="friend__status">${e.status}</span>
                    ${e.text?`<span class="friend__status_text">${e.text}</span>`:""}
                </div>
            `.trim(),t.querySelector(".friend__name").addEventListener("click",n=>{n.stopPropagation(),fe["user.profile"].emitDataId(e._id)}),t.addEventListener("click",()=>{C.changeChat("$"+e._id)}),$.friendsContainer.appendChild(t),we.set(e._id,{status:e?.status,statusText:e?.text})}),Ve.sortFriends(m.mainView.page)},changeView(e){m.mainView.page=e,["all","online","offline"].includes(e)?(Ve.sortFriends(e),$.friends.style.display="",$.requests.style.display="none",Ve.renderFriends()):e=="requests"&&(Ve.renderRequests(),$.requests.style.display="",$.friends.style.display="none"),$.div.querySelectorAll("[main_view]").forEach(t=>t.style.backgroundColor=""),document.querySelector(`[main_view="${e}"]`).style.backgroundColor="var(--accent)"},sortFriends(e){let t=$.div.querySelectorAll(".main__view__friend");if(t.length==0)return;$.noFriends.style.display="none";let n=t.length;t.forEach(r=>{let s=r.getAttribute("data-status")||"offline";e=="all"||e=="online"&&(s=="online"||s=="idle"||s=="dnd")||e=="offline"&&s=="offline"?r.style.display="":(r.style.display="none",n--)}),n==0&&($.noFriends.style.display="")},renderRequests(){if($.requestsContainer.innerHTML="",$.requestCount.innerHTML=`(${m.mainView.requests.length})`,m.mainView.requests.length==0){$.noRequests.style.display="";return}else $.noRequests.style.display="none";m.mainView.requests.forEach(e=>{let t=document.createElement("div");t.classList.add("main__view__friend"),t.classList.add("userStatusMarker"),t.setAttribute("data-status-id",e),t.innerHTML=`
                <img class="friend__avatar" src="/api/profile/img?id=${e}" />
                <div>
                    <div class="friend__name">${E.www.changeUserID(e)}</div>
                    <button onclick="mglInt.mainView.requestFriendResponse('${e}', true)" class="request__btn">Accept</button>
                    <button onclick="mglInt.mainView.requestFriendResponse('${e}', false)" class="request__btn">Decline</button>
                </div>
            `;function n(){p.emit("user.profile",e)}a(n,"showUser"),t.querySelector(".friend__name").addEventListener("click",n),t.querySelector(".friend__avatar").addEventListener("click",n),$.requestsContainer.appendChild(t),ve(e,H.user_state[e]?.status.get())})},async removeFriend(e){!e||!await v.confirm(O(c.ui.confirm.remove_friend,E.www.changeUserID(e))+"?")||!await v.confirm(O(c.ui.confirm.sure,E.www.changeUserID(e))+"?")||(p.emit("friend.remove",e),p.emit("friend.get.all"))},async removeFriendRequest(e){!e||!await v.confirm(O(c.ui.confirm.remove_friend,E.www.changeUserID(e))+"?")||p.emit("friend.request.remove",e)}};Ve.changeView("online");a(Hs,"friend_get_all");a(Ds,"friend_requests_get");p.on("friend.request",e=>{let t=O(c.ui.friend.request,E.www.changeUserID(e));v.uiMsg(t,{onClick:a(()=>{C.changeChat("main"),Ve.changeView("requests")},"onClick")}),p.emit("friend.requests.get")});p.on("friend.response",(e,t)=>{if(!t){v.uiMsgT(c.ui.friend.declined,E.www.changeUserID(e));return}v.uiMsgT(c.ui.friend.request,E.www.changeUserID(e)),m.chat.to=="main"&&p.emit("friend.get.all")});Ie=Ve});function Wn(e,t){let n=document.createElement("div"),r=document.createElement("button");r.classList.add("btn"),r.id="forum_add",r.innerHTML=c.ui.create_thread,r.addEventListener("click",async()=>{let s=await v.prompt(c.ui.create_thread_name);s&&p.emit("realm.thread.create",m.chat.to,t,s,null,i=>{C.changeChnl("&"+i)})}),n.appendChild(r),n.appendChild(document.createElement("hr")),n.appendChild(document.createElement("br")),e.forEach(s=>{let i=document.createElement("div");i.classList.add("forum"),i.id="forum__"+s._id,i.innerHTML=`
            <div class="forum__author">${E.www.changeUserID(s.author)}</div>
            <div class="forum__name">${s.name}</div>
        `,n.appendChild(i),i.addEventListener("click",()=>{cn([s]),C.changeChnl("&"+s._id)})}),M.div.appendChild(n)}var js=b(()=>{B();oe();jt();F();j();W();R();U();a(Wn,"render_forum")});var He,C,oe=b(()=>{T();R();B();re();F();$e();Cn();vt();Tn();W();ee();tt();j();Rt();js();bt();on();g("coreFunc");He={async changeChat(e,t=null){if(M.div.innerHTML="",Ce.categories=[],Ce.emojis={},m.realm=$t(),e=="main"){m.chat.to="main",M.bar.style.display="none",document.querySelector("title").innerHTML=me.baseTitle,D.main.style.display="",D.realms.style.display="none",D.main__call.style.display="none",M.nav.style.display="none",$.div.style.display="",M.div.style.display="none",Ie.show(),this.markSelectedChat();return}if(setTimeout(()=>{L.ss()&&(e!="main"&&!e.startsWith("$")||(document.querySelector("nav").style.left="-360px"))},300),M.bar.style.display="block",M.div.style.display="",M.nav.style.display="",$.div.style.display="none",m.chat.to=e,m.chat.actMess=0,e.startsWith("$")){if(document.querySelector("title").innerHTML=me.baseTitle+" | "+E.www.changeUserID(e.substring(1)),D.main.style.display="",D.realms.style.display="none",m.chat.chnl="main",!m.privs.includes(e.substring(1))){let n=e.substring(1),r=await new Promise(s=>{p.emit("dm.create",n,()=>{p.emit("dm.get",(i,o)=>{s([i,o])})})});Oe.dm_get(r[0],r[1])}He.loadChat(),He.fetchPinned(),He.dmPlaceholder(e.substring(1)),D.main__call.style.display="",M.nav_priv.style.display="",M.nav_realm.style.display="none"}else document.querySelector("title").innerHTML=me.baseTitle+" | "+E.www.changeChat(e),D.main.style.display="none",D.realms.style.display="",M.nav_priv.style.display="none",M.nav_realm.style.display="",m.chat.chnl=t,nt.chnl_user=!1,D.realm__channels.style.display="",D.realm__users.style.display="none",fe["realm.setup"].emitDataId(e).then(async()=>{await delay(50),fe["realm.users.sync"].emitDataId(e),fe["realm.users.activity.sync"].emitDataId(e)});He.markSelectedChat()},changeChnl(e){m.chat.chnl=e,m.chat.actMess=0,m.chat.selectedMess=null,document.querySelectorAll(".channel_textActive").forEach(n=>n.classList.remove("channel_textActive")),document.querySelector("#channel_"+L.escape(e))?.classList?.add("channel_textActive"),Ut.messages_nav__realm__description.innerHTML=m.realm.desc[e]||"",He.loadChat(),He.fetchPinned(),e.startsWith("&")||setTimeout(()=>{fe["realm.thread.list"].emitId(m.chat.to+"="+m.chat.chnl,m.chat.to,m.chat.chnl)},100);let t=!1;if(e.startsWith("&")){let n=e.substring(1),r=m.realm.threads.find(s=>s._id==n);r&&(t=m.realm.chnlPerms[r.thread].threadWrite)}else if(e.startsWith("^"))t=m.realm.chnlPerms[e]?.threadWrite||!1;else{let n=m.realm.chnlPerms[e];n&&(t=n.write)}M.input.placeholder=t?c.ui.message.placeholder+"...":c.ui.message.read_only+"!",M.input.disabled=!t,M.bar.style.display=""},loadChat(){He.loadMess(),setTimeout(He.focusInp,100),setTimeout(()=>{M.div.scrollTop=M.div.scrollHeight},300)},focusInp(e=!1){L.ss()||setTimeout(()=>{M.input.focus(),e&&P.setSelectionStart()},100)},loadMess(){M.div.innerHTML="";let e=m.chat.actMess;m.chat.actMess+=me.messCount,m.chat.to!="main"&&(p.connected?(p.emit("message.fetch",m.chat.to,m.chat.chnl,e,m.chat.actMess),p.emit("message.mark.read",m.chat.to,m.chat.chnl,"last")):Be.getMessages())},scrollToBottom(){m.temp.scrollBlock||(m.temp.scrollBlock=!0,setTimeout(()=>{M.div.scrollTop=M.div.scrollHeight},50),setTimeout(()=>{m.temp.scrollBlock=!1},300))},markSelectedChat(){document.querySelectorAll(".priv_chat").forEach(t=>{t.classList.remove("priv_chatActive")}),document.querySelectorAll(".realm").forEach(t=>{t.classList.remove("realm_chatActive")});let e=m.chat.to;e=="main"||(e.startsWith("$")?document.querySelector("#priv_chat_"+e.substring(1)).classList.add("priv_chatActive"):document.querySelector("#realm_chat_"+e).classList.add("realm_chatActive"))},dmPlaceholder(e){function t(s,i){M.input.placeholder=s,M.input.disabled=i}if(a(t,"set"),m.blocked.some(s=>s.block==e))return t(c.ui.message.block_placeholder.block+"!",!0);if(m.blocked.some(s=>s.blocked==e))return t(c.ui.message.block_placeholder.blocked+"!",!0);t(c.ui.message.placeholder+"...",!1)},async changeToForum(e){m.chat.chnl="";let t=await new Promise(n=>{fe["realm.thread.list"].emitId(m.chat.to+"="+e,m.chat.to,e,n)});M.div.innerHTML="",Wn(t,e),M.input.placeholder=c.ui.message.read_only+"!",M.input.disabled=!0,M.bar.style.display="none"},fetchPinned(){fe["message.fetch.pinned"].emitId(m.chat.to+"="+m.chat.chnl,m.chat.to,m.chat.chnl)}},C=He;G.coreFunc=He});var ot,zn,qs=b(()=>{T();g("var/keys");ot={shift:!1,ctrl:!1,alt:!1},zn=ot;document.addEventListener("keydown",e=>{ot.shift=e.shiftKey,ot.ctrl=e.ctrlKey,ot.alt=e.altKey});document.addEventListener("keyup",e=>{ot.shift=e.shiftKey,ot.ctrl=e.ctrlKey,ot.alt=e.altKey})});var Uo,De,mn=b(()=>{T();R();W();oe();$e();F();U();qs();j();bt();g("interact/ui");Uo={editMess(e){let t=document.querySelector("#mess__"+e+" .mess_content");if(!t)return;let n=t.getAttribute("_plain");M.input.value=n,m.temp.editId=e,M.editClose.style.display="block",C.focusInp(!0),P.sendBtnStyle(),P.messageHeight(),P.setSelectionStart()},clipboardError(e){let t=document.createElement("div");t.style.opacity="0",t.classList.add("prompt"),t.innerHTML="<h2>"+c.ui.clipboard.error+".</h2>",t.innerHTML+="<h3>"+c.ui.clipboard.error_text+".</h3>",t.appendChild(document.createElement("br"));let n=document.createElement("textarea");n.value=e,t.appendChild(n),t.appendChild(document.createElement("br"));let r=document.createElement("button");r.innerHTML="OK",t.appendChild(r),r.addEventListener("click",()=>{t.fadeOut(),setTimeout(()=>{t.remove()},2e3)}),Mt.appendChild(t),t.fadeIn(()=>{n.select()})},async createThread(e=null){let{to:t,chnl:n}=m.chat;if(!t||!n||t.startsWith("$")||!m.realm.chnlPerms[n]?.threadCreate)return;let r=await v.prompt(c.ui.create_thread_name);r&&p.emit("realm.thread.create",t,n,r,e,()=>{fe["realm.thread.list"].emitId(t+"="+n,t,n)})},async deleteMess(e){!(zn.shift||zn.ctrl)&&!await v.confirm(c.ui.confirm.delete_message+"?")||p.emit("message.delete",m.chat.to,e)}},De=Uo});var Oo,L,re=b(()=>{T();B();mn();g("utils");Oo={ss(){return window.innerWidth<800},isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},extractTimeFromId(e){if(!e)return 0;let t=e.split("-")[0];return parseInt(t,36)},formatDateFormUnix(e){let t=new Date(e),n=t.getDate(),r=t.getMonth()+1,s=t.getFullYear(),i=t.getHours(),o=t.getMinutes();return`${n}.${r}.${s} ${i}:${o<10?"0":""}${o}`},validId(e){return!(!e||typeof e!="string"||e.split("-").length!=3)},writeToClipboard(e){return new Promise(t=>{navigator.clipboard.writeText(e).then(()=>{t(!0)}).catch(()=>{De.clipboardError(e),t(!1)})})},sendNotification(e,t,n={}){switch(E.app.apiType){case"rn":case"ele":E.api.send({type:"notif",title:e,msg:t,payload:n});break;case"web":if(Notification.permission==="granted"){let r=new Notification(e,{body:t});r.onclick=()=>{window.focus(),r.close()}}break;default:break}},escape(e){return e.replace(/([.&*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},rmRef(e){return JSON.parse(JSON.stringify(e))},getHighestRoleIndex(e,t){for(let n=0;n<t.length;n++)if(e.includes(t[n]))return n;return-1}},L=Oo});function O(e,...t){return e.replace(/\\\$|(?<!\\)\$/g,n=>n==="\\$"?"$":t.shift()?.toString()||"$")}async function $s(){document.querySelectorAll("[translate]").forEach(t=>{t.getAttribute("translate")||t.setAttribute("translate",t.innerHTML.trim())}),at.localesList=ke.get("lang/list.txt").split(`
`),at.localesList.unshift("en");let e=localStorage.getItem("lang");if(!e){let t=navigator.language.split("-")[0],n=at.localesList.indexOf(t);e=n>-1?at.localesList[n]:"en"}await Xn(e)}async function Xn(e="en"){if(!at.localesList.includes(e))return;localStorage.setItem("lang",e);let t={api:await Pe(e,"api"),media:await Pe(e,"media"),settings:await Pe(e,"settings"),settings_realm:await Pe(e,"settings.realm"),settings_user:await Pe(e,"settings.user"),socket:await Pe(e,"socket"),ui:await Pe(e,"ui"),uni:await Pe(e,"uni"),common:await Pe(e,"common"),InternalCode:await Pe(e,"code")};for(let n in t)Kn[n]=t[n];Bo()}function Bo(){document.querySelectorAll("[translate]").forEach(e=>{let t=e.getAttribute("translate");e.innerHTML=Vo(t)})}function Vo(e){let t=e.split("."),n=L.rmRef(Kn);for(let r of t.slice(0,-1))if(n=n[r],!n)return null;return n?.[t[t.length-1]]}async function Pe(e,t){return(await new Function("path","return import(path);")(`./lang/${e}/${t}.js`)).default}var at,Kn,c,j=b(()=>{T();dt();re();g("translate");at={localesList:[]},Kn={};a(O,"langFunc");a($s,"init_translate");a(Xn,"load_translate");a(Bo,"translateHTML");a(Vo,"getDataByKey");a(Pe,"importData");c=Kn});var Yn,Mt,Jn,v,U=b(()=>{T();ie();j();g("helpers/uiFunc");Yn=document.querySelector("#errMesses"),Mt=document.querySelector("#prompt"),Jn={async uiMessage(e,t={}){t={displayTime:6e3,...t};let n=document.createElement("div");n.innerHTML=e,n.style.top=`-${n.offsetHeight+20}px`,t.className&&n.classList.add(t.className),t.backgroundColor&&(n.style.backgroundColor=t.backgroundColor);let r=10,s=i();function i(){let d=0;for(let u of Yn.children)d+=u.offsetHeight+r;return d}a(i,"calculateTopPosition");let o=!1;async function l(){o=!0,n.style.top=`-${n.offsetHeight+20}px`,await delay(700);for(let d of Yn.children){let u=d,h=parseInt(u.style.top.replace("px",""));u.style.top=`${h-r-n.offsetHeight}px`}n.remove()}a(l,"end"),n.addEventListener("click",l),t.onClick&&n.addEventListener("click",t.onClick),Yn.appendChild(n),await delay(100),n.style.top=`${10+s}px`,await delay(t.displayTime-700),!o&&await l()},uiMsg(e,t={}){x.msg(1,"uiMsg:",e),t={extraTime:0,...t};let n=1/3,s={displayTime:(e.split(" ").length*n+6+t.extraTime)*1e3,className:"uiMsgClass"};t.onClick&&(s.onClick=t.onClick),Jn.uiMessage(e,s)},uiMsgT(e,...t){let n="";t.length>0&&Array.isArray(t[0])&&(n=t.shift()),e=O(e,...t)+n,Jn.uiMsg(e)},prompt(e,t=""){return new Promise(n=>{function r(){n(i.value),s.fadeOut(),setTimeout(()=>{s.remove()},2e3)}a(r,"end");let s=document.createElement("div");s.style.opacity="0",s.classList.add("prompt"),s.innerHTML="<p>"+e+"<p><br />";let i=document.createElement("input");i.type="text",i.value=t,i.addEventListener("keydown",l=>{l.key=="Enter"&&r()}),s.appendChild(i),setTimeout(()=>{i.focus()},100),s.appendChild(document.createElement("br"));let o=document.createElement("button");o.innerHTML="OK",s.appendChild(o),o.addEventListener("click",r),Mt.appendChild(s),s.fadeIn()})},confirm(e,t=c.uni.ok,n=c.uni.cancel){return new Promise(r=>{function s(u){return()=>{r(u),i.fadeOut(),setTimeout(()=>{i.remove()},2e3)}}a(s,"end");let i=document.createElement("div");i.style.opacity="0",i.classList.add("prompt"),i.innerHTML="<p>"+e+"<p><br />";let o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-evenly";let l=document.createElement("button");l.innerHTML=n||c.uni.cancel,l.addEventListener("click",s(!1)),o.appendChild(l);let d=document.createElement("button");d.innerHTML=t||c.uni.ok,d.addEventListener("click",s(!0)),o.appendChild(d),i.appendChild(o),Mt.appendChild(i),i.fadeIn()})},selectPrompt(e,t,n=[],r=[]){return new Promise(s=>{function i(){s(l.value),o.fadeOut(),setTimeout(()=>{o.remove()},2e3)}a(i,"end");let o=document.createElement("div");o.style.opacity="0",o.classList.add("prompt"),o.innerHTML="<p>"+e+"<p><br />";let l=document.createElement("select");for(let u=0;u<r.length;u++){let h=r[u],f=document.createElement("optgroup");f.label=h.name;for(let y=0;y<h.options.length;y++){let _=document.createElement("option");_.value=h.options[y]||h.options[y],_.innerHTML=h.options[y],f.appendChild(_)}l.appendChild(f)}for(let u=0;u<t.length;u++){let h=document.createElement("option");h.value=n[u]||t[u],h.innerHTML=t[u],l.appendChild(h)}l.querySelector("option").selected=!0,o.appendChild(l),o.appendChild(document.createElement("br"));let d=document.createElement("button");d.innerHTML="OK",o.appendChild(d),d.addEventListener("click",i),Mt.appendChild(o),o.fadeIn()})},promptTime(e,t="datetime-local",n,r){return new Promise(s=>{function i(){s(l.value),o.fadeOut(),setTimeout(()=>{o.remove()},2e3)}a(i,"end");let o=document.createElement("div");o.style.opacity="0",o.classList.add("prompt"),o.innerHTML="<p>"+e+"<p><br />";let l=document.createElement("input");l.type=t,l.value="00:00",n&&(l.min=new Date(n).toISOString()),r&&(l.max=new Date(r).toISOString()),l.addEventListener("keydown",u=>{u.key=="Enter"&&i()}),o.appendChild(l),setTimeout(()=>{l.focus()},100),o.appendChild(document.createElement("br"));let d=document.createElement("button");d.innerHTML="OK",o.appendChild(d),d.addEventListener("click",i),Mt.appendChild(o),o.fadeIn()})}},v=Jn});function No(e){let t=Us[e[0]],n=Os[e[1]];return c.InternalCode[t][n][e]||e}var Us,Os,dn,Gn=b(()=>{j();Us=(i=>(i[i.Info=1]="Info",i[i.Success=2]="Success",i[i.RedirectOrWaiting=3]="RedirectOrWaiting",i[i.UserError=4]="UserError",i[i.ServerError=5]="ServerError",i))(Us||{}),Os=(r=>(r[r.General=0]="General",r[r.Socket=1]="Socket",r[r.Express=2]="Express",r))(Os||{});a(No,"changeCodeToString");dn=No});var Bs={};ae(Bs,{send:()=>Wo});var Wo,Vs=b(()=>{U();Wo=a(e=>{v.uiMsg(e)},"send")});var Zn,zo,ct,un=b(()=>{T();B();oe();F();re();R();U();j();nn();vt();g("helpers/stateManager");Zn={handle(e,...t){let n=zo[e];return n?n(...t)||!0:!1},async handleArray(e){for(let t of e){let n=Array.isArray(t.value)?t.value:[t.value];await Zn.handle(t.type,...n),await delay(100)}},async handleGetParam(){let e=new URLSearchParams(window.location.search),t=[];for(let[n,r]of e.entries()){let[s,i,o]=n.split("_");if(s!="ctrl"||!i||!o)continue;let l=parseInt(i);isNaN(l)||t.push({type:o,value:r,num:l})}t.sort((n,r)=>n.num-r.num),await Zn.handleArray(t)},removeControlParams(){let e=new URLSearchParams(window.location.search);Array.from(e.entries()).forEach(([r])=>{r.startsWith("ctrl_")&&e.delete(r)});let t=e.toString(),n=window.location.origin+window.location.pathname+(t?"?"+t:"");window.history.replaceState({},"",n)},extractUrl(){let e=window.location.origin+window.location.pathname,t=new URLSearchParams(window.location.search);m.chat.to.startsWith("$")?t.set("ctrl_1_chat",m.chat.to):t.set("ctrl_1_cc",m.chat.to+"_"+m.chat.chnl);let n=e+"?"+t.toString();setTimeout(()=>{L.writeToClipboard(n).then(r=>{r&&v.uiMsgT(c.ui.copied)})},2e3)}},zo={chat(e){L.validId(e)&&C.changeChat(e)},chnl(e){L.validId(e)&&C.changeChnl(e)},cc(e){let[t,n]=e.split("_");L.validId(t)&&(!L.validId(n)&&n!="main"||C.changeChat(t,n))},async call(e){!L.validId(e)||!await v.confirm(O(c.ui.confirm.call_to,E.www.changeUserID(e)))||p.emit("call.dm.init",e)},realmEvt(){yt.show()},friendReq(){Ie.changeView("requests")}},ct=Zn});var zs={};ae(zs,{receiveMessage:()=>Ws,send:()=>Ns});var Ns,Ws,pn,Ks=b(()=>{R();ie();F();un();Ns=a(e=>{window.electronAPI.send(JSON.stringify(e))},"send"),Ws=a(e=>{switch(e=JSON.parse(e),e.type){case"debug":x.msg(1,e.msg);break;case"status":if(!m.settings.desktopHandling)return;let t=e.data;t==="clear"?p.emit("status.activity.remove"):typeof t=="object"&&!Array.isArray(t)&&p.emit("status.activity.set",e.data);break;case"ctrl":typeof e.ctrl=="object"&&!Array.isArray(e.ctrl)&&(e.ctrl=[e.ctrl]);let n=e.ctrl.map(r=>({type:r[0],value:r.slice(1)}));ct.handleArray(n);break}},"receiveMessage"),pn=document.createElement("div");pn.style.display="none";pn.id="electronApiDiv";pn.addEventListener("electronAPI",e=>{Ws(e.detail)});document.querySelector("#assets").appendChild(pn);setTimeout(()=>{Ns({type:"desktopHandling",data:m.settings.desktopHandling})},5e3)});var Xs={};ae(Xs,{receiveAudio:()=>Xo,receiveMessage:()=>Ko,send:()=>er});var er,Ko,Qn,Xo,Ys=b(()=>{F();ie();un();er=a(e=>{window.ReactNativeWebView.postMessage(JSON.stringify(e))},"send"),Ko=a(e=>{switch(e=JSON.parse(e),e.type){case"debug":x.msg(1,e.msg);break;case"close":p.disconnect();break;case"unclose":p.connect();break;case"ctrl":typeof e.ctrl=="object"&&!Array.isArray(e.ctrl)&&(e.ctrl=[e.ctrl]);let t=e.ctrl.map(n=>({type:n[0],value:n.slice(1)}));ct.handleArray(t);break}},"receiveMessage"),Qn={init(){this.audioContext=new AudioContext,this.destination=this.audioContext.createMediaStreamDestination();let e=this.destination.stream.getAudioTracks()[0];this.mediaStream=new MediaStream([e])},base64ToArrayBuffer(e){let t=window.atob(e),n=t.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=t.charCodeAt(s);return r.buffer},async handleAudioData(e){try{let t=await this.audioContext.decodeAudioData(e),n=this.audioContext.createBufferSource();n.buffer=t,n.connect(this.destination),n.start()}catch(t){x.msg(4,"Error processing audio data: "+t)}},async getStream(){return er({type:"startAudio"}),await globalThis.delay(1e3),this.mediaStream}},Xo=a(async e=>{let t=Qn.base64ToArrayBuffer(e);Qn.handleAudioData(t)},"receiveAudio");setTimeout(()=>{try{Qn.init()}catch(e){x.msg(4,e)}},1e3);setTimeout(()=>{p.emit("fireToken.get",localStorage.getItem("token"),e=>{er({type:"fireToken",fireToken:e})})},5e3)});var Js={};ae(Js,{send:()=>Yo});var Yo,Gs=b(()=>{U();Yo=a(e=>{v.uiMsg(e)},"send");setTimeout(()=>{v.uiMsg("Warning: Fusion Chat is being loaded within an external source. Proceed with caution.")},5500)});var Ae,E,B=b(()=>{T();ie();U();R();ee();dt();j();Gn();_e();g("apis");Ae={www:{changeUserID(e){let t=m.chat.to,n=H.temp.user;if(t.startsWith("$")||t=="main"){if(n.main[e])return n.main[e];let s=Ae.www.getInServer("/api/id/u?id="+e).name;return s?(n.main[e]=s,s):"Unknown"}n[t]||(n[t]={});let r=n[t][e];if(r)return r;if(r==0)return n.main[e];if(e.startsWith("%")){let s=Ae.www.getInServer("/api/id/wh?id="+e.replace("%","")+"&chat="+t).name+" (APP)";return s?(n[t][e]=s,s):"Unknown"}else if(e.startsWith("^")){let s=Ae.www.getInServer("/api/id/bot?id="+e.replace("^","")+"&chat="+t).name+" (BOT)";return s?(n[t][e]=s,s):"Unknown"}else if(e.startsWith("(")){let s=Ae.www.getInServer("/api/id/event?id="+e.replace("(","")).name+" (EVENT)";return s?(n[t][e]=s,s):"Unknown"}else{let s=Ae.www.getInServer("/api/id/u?id="+e+"&chat="+t);if(!s)return"Unknown";if(s.c==1)return n[t][e]=s.name,s.name;if(s.c==0){if(n[t][e]=0,n.main[e])return n.main[e];let i=Ae.www.getInServer("/api/id/u?id="+e).name;return i?(n.main[e]=i,i):"Unknown"}else return n.main[e]=s.name,s.name}},changeChat(e){if(H.temp.realm[e])return H.temp.realm[e];let t=Ae.www.getInServer("/api/id/chat?chat="+e).name;return H.temp.realm[e]=t,t},getInServer(e){let t=ke.get(e),n=JSON.parse(t);return n.err?(v.uiMsgT(c.api.error_fetch,["."]),v.uiMsgT(c.api.error,dn(n.c)),x.msg(4,n),null):n}},app:{async init(){let e={isElectron:navigator.userAgent.toLowerCase().includes("electron"),isInIframe:window.self!==window.top,isReactNative:!!window.ReactNativeWebView},t="web";e.isElectron?t="ele":e.isReactNative?t="rn":e.isInIframe&&(t="if"),this.apiType=t;let n={web:a(()=>Promise.resolve().then(()=>(Vs(),Bs)),"web"),ele:a(()=>Promise.resolve().then(()=>(Ks(),zs)),"ele"),rn:a(()=>Promise.resolve().then(()=>(Ys(),Xs)),"rn"),if:a(()=>Promise.resolve().then(()=>(Gs(),Js)),"if")};Ae.api=await n[t](),x.msg(1,"load api: "+t)},apiType:""},api:{send(e){x.msg(1,"default api: "+JSON.stringify(e))}}},E=Ae;G.apis=Ae});function Zs(){x.msg(1,"connected to socket"),p.emit("realm.get"),p.emit("self.status.get"),p.emit("dm.get")}function Qs(e,...t){if(x.msg(4,e,...t),t.length==0)return;let n=t[0];if(/^[1-5][0-2]\.\d{3}$/.test(n)){v.uiMsgT(c.api.error,dn(n));return}v.uiMsg(n)}function ei(e,t,...n){v.uiMsgT(c.socket.valid_error),x.msg(4,`Valid error: ${e} - ${t}`,...n)}function ti(e,...t){let n=c.socket.spam,s={"last warning":n.last,ban:n.ban,warn:n.warn}[e]||n.spam;v.uiMsgT(s,[],...t)}function ni(e){localStorage.getItem("token")||(window.location.href="/login?err=true"),x.msg(8,e);let t=e.toString();if(t.includes("Error: Authentication error"))window.location.href="/login?err=true";else if(t.includes("Ban:")){let n=t.match(/Ban: You are temporarily banned. Please try again after (\d+) minutes./),r="",s="";n?(r=c.socket.ban,s=n[1]):(r=t,s=""),v.uiMsgT(r,s);return}v.uiMsg(e.toString(),{extraTime:10})}function ri(e,t){localStorage.setItem("token",e),p.auth.token=e,t(!0)}async function si(e,...t){let n=[];if(Array.isArray(e))n=e;else if(typeof e=="string")n=[e];else if(typeof e=="object"){let{realm:r,chnl:s,evt:i,wait:o}=e;if(n=typeof i=="string"?[i]:Array.isArray(i)?i:[],r&&r!=m.chat.to&&r!=="*"||s&&s!=m.chat.chnl&&s!=="*")return;o&&await delay(o)}else return;n.forEach(r=>{p.emit(r,...t)})}function Ps(e,t){m.user.status=e,m.user.statusText=t,rt.localUserProfile()}function ii(e,t,n){if(!(!e||!t||!n))try{H.lastMess[e]=H.lastMess[e]||{},H.lastMess[e][t]=H.lastMess[e][t]||{read:null,mess:null},H.lastMess[e][t].read=n,e.startsWith("$")&&Oe.chats()}catch{}}function As(e,t){m.realm.users=e,m.realm.roles=t,gt.usersInChat(),P.colorRole()}function Fs(e){e.forEach(t=>{let{uid:n,status:r,activity:s}=t;!r&&!s||we.set(n,t)})}function Rs(e,t){p.emit("realm.event.get.topic",e,t,n=>{let r=O(c.ui.event.notif,`<b>"${n}"</b>`,`<b>${E.www.changeChat(e)}</b>`);v.uiMsg(r,{onClick:a(()=>{C.changeChat(e).then(()=>{yt.show()})},"onClick")})})}function Nn(e,t,n){we.set(e,{status:t,statusText:n})}var ln=b(()=>{T();B();U();Pt();Rt();nn();Gt();Qt();Gn();j();_e();R();oe();ie();$e();F();g("socket/evt");a(Zs,"connect");a(Qs,"error");a(ei,"error_valid");a(ti,"error_spam");a(ni,"connect_error");a(ri,"system_refreshToken");a(si,"refreshData");a(Ps,"self_status_get");a(ii,"message_mark_read");a(As,"realm_users_sync");a(Fs,"realm_users_activity_sync");a(Rs,"realm_event_notify");a(Nn,"user_status_update")});var Jo={};var oi=b(()=>{T();F();ln();g("socket/_evt");p.on("connect",Zs);p.on("error",Qs);p.on("error.valid",ei);p.on("error.spam",ti);p.on("connect_error",ni);p.on("system.refreshToken",ri);p.on("refreshData",si)});var Go={};var ai=b(()=>{T();F();jt();ln();R();on();g("mess/socket");p.on("mess",Ms);p.on("message.fetch",an);p.on("message.fetch",e=>{Be.addMessages(m.chat.to,m.chat.chnl,e)});p.on("message.delete",ws);p.on("messages.delete",Ts);p.on("message.edit",Ls);p.on("message.react",ks);p.on("message.search",Cs);p.on("realm.thread.delete",Ss);p.on("message.mark.read",ii)});var ea={};function Zo(e){if(!ci())return;e.preventDefault();let t=(e.clipboardData||window.clipboardData).getData("text");ye.value+=t,P.setSelectionStart(),P.sendBtnStyle(),P.messageHeight()}function Qo(e){if(!ci())return;let t=(e.clipboardData||e.originalEvent.clipboardData).items;for(let n of t){if(n.type.indexOf("image")===-1)continue;e.preventDefault();let r=n.getAsFile();Me.sendFile(r)}}function ci(){let e=document.activeElement.tagName.toLowerCase();return!(e=="input"||e=="textarea")}var ye,li=b(()=>{T();pt();$e();R();W();mn();g("mess/listeners");({input:ye}=M);ye.addEventListener("keydown",e=>{e.key=="Enter"&&(e.shiftKey||(e.preventDefault(),Me.sendMess()))});ye.addEventListener("keydown",e=>{if(e.key!="ArrowUp"||ye.value.length>0)return;e.preventDefault();let t=document.querySelectorAll(".mess_message"),n=Array.from(t).reverse().find(s=>s.querySelector(".mess_meta").getAttribute("_author")===m.user._id);if(!n)return;let r=n.id.split("mess__")[1];r&&De.editMess(r)});ye.addEventListener("keydown",e=>{if(e.key!="ArrowDown"||ye.value.length>0)return;e.preventDefault();let t=document.querySelector(".mess_message:last-child");if(!t)return;let n=t.id.split("mess__")[1];n&&(m.temp.replyId=n,M.replyClose.style.display="block",t.style.backgroundColor="var(--panel)")});ye.addEventListener("input",P.sendBtnStyle);ye.addEventListener("input",P.messageHeight);a(Zo,"pasteText");a(Qo,"pasteImage");a(ci,"pasteCheck");document.addEventListener("paste",Zo);document.addEventListener("paste",Qo);document.addEventListener("paste",()=>{if(ye==document.activeElement)return;let e=document.activeElement.tagName.toLowerCase();e=="input"||e=="textarea"||(ye.focus(),P.setSelectionStart())});document.addEventListener("keydown",e=>{if(ye==document.activeElement||e.ctrlKey||e.altKey)return;let t=document.activeElement.tagName.toLowerCase();t=="input"||t=="textarea"||(ye.focus(),P.setSelectionStart())});document.addEventListener("keydown",e=>{e.key=="Delete"&&m.chat.selectedMess&&De.deleteMess(m.chat.selectedMess)})});function ta(e,t,n,r,s){let i,o,l,d;e.addEventListener("touchstart",_=>{i=_.touches[0].clientX,o=_.touches[0].clientY}),e.addEventListener("touchend",_=>{l=_.changedTouches[0].clientX,d=_.changedTouches[0].clientY,!y(_.target)&&f()}),e.addEventListener("mousedown",_=>{i=_.clientX,o=_.clientY,e.addEventListener("mouseup",h)});function h(_){l=_.clientX,d=_.clientY,y(_.target)||f(),e.removeEventListener("mouseup",h)}a(h,"onMouseUp");function f(){let _=i-l,w=o-d;if(Math.abs(_)>Math.abs(w)){if(Math.abs(_)<100)return;_>0?t&&t():n&&n()}else{if(Math.abs(w)<100)return;w>0?r&&r():s&&s()}}a(f,"handleSwipe");function y(_){let w=Math.abs(i-l),I=Math.abs(o-d);return w>I&&_.scrollWidth!=_.clientWidth||I>w&&_.scrollHeight!=_.clientHeight}a(y,"shouldIgnoreSwipe")}var mi,di=b(()=>{T();g("swipeLib");a(ta,"setupSwipe");mi=ta});var na={};var ui=b(()=>{T();R();pt();di();tt();W();g("features");document.querySelector("#nav__toggle").addEventListener("click",()=>{let e=document.querySelector("nav").style;e.left=e.left=="0px"?"-360px":"0px"});document.querySelector("#navs__user img").src="/api/profile/img?id="+m.user._id;D.navs__user.setAttribute("data-status-id",m.user._id);document.querySelector("#app").addEventListener("contextmenu",e=>{let n=e.target.tagName.toLowerCase();me.contextmenuTags.includes(n)||e.preventDefault()});mi(document.body,()=>{document.querySelector("nav").style.left="-360px"},()=>{document.querySelector("nav").style.left="0px"},()=>{},()=>{});a(function(){let t=document.querySelector("#app");t.addEventListener("dragover",function(n){n.preventDefault(),n.stopPropagation()}),t.addEventListener("dragenter",function(n){n.preventDefault(),n.stopPropagation()}),t.addEventListener("drop",function(n){if(n.preventDefault(),n.stopPropagation(),m.chat.to=="main")return;let r=n.dataTransfer.files;for(let s of r)Me.sendFile(s)})},"initDragAndDrop")()});function pi(e){let n=`img[src*="${L.escape(`/api/profile/img?id=${e}`)}"]`;document.querySelectorAll(n).forEach(s=>{let i=new URL(s.src);i.searchParams.set("t",new Date().getTime().toString()),s.src=i.toString()})}var fi=b(()=>{T();re();g("helpers/reloadImages");a(pi,"reloadProfileImages")});var ra,tr,hi=b(()=>{T();R();B();Ct();U();Qt();F();tt();fi();j();_e();Pt();g("settingsData");ra={user:a(()=>[{name:"User settings",txt:c.settings_user.user_settings,type:"obj",settings:[{name:"Status",txt:c.settings_user.status,type:"select",defaultValue:m.user.status||"online",options:["online","idle","dnd","offline"]},{name:"Status text",txt:c.settings_user.status_text,type:"text",defaultValue:m.user.statusText||""},{name:"Nickname",txt:c.settings_user.nick,type:"text",defaultValue:E.www.changeUserID(m.user._id)||m.user.fr}]},{name:"Profile image",txt:c.settings_user.image,type:"fn",settings:a(()=>{let e=document.createElement("div"),t={img:null};e.innerHTML=`
                    <div id="_1" style="display: flex; align-items: center; column-gap: 2rem;"></div>
                `.trim();let n=e.querySelector("#_1"),r=document.createElement("img");r.src="/api/profile/img?id="+m.user._id+"&t="+Date.now(),r.css("width: 128px; height: 128px; object-fit: cover;"),n.appendChild(r);let s=document.createElement("input");return s.type="file",s.accept=me.uploadImgTypes.join(", "),s.addEventListener("change",i=>{let o=i.target;if(o.files&&o.files[0]){let l=o.files[0];t.img=l,r.src=URL.createObjectURL(l)}}),n.appendChild(s),[e,t]},"settings"),save:a((e,t)=>(t.img&&(Ye.profile(t.img),setTimeout(()=>{pi(m.user._id)},3e3)),{}),"save")},{name:"Client settings",txt:c.settings_user.client_settings,type:"obj",settings:[{name:"Language",txt:c.settings_user.lang,type:"select",defaultValue:localStorage.getItem("lang")||"en",options:at.localesList},{name:"Notifications",txt:c.settings_user.notifications,type:"checkbox",defaultValue:localStorage.getItem("notifications")=="true"||!1,only:["web","ele"]},{txt:c.settings_user.check_notifications_permissions,type:"button",onclick:a(()=>{window.Notification.requestPermission(e=>{e=="granted"?v.uiMsgT(c.uni.ok):v.uiMsgT(c.settings_user.notifications_error)})},"onclick"),only:["web","ele"]},{type:"hr"},{txt:c.settings_user.experimental_features,type:"h2"},{txt:c.settings_user.experimental_warning,type:"h3"},{name:"desktopHandling",txt:"Desktop app handling fullscreen and set activity",type:"checkbox",only:"ele",defaultValue:localStorage.getItem("desktopHandling")=="true"||!1}]},{name:"Account settings",txt:c.settings_user.account_settings,type:"obj",settings:[{name:"Logout",txt:c.settings_user.logout,type:"button",onclick:a(async()=>{let e=c.settings_user.confirm_logout+"?";await v.confirm(e)&&await v.confirm(e+" ("+c.settings_user.double_check+")")&&(localStorage.removeItem("user_id"),localStorage.removeItem("from"),localStorage.removeItem("token"),p.emit("logout",()=>{location.href="/login"}))},"onclick"),css:{color:"red"}},{name:"Delete Account",txt:c.settings_user.delete,type:"button",onclick:a(async()=>{await v.confirm(c.settings_user.confirm_delete.w1+"?")&&await v.confirm(c.settings_user.confirm_delete.w2+"?")&&await v.confirm(c.settings_user.confirm_delete.w3+"?")&&p.emit("user.delete",()=>{localStorage.removeItem("user_id"),localStorage.removeItem("from"),localStorage.removeItem("token"),alert(c.settings_user.after_delete),location.href="/login"})},"onclick"),css:{color:"red"}}]}],"user"),userSave:a(e=>{e.Status!=null&&(m.user.status=e.Status),e["Status text"]!=null&&(m.user.statusText=e["Status text"]),(e.Status!=null||e["Status text"]!=null)&&(p.emit("self.status.update",m.user.status,m.user.statusText),rt.localUserProfile(),we.set(m.user._id,{status:m.user.status,statusText:m.user.statusText})),e.Nickname!=null&&(p.emit("profile.set_nickname",e.Nickname),H.temp.user.main[m.user._id]=e.Nickname,rt.localUserProfile());let t=e.Language;t!=null&&t!=localStorage.getItem("lang")&&Xn(t);let n=e.Notifications;n!=null&&(localStorage.setItem("notifications",n),m.settings.notifications=n,n&&window.Notification.requestPermission(s=>{s!="granted"&&v.uiMsgT(c.settings_user.notifications_error)}));let r=e.desktopHandling;r!=null&&(localStorage.setItem("desktopHandling",r),m.settings.desktopHandling=r,r||p.emit("status.activity.remove"),E.app.apiType=="ele"&&E.api.send({type:"desktopHandling",data:r}))},"userSave")},tr=ra});var qt,nr,gi,_i=b(()=>{T();B();j();g("settingsLib");qt={createCheckbox(e){let t=document.createElement("input");return t.type="checkbox",t.checked=e.defaultValue,t.classList.add("checkbox_switch"),t},createTextInput(e){let t=document.createElement("input");return t.type="text",t.value=e.defaultValue,t},createSelectInput(e){let t=document.createElement("select");return e.options.forEach(n=>{let r=document.createElement("option");r.value=n,r.textContent=n,n===e.defaultValue&&(r.selected=!0),t.appendChild(r)}),t},createButton(e){let t=document.createElement("button");return t.textContent=e.txt||e.name,t.onclick=e.onclick,t}},nr=class{static{a(this,"SettingsManager")}settings;saveCallback;exitCallback;container;constructor(t,n,r,s){this.settings=t,this.saveCallback=r,this.exitCallback=s,this.container=n,this.init()}init(){this.container.innerHTML="";let t=[];function n(i){return i.filter(o=>{if(!("only"in o)||!o.only)return!0;let l=o.only;return typeof l=="string"&&(l=[l]),!!l.includes(E.app.apiType)})}a(n,"onlyFilter"),this.settings=n(this.settings),this.settings.forEach(i=>{i.type=="obj"&&(i.settings=n(i.settings))}),this.renderCategorySwitcher(),this.settings.forEach(i=>{let o=document.createElement("div");if(o.className="settings__category",o.setAttribute("data-id",i.name),o.innerHTML=`<h1>${i.txt||i.name}</h1>`,i.type=="obj")i.settings.forEach(l=>{let d=document.createElement("div");d.className="settings__setting";function u(){let f=document.createElement("label");f.textContent=l.txt||l.name,f.setAttribute("data-txt",l.name),d.appendChild(f)}a(u,"createLabel");let h;switch(l.type){case"checkbox":u(),h=qt.createCheckbox(l);break;case"text":u(),h=qt.createTextInput(l);break;case"select":u(),h=qt.createSelectInput(l);break;case"button":h=qt.createButton(l);break;case"hr":h=document.createElement("hr");break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":case"p":h=document.createElement(l.type),h.textContent=l.txt||l.name;break;default:u()}h&&(d.appendChild(h),l.css&&h.css(l.css)),o.appendChild(d)});else if(i.type=="fn"){let[l,d]=i.settings(qt);o.appendChild(l),t.push({div:l,save:i.save,tmpData:d})}this.container.appendChild(o)}),this.changeDisplay(this.settings[0]?.name);let r=document.createElement("button");r.textContent=c.settings.save,r.className="settings__exitButton",r.onclick=()=>this.saveSettings(t);let s=document.createElement("button");s.textContent=c.settings.exit_without_save,s.className="settings__exitButton",s.onclick=()=>this.exitWithoutSaving(),this.container.appendChild(document.createElement("br")),this.container.appendChild(r),this.container.appendChild(s),this.container.fadeIn()}renderCategorySwitcher(){let t=document.createElement("div");t.className="settings__categorySwitcher",this.settings.map(r=>r.name).forEach(r=>{let s=document.createElement("button");s.textContent=r,s.className="btn",s.onclick=()=>this.changeDisplay(r),t.appendChild(s)}),this.container.appendChild(t)}changeDisplay(t){let n=this.container;this.settings.map(r=>r.name).forEach(r=>{let s=n.querySelector(`[data-id="${r}"]`);s&&(s.style.display=r===t?"":"none")})}saveSettings(t){if(this.saveCallback&&typeof this.saveCallback=="function"){let n=this.getCurrentSettings(),r=t.map(i=>i.save(i.div,i.tmpData)),s=Object.assign({},n,...r);this.saveCallback(s)}this.container.innerHTML="",this.container.fadeOut()}exitWithoutSaving(){this.exitCallback&&typeof this.exitCallback=="function"&&this.exitCallback(),this.container.innerHTML="",this.container.fadeOut()}getCurrentSettings(){let t={};return this.container.querySelectorAll(".settings__setting").forEach(n=>{let r=n.querySelector("label"),s=n.querySelector("input, select, ul");if(r&&s){let i=s.type==="checkbox"?s.checked:s.value;t[r.getAttribute("data-txt")]=i}}),t}},gi=nr});var Fe,te,A,wt,S,Ne=b(()=>{T();g("rs/utils");Fe=a(function(e){let t=document.createElement("div");return t.className="settings__category",e&&e.appendChild(t),t},"initCategoryElement"),te=a(function(e,t,n){let r=document.createElement("div");r.innerHTML=`<label>${t}</label>`;let s=document.createElement("input");return s.type="text",s.value=n,r.appendChild(s),e.appendChild(r),s},"initInputText"),A=a(function(e,t,n){let r=document.createElement("button");return r.innerHTML=t,r.onclick=n,r.style.marginInline="3px",e.appendChild(r),r},"initButton"),wt=a(function(e,t,n){let r=document.createElement("div");r.style.marginBottom="3px";let s=document.createElement("input");s.type="checkbox",s.checked=n||!1,s.classList.add("checkbox_switch"),r.appendChild(s);let i=document.createElement("label");return i.innerHTML=t,r.appendChild(i),e.appendChild(r),s},"initCheckbox"),S=a(function(e=void 0,t=0){let n=document.createElement("div");return n.style.height=t+"px",e&&e.appendChild(n),n},"addSeparator")});function sa(e){return{meta:Fe(e),category:Fe(e),editChannel:Fe(e),role:Fe(e),editRole:Fe(e),usersManager:Fe(e),emoji:Fe(e),webhook:Fe(e),editWebhook:Fe(e)}}function yi(e){let{settings:t,realmId:n,container:r}=e;vi={html:sa(r),container:r,settings:t,realmId:n,_this:e}}var vi,Y,Re=b(()=>{T();Ne();g("rs/var");a(sa,"initCategories");Y=a(()=>vi,"default");a(yi,"setData")});var rr,sr,fn,ir=b(()=>{T();Re();U();j();g("rs/save");rr=a(async function(){let e=Y(),t=e._this,n=e.settings;if(!t.saveCallback&&typeof t.saveCallback!="function"){e.container.innerHTML="";return}t.saveMetaSettings();let r=JSON.parse(JSON.stringify(n.addons));delete n.addons;let s=await t.saveCallback(n);if(n.addons=r,!s){v.uiMsgT(c.settings_realm.failed_to_save);return}return!0},"saveSettings"),sr=a(function(){let e=Y(),t=e._this;t.exitCallback&&typeof t.exitCallback=="function"&&t.exitCallback(),e.container.fadeOut(),e.container.innerHTML=""},"exitWithoutSaving"),fn=a(async function(){await rr()&&sr()},"saveAndExitSettings")});var hn,or=b(()=>{T();F();U();Ct();oe();Re();Ne();ie();tt();j();ir();g("rs/meta");hn=a(function(){let e=Y(),t=e.settings;if(!t||!t.meta)return x.msg(4,c.settings_realm.no_data);let n=e.html.meta;n.innerHTML=`<h1>${c.settings_realm.basic_settings}</h1>`;let r=t.meta,s=!1,i=te(n,c.settings_realm.realm_name,r.name);S(n,10);let o=document.createElement("img");o.id="settings__realmImg",r.img?o.src="/userFiles/realms/"+e.realmId+".png":o.style.display="none",n.appendChild(o);let l=document.createElement("input");l.type="file",l.accept=me.uploadImgTypes.join(", "),l.addEventListener("change",d=>{r.img=!0,s=d.target.files[0],o.src=URL.createObjectURL(d.target.files[0]),o.style.display=""}),n.appendChild(l),S(n,5),A(n,c.settings_realm.remove_image,()=>{o.style.display="none",r.img=!1}),S(n,15),A(n,c.settings_realm.delete_realm,async()=>{let d="? ("+r.name+")",u=[c.settings_realm.delete_realm_confirm.w1,c.settings_realm.delete_realm_confirm.w2,c.settings_realm.delete_realm_confirm.w3];for(let f of u)if(!await v.confirm(f+d))return;let h=await v.prompt(c.settings_realm.confirm_realm_name+"?");if(h!==r.name)return v.uiMsgT(c.settings_realm.delete_wrong_name);fn(),C.changeChat("main"),setTimeout(()=>{p.emit("realm.delete",e.realmId,h)},1e3)}).style.color="red",e._this.saveMetaSettings=()=>{t.meta.name=i.value,s&&Ye.realm(s,e.realmId)}},"renderMeta")});function ia(e=[1,1]){let t=Ei();return bi(t,e)}function bi(e,t){let n=t.map(s=>oa(s)),r=[e,...n].join("-");return ar.has(r)?(e=Ei(),bi(e,t)):(ar.set(r,!0),setTimeout(()=>{ar.delete(r)},1e3),r)}function oa(e){return Math.floor(Math.random()*Math.pow(36,e)).toString(36)}function Ei(){return new Date().getTime().toString(36)}var ar,lt,gn=b(()=>{T();g("genId");ar=new Map;a(ia,"genId");a(bi,"getUniqueRandom");a(oa,"getRandom");a(Ei,"getTime");lt=ia});var We,aa,cr=b(()=>{T();qe();R();gn();Re();ie();Ne();j();U();g("rs/roles");We=a(function(){let e=Y(),t=e.settings;if(!t||!t.roles)return x.msg(4,c.settings_realm.no_data);let n=e.html.role;n.innerHTML=`<h1>${c.settings_realm.roles}</h1>`;let r=t.roles,s=new Map;function i(){r.sort((l,d)=>l.lvl-d.lvl).forEach((l,d)=>l.lvl=d)}a(i,"repairHierarchy");function o(l,d){let u=document.createElement("details");s.set(l._id,u),S(u,5);let h=document.createElement("summary");h.innerHTML=l.name,h.style.color=l.c??"",u.appendChild(h);let f=document.createElement("div");if(l.p<0)f.innerHTML=c.settings_realm.no_perm_to_edit_role;else{let y={summary:h};if(A(u,c.uni.edit,()=>aa(l,y)),l.lvl!=0&&A(u,c.uni.delete,()=>{t.roles=r.filter(_=>_._id!==l._id),i(),We()}),d>0){let _=r[d-1];_.p>=0&&A(u,c.settings_realm.move_up,()=>{let w=l.lvl;l.lvl=_.lvl,_.lvl=w,i(),We()})}d<r.length-1&&A(u,c.settings_realm.move_down,()=>{let _=r[d+1],w=l.lvl;l.lvl=_.lvl,_.lvl=w,i(),We()})}u.appendChild(f),n.appendChild(u),S(u,5)}a(o,"renderRole"),S(n,10),A(n,c.uni.add,async()=>{let l=lt(),u={name:await v.prompt(c.settings_realm.enter_name)||"New role",lvl:r.length,p:0,_id:l};t.roles.push(u),i(),We()});for(let l=0;l<t.roles.length;l++)o(t.roles[l],l)},"renderRoles"),aa=a(function(e,t){let n=Y().html.editRole;n.innerHTML=`<h1>${c.settings_realm.edit_role}</h1>`;let r=te(n,c.settings.name,e.name);r.onchange=()=>{e.name=r.value,t.summary.innerHTML=e.name},S(n,5);let s=document.createElement("input");s.type="color",s.value=e.c||"",s.onchange=()=>{e.c=s.value,t.summary.style.color=e.c??null},n.appendChild(s),S(n,5);function i(){let u=0;return o.forEach((h,f)=>{h.checked&&(u+=1<<f)}),u}a(i,"caclulatePermissionsByCheckBoxs");let o=[],l=["admin","manage_messages","ban_user","mute_user","kick_user","manage_roles","manage_emojis","manage_invites","manage_webhooks","manage_channels"],d=m.realm.permission||0;l.forEach((u,h)=>{let f=J.hasPermission(e.p,1<<h),y=wt(n,c.settings_realm.role_permissions[u],f);if(J.hasPermission(d,1<<h))y.onchange=()=>e.p=i();else{y.disabled=!0;let _=y.nextElementSibling;_.style.textDecoration="line-through"}o.push(y)}),S(n,10),A(n,c.uni.close,()=>{We(),n.fadeOut()}),n.fadeIn()},"renderRoleEdit")});var Tt,lr=b(()=>{T();F();Ct();ie();Re();Ne();tt();j();g("rs/emoji");Tt=a(function(){let e=Y(),t=e.settings;if(!t||!t.emojis)return x.msg(4,c.settings_realm.no_data);e.html.emoji.innerHTML=`<h1>${c.settings_realm.emoji_manager}</h1>`;let n=document.createElement("button");n.innerHTML=c.settings_realm.upload_emoji,n.onclick=()=>{let s=document.createElement("input");s.type="file",s.accept=me.uploadImgTypes.join(","),s.onchange=async()=>{let i=s.files[0];i&&(Ye.emocji(i,e.realmId),setTimeout(()=>{p.emit("realm.emojis.sync",e.realmId,o=>{t.emojis=o,Tt()})},1e3))},s.click()},e.html.emoji.appendChild(n);function r(s){let i=document.createElement("div");i.classList.add("emoji__container");let o=document.createElement("img");o.src="/userFiles/realms/"+e.realmId+"/emojis/"+s.emoji+".png",o.style.width="64px",i.appendChild(o);let l=te(i,c.settings.name,s.name);l.addEventListener("change",()=>{s.name=l.value}),A(i,c.uni.delete,()=>{let d=t.emojis;d.splice(d.indexOf(s),1),Tt()}),e.html.emoji.appendChild(i)}a(r,"renderEmoji");for(let s of t.emojis)r(s)},"renderEmojis")});var ce,ca,la,ma,mr=b(()=>{T();Re();B();gn();U();ie();F();j();Ne();g("rs/channels");ce=a(function(){let e=Y(),t=e.settings;if(!t||!t.categories||!t.channels)return x.msg(4,c.settings_realm.no_data);let n=e.html.category;n.innerHTML=`<h1>${c.settings_realm.categories_and_channels}</h1>`;let r=t.categories.sort((i,o)=>i.i-o.i),s=t.channels;A(n,c.settings_realm.add_category,async()=>{let i=await v.prompt(c.settings_realm.enter_name);t.categories.push({cid:lt(),name:i||"New Category",i:t.categories.length}),ce()}),r.forEach(i=>{S(n,15);let o=document.createElement("div");o.innerHTML=`<span style="font-size: 1.5rem" class="settings__nameSpan">- ${i.name}</span>`,A(o,c.settings_realm.move_up,()=>{if(i.i===0)return;let d=i.i;t.categories[d].i=d-1,t.categories[d-1].i=d,ce()}),A(o,c.settings_realm.move_down,()=>{if(i.i===r.length-1)return;let d=i.i;t.categories[d].i=d+1,t.categories[d+1].i=d,ce()}),A(o,c.uni.edit,()=>{n.querySelectorAll("div").forEach(d=>d.style.border=""),o.style.border="3px dotted var(--accent)",la(i)}),A(o,c.settings_realm.add_channel,async()=>{let d=await v.prompt(c.settings_realm.enter_name),{text:u,voice:h,announcement:f,open_announcement:y,forum:_}=c.settings_realm.channel_types,w=await v.selectPrompt(c.settings_realm.select_type,[u,h,f,y,_],["text","voice","announcement","open_announcement","forum"]),I={name:d||"New Channel",type:w||"text",category:i.cid,i:s.filter(Z=>Z.category===i.cid).length,rp:[],chid:lt(),desc:""};t.channels.push(I),ce()}),S(o,10);let l=s.filter(d=>d.category===i.cid).sort((d,u)=>d.i-u.i);l.forEach(d=>{let u=document.createElement("div");u.innerHTML=`<span style="font-size: 1.2rem" class="settings__nameSpan">${"&nbsp;".repeat(3)}+ ${d.name} (${d.type})</span>`,A(u,c.settings_realm.move_up,()=>{if(d.i===0)return;let h=d.i,f=t.channels.findIndex(_=>_.category!==d.category?!1:_.i===h),y=t.channels.findIndex(_=>_.category!==d.category?!1:_.i===h-1);f===-1||y===-1||(t.channels[f].i=h-1,t.channels[y].i=h,ce())}),A(u,c.settings_realm.move_down,()=>{if(d.i>=l.length-1)return;let h=d.i,f=t.channels.findIndex(_=>_.category!==d.category?!1:_.i===h),y=t.channels.findIndex(_=>_.category!==d.category?!1:_.i===h+1);f===-1||y===-1||(t.channels[f].i=h+1,t.channels[y].i=h,ce())}),A(u,c.uni.edit,()=>{n.querySelectorAll("div").forEach(h=>h.style.border=""),u.style.border="3px dotted var(--accent)",ca(d)}),o.appendChild(u),S(o,10)}),n.appendChild(o)})},"renderChannels"),ca=a(function(e){let t=Y(),n=t.html.editChannel,r=t.settings;n.innerHTML=`<h1>${c.settings_realm.edit_channel}</h1>`;let s=te(n,c.settings.name,e.name),i=te(n,c.settings.description,e.desc||"");function o(d){let u=document.createElement("details"),h=document.createElement("summary");h.innerHTML=d.name,u.appendChild(h);let f=e.rp.find(y=>y.startsWith(d._id));f=f?parseInt(f.split("/")[1]):0,ma().forEach((y,_)=>{let w=f&1<<_,I=wt(u,y,!!w);I.setAttribute("data-role",d._id),I.setAttribute("data-perm",_.toString())}),n.appendChild(u),S(u,5)}a(o,"renderRole"),r.roles.forEach(o);let l=r.addons.subscribedChannels.filter(d=>d.tc===e.chid);if(l.length>0){S(n,10);let d=document.createElement("details"),u=document.createElement("summary");u.innerHTML=c.settings_realm.subscribed_channels,d.appendChild(u);let h=document.createElement("ul");l.forEach(f=>{let y=document.createElement("li");y.style.marginLeft="1.2rem",y.innerHTML=E.www.changeChat(f.sr)+" - "+f.name;let _=document.createElement("button");_.style.marginLeft="1rem",_.innerHTML=c.settings_realm.unsubscribe_channel,_.addEventListener("click",async()=>{let w=O(c.settings_realm.confirm_unsubscribe,E.www.changeChat(f.sr)+" - "+f.name)+"?";await v.confirm(w)&&(p.emit("realm.announcement.channel.unsubscribe",f.sr,f.sc,t.realmId,f.tc),r.addons.subscribedChannels=r.addons.subscribedChannels.filter(Z=>Z!==f),y.remove())}),y.appendChild(_),h.appendChild(y)}),d.appendChild(h),n.appendChild(d)}S(n,15),A(n,c.settings.save,()=>{e.name=s.value;let d=i.value;e.desc=d.trim()===""?void 0:d;let u=r.roles,h=new Map;u.forEach(f=>h.set(f._id,0)),n.querySelectorAll("input[type=checkbox][data-role][data-perm]").forEach(f=>{if(!f.checked)return;let y=f.getAttribute("data-role"),_=f.getAttribute("data-perm"),w=h.get(y),I=1<<parseInt(_);h.set(y,w|I)}),e.rp=Array.from(h).filter(([,f])=>f!==0).map(([f,y])=>`${f}/${y}`),ce(),n.fadeOut()}),A(n,c.uni.cancel,()=>{ce(),n.fadeOut()}),A(n,c.uni.delete,()=>{let d=r.channels.findIndex(u=>u===e);d!==-1&&(r.channels.splice(d,1),ce(),n.fadeOut())}),n.fadeIn()},"renderEditChannel"),la=a(function(e){let t=Y(),n=t.settings;if(!n||!n.categories)return x.msg(4,"No settings data");let r=t.html.editChannel;r.innerHTML=`<h1>${c.settings_realm.edit_category}</h1>`;let s=te(r,c.settings.name,e.name);S(r,15),A(r,c.settings.save,()=>{e.name=s.value,ce(),r.fadeOut()}),A(r,c.uni.cancel,()=>{ce(),r.fadeOut()}),A(r,c.uni.delete,()=>{let i=n.categories.findIndex(o=>o.cid===e.cid);i!==-1&&(n.categories.splice(i,1),ce(),r.fadeOut())}),r.fadeIn()},"renderEditCategory"),ma=a(()=>[c.settings_realm.mess_permissions.view,c.settings_realm.mess_permissions.write,c.settings_realm.mess_permissions.files,c.settings_realm.mess_permissions.reactions,c.settings_realm.mess_permissions.thread,c.settings_realm.mess_permissions.thread_view,c.settings_realm.mess_permissions.thread_write],"vars_channelsFlags")});var da,mt,Mi,dr=b(()=>{T();gn();U();Re();re();Ne();j();ie();F();g("rs/webhooks");da=["text","open_announcement","announcement"],mt=a(function(){let e=Y(),t=e.settings;if(!t||!t.webhooks)return x.msg(4,c.settings_realm.no_data);let n=e.html.webhook;n.innerHTML=`<h1>${c.settings_realm.webhooks.webhook}</h1>`,A(n,c.settings_realm.add_webhook,()=>{function r(l,d){l=l.sort((u,h)=>u.i-h.i);for(let u of l){let h=d.filter(f=>f.type==="text"&&f.category===u.cid).sort((f,y)=>f.i-y.i);if(h.length>0)return h[0].chid}return null}a(r,"findFirstTextChannel");let s="$"+lt(),i=r(t.categories,t.channels);if(!i)return v.uiMsgT(c.settings_realm.no_channels);let o={whid:s,name:"Webhook",template:"$content",chnl:i,ajv:{},required:[]};t.webhooks.push(o),mt(),Mi(s)}),S(n,15),t.webhooks.forEach(r=>{let s=document.createElement("div");s.innerHTML=r.name,A(s,"Edit",()=>{Mi(r.whid)}),n.appendChild(s)})},"renderWebhooks"),Mi=a(function(e){let t=Y(),n=t.settings,r=t.html.editWebhook;r.innerHTML=`<h1>${c.settings_realm.edit_webhook}</h1>`;let s=n.webhooks.find(q=>q.whid==e);if(!s)return v.uiMsgT(c.settings_realm.webhooks.not_found);if(s.whid.startsWith("$")){let q=document.createElement("span");q.innerHTML=c.settings_realm.webhooks.get_url_before,r.appendChild(q)}else{let q=document.createElement("button");q.innerHTML="URL (POST) "+c.uni.copy,q.onclick=()=>{p.emit("realm.webhook.token.get",t.realmId,s.whid,z=>{let se=`${window.location.origin}/api/webhook/custom?token=${z}`;L.writeToClipboard(se).then(le=>{le&&v.uiMsgT(c.ui.copied)})})},r.appendChild(q)}let i=c.settings_realm.webhooks;S(r,15);let o=te(r,c.settings.name,s.name);S(r,5);let l=te(r,i.template,s.template);function d(q,z){let se=document.createElement("select");q=q.sort((le,be)=>le.i-be.i);for(let le of q){let be=document.createElement("optgroup");be.label=le.name,z.filter(Ee=>Ee.category===le.cid).filter(Ee=>da.includes(Ee.type)).sort((Ee,Le)=>Ee.i-Le.i).forEach(Ee=>{let Le=document.createElement("option");Le.value=Ee.chid,Le.innerHTML=Ee.name,be.appendChild(Le)}),se.appendChild(be)}return se}a(d,"renderChnls"),S(r,5);let u=document.createElement("label");u.innerHTML=i.channel,r.appendChild(u);let h=d(n.categories,n.channels);h.value=s.chnl,r.appendChild(h),S(r,10);let f=document.createElement("div");f.innerHTML=`<h2>${i.advanced}</h2>`;let y=te(f,i.ajv,JSON.stringify(s.ajv)||"{}");S(f,5);let _=te(f,i.required_fields,JSON.stringify(s.required)||"[]");r.appendChild(f),S(r,10);let w=document.createElement("div");w.innerHTML=`<h2>${i.embed_settings}</h2>`,S(w,5);let I=s.embed,Z=te(w,i.title,I?.title||"");S(w,5);let he=te(w,i.url,I?.url||"");S(w,5);let ze=te(w,c.settings.description,I?.description||"");S(w,5);let Ze=te(w,i.image,I?.image||"");S(w,5);let je=document.createElement("div");je.innerHTML=`<h3>${i.custom_fields}</h3>`,w.appendChild(je),S(je,5);let Te=[];function Lt(q,z){let se=document.createElement("li"),le=document.createElement("input"),be=document.createElement("input");le.type="text",be.type="text",le.value=q,be.value=z,be.classList.add("margin-left");let Ee={name:le,value:be},Le=document.createElement("button");Le.innerHTML=c.uni.delete,Le.classList.add("margin-left"),Le.addEventListener("click",()=>{Te.splice(Te.indexOf(Ee),1),se.remove()}),se.appendChild(le),se.appendChild(be),se.appendChild(Le),S(se,5),K.appendChild(se),Te.push(Ee)}a(Lt,"createEmbedCustomFields"),A(je,c.uni.add,()=>Lt("","")),S(w,5);let K=document.createElement("ul");K.style.listStyleType="none",K.style.paddingLeft="3px",je.appendChild(K),S(K,5),s.embed&&s.embed.customFields&&Object.entries(s.embed.customFields).forEach(([q,z])=>Lt(q,z)),r.appendChild(w),S(r,15),A(r,c.settings.save,()=>{if(s.name=o.value,s.template=l.value,s.ajv=y.value?JSON.parse(y.value):{},s.required=_.value?JSON.parse(_.value):[],s.chnl=h.value,Z.value.trim()!==""){let q={title:Z.value.trim(),url:he.value.trim(),description:ze.value.trim(),image:Ze.value.trim(),customFields:Te.map(({name:z,value:se})=>({name:z.value.trim(),value:se.value.trim()})).reduce((z,{name:se,value:le})=>(z[se]=le,z),{})};s.embed=q}else s.embed=void 0;mt(),r.fadeOut()}),A(r,c.uni.cancel,()=>{r.fadeOut(),s.embed?.title||(s.embed=void 0)}),A(r,c.uni.delete,()=>{n.webhooks=n.webhooks.filter(q=>q.whid!=e),mt(),r.fadeOut()}),r.fadeIn()},"renderWebhookEdit")});var Ge,ur=b(()=>{T();B();R();F();ie();Re();Ne();j();U();g("rs/users");Ge=a(function(){let e=Y(),t=e.settings;if(!t||!t.users)return x.msg(4,c.settings_realm.no_data);let n=e.html.usersManager;n.innerHTML=`<h1>${c.settings_realm.users_manager}</h1>`;let r=t.users,s=t.roles;function i(o){let l=document.createElement("details"),d=document.createElement("summary");d.innerHTML=E.www.changeUserID(o.u),l.appendChild(d);let u=document.createElement("div"),h=o.r,f=[];return s.forEach(y=>{if(!y._id)return;let _=wt(u,y.name,h.includes(y._id));f.push({id:y._id,checkbox:_})}),S(u,10),A(u,c.uni.update,()=>{let y=[];f.forEach(_=>{let{id:w,checkbox:I}=_;I.checked&&y.push(w)}),t.users.find(_=>_===o).r=y,Ge()}),o.u!=m.user._id&&(S(u,10),A(u,c.settings_realm.role_permissions.kick_user,async()=>{let y=O(c.settings_realm.user_mgmt_confirms.kick_sure,E.www.changeUserID(o.u))+"?";await v.confirm(y)&&(t.users=t.users.filter(w=>w.u!==o.u),p.emit("realm.user.kick",e.realmId,o.u),Ge())}),A(u,c.settings_realm.role_permissions.ban_user,async()=>{let y=O(c.settings_realm.user_mgmt_confirms.ban_sure,E.www.changeUserID(o.u))+"?";await v.confirm(y)&&(t.users=t.users.filter(w=>w.u!==o.u),p.emit("realm.user.kick",e.realmId,o.u,!0),Ge())})),l.appendChild(u),S(l,10),l}if(a(i,"renderUser"),r.forEach(o=>{n.appendChild(i(o)),S(n,10)}),t.banUsers.length>0){let o=document.createElement("details"),l=document.createElement("summary");l.innerHTML=c.settings_realm.banned_users,o.appendChild(l),t.banUsers.forEach(d=>{let u=document.createElement("span");u.innerHTML=E.www.changeUserID(d),o.appendChild(u),A(o,c.settings_realm.unban_user,async()=>{let h=O(c.settings_realm.user_mgmt_confirms.unban_sure,E.www.changeUserID(d))+"?";await v.confirm(h)&&(t.banUsers=t.banUsers.filter(y=>y!==y),p.emit("realm.user.unban",e.realmId,d),Ge())})}),n.appendChild(o)}},"renderUserRoleManager")});var wi,Ti=b(()=>{wi=["meta","category","editChannel","role","editRole","usersManager","emoji","webhook","editWebhook"]});function ua(e){let t=a(()=>pr({[e.name]:!0}),"updateDisplay"),n=Y(),r=n.settings,s=e.req;if(!s)return t();let i=s.filter(o=>!r[o]);if(i.length==0)return t();p.emit("realm.settings.get",n.realmId,i,o=>{n.settings={...r,...o},e.render?.(),t()})}var pr,Li,ki=b(()=>{T();j();qe();F();Re();or();dr();lr();ur();cr();mr();Ne();Ti();g("rs/nav");pr=a(function(e){let t=Y();for(let n of wi){let r=t.html[n];r.style.display=e[n]?"block":"none"}},"changeDisplay"),Li=a(function(){let t=[{text:c.settings_realm.basic_settings,name:"meta",req:["meta"],render:hn},{text:c.settings_realm.categories_and_channels,name:"category",req:["categories","channels"],p:512,render:ce},{text:c.settings_realm.roles,name:"role",req:["roles"],p:32,render:We},{text:c.settings_realm.users_manager,req:["users","banUsers","roles"],name:"usersManager",p:4,render:Ge},{text:c.settings_realm.emoji_manager,name:"emoji",req:["emojis"],p:64,render:Tt},{text:c.settings_realm.webhooks.webhook,name:"webhook",req:["webhooks"],p:256,render:mt}].map(s=>{let i=!0;s.p&&!J.canAction(s.p)&&(i=!1);let o=document.createElement("button");return o.className="btn",o.textContent=s.text,o.disabled=!i,i&&(o.onclick=()=>{ua(s)}),o}),n=document.createElement("div");n.className="settings__categorySwitcher",t.forEach(s=>{n.appendChild(s)});let r=Y();r.container.insertAdjacentElement("afterbegin",S(void 0,20)),r.container.insertAdjacentElement("afterbegin",n)},"renderCategorySwitcher");a(ua,"categorySwitcherButtonOnClick")});var fr,Ci,xi=b(()=>{T();Re();or();cr();lr();mr();dr();ur();ir();ki();j();g("realmSettings");fr=class{static{a(this,"RealmSettingsManager")}settings;saveCallback;exitCallback;container;realmId;saveMetaSettings;constructor(t,n,r,s,i){if(this.settings=t,this.saveCallback=s,this.exitCallback=i,this.container=r,this.realmId=n,!this.settings){console.warn("No settings found");return}this.container.innerHTML="",yi(this)}init(){if(!this.settings)return console.warn("No settings found");Li(),hn(),ce(),We(),Ge(),Tt(),mt(),pr({meta:!0});let t=document.createElement("button");t.textContent=c.settings.save_and_exit,t.className="settings__exitButton",t.onclick=()=>fn();let n=document.createElement("button");n.textContent=c.settings.save,n.className="settings__exitButton",n.onclick=()=>rr();let r=document.createElement("button");r.textContent=c.settings.exit_without_save,r.className="settings__exitButton",r.onclick=()=>sr(),this.container.appendChild(document.createElement("br")),this.container.appendChild(t),this.container.appendChild(n),this.container.appendChild(r),this.container.fadeIn()}},Ci=fr});var Ii={};ae(Ii,{default:()=>pa});var Si,hr,pa,Hi=b(()=>{T();ee();ie();hi();_i();F();xi();g("settings");Si=document.querySelector("#settings"),hr={showUserSettings(){new gi(tr.user(),Si,tr.userSave,()=>{})},showRealmSettings(e,t){new Ci(e,t,Si,r=>new Promise(s=>{p.emit("realm.settings.set",t,r,(...i)=>{if(i.length==1&&i[0]===!1)return s(!0);s(!1),x.msg(4,"Error saving realm settings: ",...i)})}),()=>{}).init()}};p.on("realm.settings.get",hr.showRealmSettings);pa=hr;Q.settingsFunc=hr});var Di={};ae(Di,{default:()=>_r});var gr,_r,vr=b(()=>{T();B();ee();F();g("interact/subscribeEventChnl");gr={popup:document.querySelector("#subscribeEventChnl"),init(){let e=this.popup;this.realms=e.querySelector("#subscribeEventChnl_realms"),this.channels=e.querySelector("#subscribeEventChnl_channels"),this.okBtn=e.querySelector("#subscribeEventChnl_subscribe"),this.cancelBtn=e.querySelector("#subscribeEventChnl_exit")},loadChannels(){let e=this.realms.value;if(!e)return;let t=this;this.channels.innerHTML="",p.emit("realm.announcement.channel.list",e,n=>{n.forEach(r=>{let s=document.createElement("option");s.value=r.chid,s.innerHTML=r.name,t.channels.appendChild(s)})})},show(e,t){this.realms.innerHTML="",this.realms.onchange=()=>this.loadChannels();let n=this;p.emit("realm.announcement.channel.available",r=>{r.forEach(s=>{let i=document.createElement("option");i.value=s,i.innerHTML=E.www.changeChat(s),n.realms.appendChild(i)}),this.loadChannels()}),this.okBtn.onclick=()=>{let r=this.realms.value,s=this.channels.value;r&&s&&(p.emit("realm.announcement.channel.subscribe",e,t,r,s),this.popup.fadeOut())},this.cancelBtn.onclick=()=>{this.popup.fadeOut()},this.popup.fadeIn()}};gr.init();_r=gr;Q.subscribeEventChnl=gr});var Ai={};ae(Ai,{default:()=>fa});var Pi,fa,Fi=b(()=>{T();mn();R();B();re();U();oe();F();qe();W();ee();Jt();vr();j();g("interact/context");Pi={message(e){let t=document.querySelector("#message_context_menu").getAttribute("_id");switch(e){case"copy":let n=document.querySelector("#mess__"+t+" .mess_content").getAttribute("_plain");L.writeToClipboard(n).then(i=>{i&&v.uiMsgT(c.ui.copied)});break;case"edit":De.editMess(t);break;case"delete":De.deleteMess(t);break;case"reply":m.temp.replyId=t,M.replyClose.style.display="block",document.querySelector("#mess__"+t).style.backgroundColor="var(--panel)";break;case"copy_id":L.writeToClipboard(t).then(i=>{i&&v.uiMsgT(c.ui.copied)});break;case"add_reaction":let r=m.chat.chnl;if(r&&!m.realm.chnlPerms[r].react)return v.uiMsgT(c.ui.message.no_react,["!"]);et.emocjiPopup(i=>{i&&p.emit("message.react",m.chat.to,t,i)});break;case"pin":case"unpin":p.emit("message.pin",m.chat.to,m.chat.chnl,t,e==="pin");break;case"create_thread":De.createThread(t);break;default:console.error(e)}},async realm(e){let t=document.querySelector("#realm_context_menu").getAttribute("_id");switch(e){case"copy_id":L.writeToClipboard(t).then(y=>{y&&v.uiMsgT(c.ui.copied)});break;case"copy_invite":let n=location.protocol+"//"+location.host+"/ir?id="+t;L.writeToClipboard(n).then(y=>{y&&v.uiMsgT(c.ui.copied)});break;case"exit":await v.confirm(O(c.ui.confirm.exit_realm,E.www.changeChat(t))+"?")&&(p.emit("realm.exit",t),C.changeChat("main"));break;case"mute":let s=m.realms.find(y=>y.realm==t);if(!s)return;let i=!1,o;s.muted!=null&&(s.muted==-1?i=!1:s.muted==0?i=!0:s.muted>new Date().getTime()?(i=!0,o=new Date(s.muted).toLocaleString()):i=!1);let l=i?c.ui.muted:c.ui.unmuted,d="";if(i){if(s.muted===0)d=c.ui.mute.is_permanent;else if(s.muted>new Date().getTime()){let y=new Date(s.muted).toLocaleString();d=O(c.ui.mute.ends_at,y)}}let u=`
                    ${O(c.ui.mute.realm,E.www.changeChat(t))}
                    <br />
                    ${c.ui.status}: ${l}
                    ${d?"<br />"+d:""}
                `,h=c.ui.durations;v.selectPrompt(u,[h.minutes15,h.hour1,h.day1,h.permanently,c.ui.mute.unmute,c.uni.cancel]).then(y=>{if(!y)return;let _=new Date,w=-1;switch(y){case h.minutes15:_.setMinutes(_.getMinutes()+15),w=_.getTime();break;case h.hour1:_.setHours(_.getHours()+1),w=_.getTime();break;case h.day1:_.setDate(_.getDate()+1),w=_.getTime();break;case h.permanently:w=0;break;case c.ui.mute.unmute:w=-1;break;case c.uni.cancel:return}p.emit("realm.mute",t,w),s.muted=w});break;case"settings":p.emit("realm.settings.get",t);break;default:console.error(e)}},channel(e){let t=document.querySelector("#channel_context_menu").getAttribute("_id");switch(e){case"copy_id":L.writeToClipboard(t).then(r=>{r&&v.uiMsgT(c.ui.copied)});break;case"subscribe":_r.show(m.chat.to,t);break;case"create_thread":De.createThread();break;default:console.error(e)}},async thread(e){let t=document.querySelector("#thread_context_menu").getAttribute("_id");switch(e){case"copy_id":L.writeToClipboard(t).then(i=>{i&&v.uiMsgT(c.ui.copied)});break;case"delete":if(!await v.confirm(c.ui.confirm.delete_thread+"?"))return;let r=m.realm.threads.find(i=>i._id==t);if(!r||m.user._id!==r.author&&!J.isAdmin())return;p.emit("realm.thread.delete",m.chat.to,t),document.querySelector("#channel_\\&"+r._id)?.remove(),document.querySelector("#thread__"+r._id)?.remove(),m.chat.chnl=="&"+r._id&&C.changeChnl(r.thread);break;default:console.error(e)}}};Q.contextFunc=Pi;fa=Pi});var qi={};ae(qi,{default:()=>ha});var Ri,ji,ha,$i=b(()=>{T();U();F();W();ee();j();g("interact/relations");Ri=Ot.makeRealm,ji={async addDm(){let e=await v.prompt(c.ui.enter_dm);e&&p.emit("dm.create",e)},async createRealm(){Ri.fadeOut();let e=await v.prompt(c.ui.create_realm_name);e&&(p.emit("realm.create",e),setTimeout(()=>{p.emit("realm.get")},1500))},async joinRealm(){Ri.fadeOut();let e=await v.prompt(c.ui.enter_realm_invite);e&&(e=e.replace(location.protocol+"//","").replace(location.host,"").replace("/ir?id=",""),p.emit("realm.join",e))}},ha=ji;G.buttonFunc=ji});var ga={};var Ui=b(async()=>{T();ie();B();oe();F();un();j();g("start");x.init();await E.app.init();C.changeChat("main");await $s();p.connect();setTimeout(async()=>{await ct.handleGetParam(),ct.removeControlParams()},3e3);setTimeout(async()=>{let e=Mr(),t=Er(),n=Tr().length,r=wr().length;x.msg(1,`Loaded ${n}/${r} (${Math.round(n/r*100)}%) modules.`),e.length>0&&x.msg(2,"Unexpected modules:",e),t.length>0&&x.msg(2,"Unregistered modules:",t)},1e3)});var _a={};var Oi=b(()=>{T();ie();j();g("warning");(function(){if(x.isDebug)return;let e=c.common.console_warning;["60px;color:gold","20px","20px;color:red","20px"].forEach((n,r)=>{console.log(`%c${e["w"+(r+1)]}`,`font-size:${n}`)})})()});await Promise.resolve().then(()=>(Lr(),Bi));await Promise.resolve().then(()=>(R(),Cr));await Promise.resolve().then(()=>(W(),Sr));await Promise.resolve().then(()=>(F(),Hr));await Promise.resolve().then(()=>(oi(),Jo));await Promise.resolve().then(()=>(bt(),Is));await Promise.resolve().then(()=>(ai(),Go));await Promise.resolve().then(()=>(li(),ea));await Promise.resolve().then(()=>(ui(),na));await Promise.resolve().then(()=>(yn(),Fr));await Promise.resolve().then(()=>(en(),ls));await Promise.resolve().then(()=>(Hi(),Ii));await Promise.resolve().then(()=>(Fi(),Ai));await Promise.resolve().then(()=>(Dn(),as));await Promise.resolve().then(()=>($i(),qi));await Promise.resolve().then(()=>(Sn(),Zr));await Promise.resolve().then(()=>(vr(),Di));await Ui().then(()=>ga);await Promise.resolve().then(()=>(Oi(),_a));
//# sourceMappingURL=startApp.js.map
