var gr=Object.defineProperty;var a=(e,t)=>gr(e,"name",{value:t,configurable:!0});var b=(e,t)=>()=>(e&&(t=e(e=0)),t);var le=(e,t)=>{for(var n in t)gr(e,n,{get:t[n],enumerable:!0})};var _r,ke,mt=b(()=>{globalThis.lo=console.log;globalThis.delay=e=>new Promise(t=>setTimeout(t,e));_r={proto:{html(e){return e!==void 0?(this.innerHTML=e,this):this.innerHTML},v(e){return e!==void 0?(this.value=e,this):this.value},on(e,t){this.addEventListener(e,t)},css(e,t=null){typeof e=="string"?t!==null?this.style[e]=t:this.style.cssText=e:Object.assign(this.style,e)},attrib(e,t=null){return t!==null?(this.setAttribute(e,t),this):this.getAttribute(e)||""},clA(e){return this.classList.add(e),this},clR(e){return this.classList.remove(e),this},clT(e){return this.classList.toggle(e),this},animateFade(e,t={}){let{time:n=200,cb:r}=t,s=this.style,i=50,o=n/i,l=(e===0?1:-1)/i,u=0;s.opacity=e.toString();let d=setInterval(()=>{if(u>=i){clearInterval(d),r?.();return}s.opacity=(parseFloat(s.opacity||"0")+l).toString(),u++},o);return this},fadeIn(e="block",t){return typeof e=="function"&&(t=e,e="block"),this.css("display",e),this.animateFade(0,{cb:t}),this.fade=!0,this},fadeOut(e){return this.animateFade(1,{time:300,cb:e}),setTimeout(()=>this.css("display","none"),300),this.fade=!1,this},fadeToggle(){return this.fade?this.fadeOut():this.fadeIn(),this},add(e){return this.appendChild(e),this},addUp(e){return this.insertBefore(e,this.firstChild),this},fade:!0},init(){Object.assign(HTMLElement.prototype,this.proto)},rand(e,t){return Math.round(Math.random()*(t-e)+e)},round(e,t){let n=Math.pow(10,t);return Math.round(e*n)/n},get(e){if(!e)return"";let t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),t.status===200?t.responseText:(t.status===404,"")}};_r.init();ke=_r});var hn,Lt,g,vr,yr,br,Er,T=b(()=>{hn=["apis","file","warning","cacheControllers/socketGeneral","mess/format/embed","mess/format/list","mess/format/media","mess/format/respone","mess/format/table","mess/format/text","mess/cmd","mess/format","mess/interact","mess/listeners","mess","mess/socket","mess/style","socket/_evt","socket/evt","socket/mess","socket/engine","socket","coreFunc","debug","features","init","start","contextMenuLib","swipeLib","components/contextMenu","components/emoji","components/mainView","components/media","components/voice","helpers/reloadImages","helpers/stateManager","helpers/uiFunc","interact/context","interact/mainView","interact/relations","interact/subscribeEventChnl","interact/ui","render/dm","render/event","render/realm","render/realmInit","render/user","render/utils","render/var","realmSettings","rs/channels","rs/emoji","rs/meta","rs/nav","rs/roles","rs/save","rs/users","rs/utils","rs/var","rs/webhooks","settings","settingsData","settingsLib","genId","perm","translate","utils","var/api","var/html","var/keys","var/staticData","var"],Lt=[],g=a(e=>{Lt.includes(e)||Lt.push(e)},"default"),vr=a(()=>hn.filter(e=>!Lt.includes(e)),"reqButNotReg"),yr=a(()=>Lt.filter(e=>!hn.includes(e)),"regButNotReq"),br=a(()=>hn,"getReq"),Er=a(()=>Lt,"getReg")});var Ai={};var Mr=b(()=>{mt();T();g("init");localStorage.getItem("token")||(window.location.href="/login");document.querySelectorAll("[loadInner]").forEach(e=>{e.innerHTML=ke.get(e.getAttribute("loadInner"))});document.querySelectorAll(".delete").forEach(e=>{let t=parseInt(e.getAttribute("time"));setTimeout(()=>e.remove(),t)})});var re,Y,Q=b(()=>{re={},Y={};window.mglInt=re;window.mglVar=Y});var Tr={};le(Tr,{default:()=>m,getEmptyRealmConfig:()=>Rt});function Rt(){return{users:[],roles:[],permission:0,text:[],desc:{},chnlPerms:{},threads:[]}}var wr,m,$=b(()=>{T();Q();g("var");wr={user:{_id:localStorage.getItem("user_id"),fr:localStorage.getItem("from"),status:"online",statusText:""},chat:{to:"main",chnl:"main",actMess:0,pinned:[],selectedMess:null},temp:{scrollBlock:!1,replyId:null,editId:null},privs:[],realms:[],realm:Rt(),mainView:{friends:[],requests:[],page:"online"},settings:{notifications:localStorage.getItem("notifications")=="true"||!1,desktopHandling:localStorage.getItem("desktopHandling")=="true"||!1},blocked:[]},m=wr;Y.vars=wr;a(Rt,"getEmptyRealmConfig")});var kr={};le(kr,{coreHTML:()=>$t,emojiHTML:()=>ee,mainViewHTML:()=>q,messHTML:()=>M,mglHTML:()=>Lr,navHTML:()=>H,otherHTML:()=>qt,renderHTML:()=>G,voiceHTML:()=>ge});function k(e,t){return(t||document).querySelector(e)}function Fi(){let e=k("#messages_nav");return{div:k("#messages"),input:document.querySelector("#mess-input"),replyClose:k("#replyClose"),editClose:k("#editClose"),sendBtn:document.querySelector("#barc__sendBtn"),linkClick:k("#linkClick"),nav:e,nav_priv:k("#messages_nav__priv",e),nav_realm:k("#messages_nav__realm",e),sendBtnImg:document.querySelector("#barc__sendBtn__img"),bar:k("#bar"),barc__commads:k("#barc__commads")}}function Pi(){return{nav:k("#navs"),priv:k("#navs__priv"),realm:k("#navs__realm"),main:k("#navs__main"),realms:k("#navs__realms"),main__call:k("#navs__main__call"),navs__user:k("#navs__user"),user__name:k("#navs__user__name"),user__status:k("#navs__user__status"),realm__name:k("#navs__realm__name"),realm__panel:k("#navs__realm__panel"),realm__channels:k("#navs__realm__channels"),realm__users:k("#navs__realms__users")}}function ji(){return{messages_nav__realm__description:k("#messages_nav__realm__description")}}function Ri(){let e=k("#realmEvents");return{navs__priv:k("#navs__priv"),realms__content:k("#realms__content"),userProfile:k("#userProfile"),events:e,events__container:k("#realmEvents__container",e),events__add:k("#realmEvents__add",e)}}function $i(){let e=k("#main__view");return{div:e,nav:k("#main__view__nav"),friends:k("#main__view__friends",e),requests:k("#main__view__requests",e),requestCount:k("#main__view__requests__count",e),noFriends:k("#main__view__noFriends",e),noRequests:k("#main__view__noRequests",e),friendsContainer:k("#main__view__friends_container",e),requestsContainer:k("#main__view__requests_container",e)}}function qi(){return{makeRealm:k("#makeRealm")}}function Ui(){return{div:k("#voice_call"),mediaContainer:k("#voice_call_media"),users:k("#voice_call_users"),muteMic:k("#voice_call_mute_mic"),voiceShow:k("#realms__voice_show")}}function Oi(){return{div:k("#emojiDiv"),input:document.querySelector("#emocji-input"),container:k("#emoji__container"),nav:k("#emoji__nav")}}var M,H,$t,G,q,qt,ge,ee,Lr,K=b(()=>{T();g("var/html");a(k,"qd");a(Fi,"mess");a(Pi,"nav");a(ji,"core");a(Ri,"render");a($i,"mainView");a(qi,"other");a(Ui,"voice");a(Oi,"emoji");M=Fi(),H=Pi(),$t=ji(),G=Ri(),q=$i(),qt=qi(),ge=Ui(),ee=Oi(),Lr={mess:M,nav:H,core:$t,render:G,mainView:q,other:qt,voice:ge,emoji:ee};window.mglHTML=Lr});var xr={};le(xr,{default:()=>p});var Cr,p,P=b(()=>{T();Q();g("socket");Cr=io("/",{transports:["websocket"],auth:{token:localStorage.getItem("token")},autoConnect:!1,reconnection:!0,reconnectionDelay:1e3,reconnectionDelayMax:5e3,reconnectionAttempts:1/0}),p=Cr;Y.socket=Cr});var Vi,te,Ne=b(()=>{T();$();g("perm");Vi={hasAllPermissions(e,t){return t.every(n=>(e&n)!==0)},hasAnyPermission(e,t){return t.some(n=>(e&n)!==0)},canAction(e){let t=m.realm.permission||0;return Array.isArray(e)||(e=[e]),this.hasPermission(t,1)||this.hasAnyPermission(t,e)},isAdmin(){return this.hasPermission(m.realm.permission||0,1)},hasPermission(e,t){return(e&t)!==0}},te=Vi});var Sr,D,Ee=b(()=>{T();Q();g("var/api");Sr={temp:{user:{main:{}},realm:{}},user_state:{},lastMess:{}},D=Sr;Y.apiVars=Sr});function Ir(e){ue=e}var We,ze,ue,O,Ut,_n=b(()=>{T();Ke();$();se();P();K();j();V();Ne();Ee();g("mess/cmd");We=M.barc__commads;We.style.display="none";ze={system:{silent:{args:[{name:"silent",type:"boolean"},{name:"message",type:"text"}],exe(e,t){if(t.length==0)return 1;t[0]&&(e.silent=!0),e.msg=t[1]}},search:{args:[{name:"from",type:"user",optional:!0},{name:"mentions",type:"text",optional:!0},{name:"before",type:"date",optional:!0},{name:"during",type:"date",optional:!0},{name:"after",type:"date",optional:!0},{name:"pinned",type:"boolean",optional:!0},{name:"message",type:"text",optional:!0}],exe(e,t){if(t.length==0)return 1;let n={from:t[0],mentions:t[1],before:t[2],during:t[3],after:t[4],pinned:t[5],message:t[6]};return p.emit("message.search",m.chat.to,m.chat.chnl,n),1}},createLinkEmbed:{args:[{name:"url",type:"text"}],exe(e,t){return t.length==0||p.emit("send.embed.og",m.chat.to,m.chat.chnl,t[0]),1}},createDataEmbed:{args:[{name:"title",type:"text"},{name:"description",type:"text",optional:!0},{name:"url",type:"text",optional:!0},{name:"image",type:"text",optional:!0},{name:"custom fields",type:"map",optional:!0}],exe(e,t){if(t.length==0)return 1;let n={title:t[0],description:t[1],url:t[2],image:t[3],customFields:t[4]};return p.emit("send.embed.data",m.chat.to,m.chat.chnl,n),1}},clear:{args:[{name:"delete",type:"number"}],exe(e,t){if(t.length==0)return 1;let n=!1;if(m.chat.to.startsWith("$"))n=!1;else{if(m.chat.to=="main")return 1;if(!m.realm)return 1;n=te.canAction(2)}let r=Array.from(document.querySelectorAll(".mess_message")).slice(-t[0]).map(s=>{let i=s.id.replace("mess__","");return s.querySelector(".mess_meta").getAttribute("_author")==m.user._id||n?i:null}).filter(s=>s);return p.emit("messages.delete",m.chat.to,r),1}}}};Object.keys(ze).forEach(e=>{Object.keys(ze[e]).forEach(t=>{ze[e][t].name=t})});ue=null;a(Ir,"setCurrentCmd");O={temp:[],check(){let e=M.input.value;if(ue){(!e.trim()||e=="/")&&O.close();return}if(!e.startsWith("/")&&e!="/"){We.style.display="none";return}if(e.split(`
`).length>1)return O.close();We.style.display="",We.innerHTML="";let t=e.trim().split(" ")[0].substring(1),n={};Object.keys(ze).forEach(i=>{Object.keys(ze[i]).forEach(o=>{(o.startsWith(t)||t=="")&&(n[i]||(n[i]={}),n[i][o]=ze[i][o])})});let r=[],s=[];if(Object.keys(n).forEach(i=>{Object.keys(n[i]).forEach(o=>{r.push(n[i][o]),s.push({c:i,name:o})})}),r.length==0){We.innerHTML="<h2>No commands</h2>",ue=null;return}if(r.length==1){ue=r[0];let{name:i}=s[0],o=e.split(" ");o[0]="/"+i,M.input.value=o.join(" ")+" ",O.handleCommandInput(),setTimeout(()=>{F.setSelectionStart()},100),C.focusInp();return}ue=null,Object.keys(n).forEach(i=>{let o=document.createElement("div");o.innerHTML=`<h2>${i}</h2>`;let l=document.createElement("ul");o.appendChild(l),Object.keys(n[i]).forEach(d=>{let h=document.createElement("li");h.innerHTML=d,h.style.cursor="pointer",h.tabIndex=0,h.addEventListener("click",f),h.addEventListener("keydown",v=>{v.key=="Enter"&&f()}),l.appendChild(h);function f(){ue=n[i][d];let v=e.split(" ");v[0]="/"+d,M.input.value=v.join(" ")+" ",O.handleCommandInput(),setTimeout(()=>{F.setSelectionStart()},100),C.focusInp()}a(f,"selectCmd")});function u(d){d.key==="Tab"&&(d.preventDefault(),l.querySelector("li")?.focus(),document.removeEventListener("keydown",u))}a(u,"tab"),document.addEventListener("keydown",u),We.appendChild(o)})},close(){ue=null,We.style.display="none",M.input.value="",O.temp=[]},send(e){if(!ue)return this.close(),0;if(!this.checkArgs())return 2;this.changeArgs();let n=O.temp,r=ue.exe(e,n)||0;return this.close(),r},checkArgs(){let e=O.temp,t=ue.args;for(let n=0;n<t.length;n++){let r=t[n],s=e[n];if(r.type!="map"){if(!s||s.trim()==""){if(r.optional)continue;return!1}}else if(Object.keys(s).length==0){if(r.optional)continue;return!1}if(r.type=="boolean"&&s!="true"&&s!="false")return!1;if(r.type=="number"&&isNaN(s))return!1;if(r.type=="text"&&s.trim()=="")return!1;if(r.type=="user"&&s.trim()=="")return!1;if((r.type=="date"||r.type=="date-time")&&isNaN(Date.parse(s)))return!1;if(r.type=="time"){let[i,o]=s.split(":");if(isNaN(i)||isNaN(o))return!1}else{if(r.type=="list"&&!r.list.includes(s))return!1;if(r.type=="map"&&Object.keys(s).length==0)return!1}}return!0},changeArgs(){let e=O.temp,t=ue.args;for(let n=0;n<t.length;n++){let r=t[n],s=e[n];if(!s||r.type!="map"&&s.trim()==""){if(r.optional)continue;return!1}if(r.type=="boolean")e[n]=s=="true";else if(r.type=="number")e[n]=Number(s);else if(r.type=="user"){if(s.split("-").length==0)continue;let i=D.temp.user,o=new Map;if(Object.keys(i).forEach(l=>{o.set(i[l],l)}),!o.has(s)){y.uiMsgT(c.ui.message.user_not_found),delete e[n];continue}e[n]=o.get(s)}else if(r.type=="map"){if(Object.keys(s).length==0){e[n]={};continue}let i={};Object.keys(s).forEach(o=>{let l=s[o];!l.key||!l.value||(i[l.key]=l.value)}),e[n]=i}}},handleCommandInput(){if(!ue)return;let e=We,t=document.createElement("div");t.innerHTML="<h2>"+c.ui.message.command+" ("+ue.name+")</h2>";let n=document.createElement("ul"),r=ue.args;O.temp=new Array(r.length);let s=null,i=document.createElement("ul");r.forEach((l,u)=>{let d=document.createElement("li");d.innerHTML=l.name;let h="",f;switch(l.type){case"boolean":h="true/false",f=document.createElement("select"),["false","true"].forEach(w=>{let I=document.createElement("option");I.value=w,I.text=w,f.appendChild(I)}),f.value="false",O.temp[u]="false",f.addEventListener("change",()=>{O.temp[u]=f.value==="true"?"true":"false"});break;case"number":h="number",f=document.createElement("input"),f.type="number",f.addEventListener("input",()=>{O.temp[u]=f.value});break;case"text":h="text",f=document.createElement("input"),f.type="text",f.addEventListener("input",()=>{O.temp[u]=f.value});break;case"user":h="text",f=document.createElement("input"),f.type="text",f.addEventListener("input",()=>{O.temp[u]=f.value});break;case"date":h="date",f=document.createElement("input"),f.type="date",f.addEventListener("input",()=>{O.temp[u]=f.value});break;case"time":h="time",f=document.createElement("input"),f.type="time",f.addEventListener("input",()=>{O.temp[u]=f.value});break;case"date-time":h="date-time",f=document.createElement("input"),f.type="datetime-local",f.addEventListener("input",()=>{O.temp[u]=f.value});break;case"list":let v=l;h="list",f=document.createElement("select"),v.list.forEach(w=>{let I=document.createElement("option");I.value=w,I.text=w,f.appendChild(I)}),f.value=v.list[0],O.temp[u]=v.list[0],f.addEventListener("change",()=>{O.temp[u]=f.value});break;case"map":h="map",f=document.createElement("div"),O.temp[u]={};let _=document.createElement("button");_.innerHTML="Create Map",_.style.marginTop="5px",f.appendChild(_),f.appendChild(document.createElement("br")),_.addEventListener("click",()=>{let w=document.createElement("input"),I=document.createElement("input"),J=document.createElement("span");f.appendChild(w),f.appendChild(J),f.appendChild(I),f.appendChild(document.createElement("br")),w.style.marginTop="5px",J.innerHTML=": ";let he=Object.keys(O.temp[u]).length;O.temp[u][he]={},w.addEventListener("input",()=>{O.temp[u][he].key=w.value}),I.addEventListener("input",()=>{O.temp[u][he].value=I.value})});break}d.innerHTML+=` (${h})${l.optional?" (optional)":""} &nbsp;`,f&&d.appendChild(f),!s&&f&&(s=f),i.appendChild(d)}),n.appendChild(i);function o(){s&&(s.focus(),document.removeEventListener("keydown",o))}a(o,"tab"),document.addEventListener("keydown",o),t.appendChild(n),e.innerHTML="",e.appendChild(t)}};M.input.addEventListener("input",O.check);Ut=O});var Dr={};le(Dr,{MediaPopup:()=>Ot,default:()=>Vt});function Hr(e,t={}){return new Ot(Bi,e,t)}var Bi,Ot,Vt,vn=b(()=>{T();j();Q();g("components/media");Bi=document.querySelector("#mediaPopup"),Ot=class{static{a(this,"MediaPopup")}container;url;options;state;overlay;content;media;controlsResets=[];constructor(t,n,r){this.container=t,this.url=n,this.options={maxScale:r.maxScale||10,minScale:r.minScale||.1,scaleStep:r.scaleStep||.1,rotationStep:r.rotationStep||15,doubleTapDelay:r.doubleTapDelay||300,isVideo:"auto",...r},this.state={scale:1,rotation:0,position:{x:0,y:0},brightness:100,contrast:100,saturation:100,blur:0,isDragging:!1,dragStart:{x:0,y:0},lastTap:0,lastTapPosition:{x:0,y:0},initialPinchDistance:null,initialRotation:null,previousTouches:null,isAnimating:!1},this.init()}init(){this.overlay=document.createElement("div"),this.overlay.className="media-popup-overlay",this.overlay.fadeIn(""),this.content=document.createElement("div"),this.content.className="media-popup-content";let t=this.options.isVideo;t==="auto"&&(t=/\.(mp4|webm|ogg|mkv|webm|avi)$/i.test(this.url)),this.media=document.createElement(t?"video":"img"),this.media.className="media-popup-media",this.media.src=this.url,t&&(this.media.controls=!0);let n=document.createElement("div");n.className="media-popup-controls",this.controlsResets=[];let r=c.media;this.addControlGroup(n,[{icon:r.zoom+"+",action:a(()=>this.zoom(1+this.options.scaleStep),"action"),title:r.zoom_in},{icon:r.zoom+"-",action:a(()=>this.zoom(1-this.options.scaleStep),"action"),title:r.zoom_out},{icon:r.rotate+" <",action:a(()=>this.rotate(-this.options.rotationStep),"action"),title:r.rotate_left},{icon:r.rotate+" >",action:a(()=>this.rotate(this.options.rotationStep),"action"),title:r.rotate_right},{icon:r.flip,action:a(()=>this.flip(),"action"),title:r.flip},{icon:r.reset,action:a(()=>this.resetTransforms(),"action"),title:r.reset_transforms},{icon:"\u2716",action:a(()=>this.close(),"action"),title:c.uni.close}]),n.appendChild(document.createElement("br"));let s=document.createElement("div");s.className="media-popup-sliders",this.addSlider(s,"brightness",r.brightness,0,200),this.addSlider(s,"contrast",r.contrast,0,200),this.addSlider(s,"saturation",r.saturation,0,200),this.addSlider(s,"blur",r.blur,0,10),n.appendChild(s),this.content.appendChild(this.media),this.overlay.appendChild(this.content),this.overlay.appendChild(n),this.container.appendChild(this.overlay),this.setupEventListeners(),this.updateTransform()}addControlGroup(t,n){let r=document.createElement("div");r.className="media-popup-control-group",n.forEach(s=>{let i=document.createElement("button");i.className="media-popup-btn",i.textContent=s.icon,i.title=s.title,i.onclick=s.action,r.appendChild(i)}),t.appendChild(r)}addSlider(t,n,r,s,i){let o=document.createElement("div");o.className="media-popup-slider-container";let l=document.createElement("span");l.textContent=r;let u=document.createElement("input");u.type="range",u.className="media-popup-slider",u.min=s.toString(),u.max=i.toString();let d=this.state[n]??100;u.value=d,this.controlsResets.push(()=>u.value=d);let h=document.createElement("span");h.className="media-popup-value",h.textContent=u.value,u.addEventListener("input",f=>{let v=f.target;this.state[n]=v.value,h.textContent=v.value,this.updateFilters()}),o.appendChild(l),o.appendChild(u),o.appendChild(h),t.appendChild(o)}setupEventListeners(){this.content.addEventListener("wheel",t=>{t.preventDefault();let n=t.deltaY>0?-this.options.scaleStep:this.options.scaleStep;this.zoom(1+n)}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.close(),t.key==="+"&&this.zoom(1+this.options.scaleStep),t.key==="-"&&this.zoom(1-this.options.scaleStep),t.key==="ArrowLeft"&&this.rotate(-this.options.rotationStep),t.key==="ArrowRight"&&this.rotate(this.options.rotationStep)}),this.media.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.media.addEventListener("touchstart",this.handleTouchStart.bind(this),{passive:!1}),this.media.addEventListener("touchmove",this.handleTouchMove.bind(this),{passive:!1}),this.media.addEventListener("touchend",this.handleTouchEnd.bind(this)),this.media.addEventListener("touchcancel",this.handleTouchEnd.bind(this))}handleMouseDown(t){t.preventDefault(),this.state.isDragging=!0,this.state.dragStart={x:t.clientX-this.state.position.x,y:t.clientY-this.state.position.y}}handleMouseMove(t){this.state.isDragging&&(this.state.position={x:t.clientX-this.state.dragStart.x,y:t.clientY-this.state.dragStart.y},this.updateTransform())}handleMouseUp(){this.state.isDragging=!1}handleTouchStart(t){t.preventDefault();let n=t.touches;if(this.state.previousTouches=Array.from(n).map(r=>({identifier:r.identifier,pageX:r.pageX,pageY:r.pageY})),n.length===1){let r=n[0],s=Date.now(),i=this.state.lastTap,o=this.state.lastTapPosition;s-i<this.options.doubleTapDelay&&this.getDistance({x:r.pageX,y:r.pageY},o)<30&&this.handleDoubleTap(r),this.state.lastTap=s,this.state.lastTapPosition={x:r.pageX,y:r.pageY},this.startDrag(r)}else n.length===2&&(this.state.initialPinchDistance=this.getPinchDistance(n),this.state.initialRotation=this.getRotationAngle(n),this.state.isDragging=!1)}handleTouchMove(t){t.preventDefault();let n=t.touches;if(this.state.previousTouches){if(n.length===1&&this.state.isDragging)this.drag(n[0]);else if(n.length===2){let r=this.getPinchDistance(n),s=this.getRotationAngle(n);if(this.state.initialPinchDistance>0){let i=r/this.state.initialPinchDistance;this.handlePinch(i)}if(this.state.initialRotation!==null){let i=s-this.state.initialRotation;this.handleRotation(i)}this.state.previousTouches=Array.from(n).map(i=>({identifier:i.identifier,pageX:i.pageX,pageY:i.pageY}))}}}handleTouchEnd(t){t.preventDefault(),t.touches.length===0&&(this.state.isDragging=!1,this.state.initialPinchDistance=null,this.state.initialRotation=null,this.state.previousTouches=null)}handleDoubleTap(t){let n=this.state.scale>1?1:2;this.zoom(n,t.pageX,t.pageY)}startDrag(t){this.state.isDragging=!0,this.state.dragStart={x:t.pageX-this.state.position.x,y:t.pageY-this.state.position.y}}drag(t){this.state.position={x:t.pageX-this.state.dragStart.x,y:t.pageY-this.state.dragStart.y},this.updateTransform()}handlePinch(t){this.zoom(t)}handleRotation(t){this.state.rotation=t,this.updateTransform()}zoom(t,n=void 0,r=void 0){let s=this.state.scale*t;s<this.options.minScale||s>this.options.maxScale||(n!==void 0&&r!==void 0&&(this.state.position.x+=(this.media.clientWidth/2-n)*(1-t),this.state.position.y+=(this.media.clientHeight/2-r)*(1-t)),this.state.scale=s,this.updateTransform())}rotate(t){this.state.rotation+=t,this.updateTransform()}flip(){this.state.rotation+=180,this.updateTransform()}resetTransforms(){this.state={...this.state,scale:1,rotation:0,position:{x:0,y:0},brightness:100,contrast:100,saturation:100,blur:0},this.updateFilters(),this.updateTransform(),this.controlsResets.forEach(t=>t())}updateTransform(){this.media.style.transform=`
        translate(${this.state.position.x}px, ${this.state.position.y}px)
        scale(${this.state.scale})
        rotate(${this.state.rotation}deg)
      `}updateFilters(){this.media.style.filter=`
        brightness(${this.state.brightness}%)
        contrast(${this.state.contrast}%)
        saturate(${this.state.saturation}%)
        blur(${this.state.blur}px)
      `}close(){let t=this;this.overlay.fadeOut(()=>t.container.removeChild(t.overlay))}getPinchDistance(t){let n=t[0].pageX-t[1].pageX,r=t[0].pageY-t[1].pageY;return Math.sqrt(n*n+r*r)}getRotationAngle(t){return Math.atan2(t[1].pageY-t[0].pageY,t[1].pageX-t[0].pageX)*(180/Math.PI)}getDistance(t,n){return Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2))}};a(Hr,"createMediaPopup");Vt=Hr;re.createMediaPopup=Hr});function yn(e){if(!e)return;function t(n){let r=new XMLHttpRequest;return r.open("HEAD",n,!1),r.send(),r.status==200}if(a(t,"check"),/\.(mp3|wav|ogg|.m4a)$/i.test(e)){if(!t(e))return;let n=document.createElement("audio");return n.src=e,n.controls=!0,n}if(/\.(mp4|mkv|webm|avi)$/i.test(e)){if(!t(e))return;let n=document.createElement("video");return n.src=e,n.controls=!0,n.style.maxWidth="65%",n.style.height="auto",n.style.borderRadius="2rem",n.style.cursor="zoom-in",n.onclick=()=>Vt(e,{isVideo:!0}),n}if(/\.(png|jpg|gif|ico|jpeg|webp|svg)$/i.test(e)){if(!t(e))return;let n=document.createElement("img");return n.src=e,n.style.maxWidth="100%",n.style.height="auto",n.style.cursor="zoom-in",n.onclick=()=>Vt(e,{isVideo:!1}),n}if(e.includes("youtube.com")||e.includes("youtu.be")){let n=function(i){let o=i.match(/(?:\?v=|\/embed\/|\.be\/|\/v\/|\/\d{1,2}\/|\/e\/|watch\?v=|youtu\.be\/|youtube\.com\/(?:v|e|embed)\/|youtube\.com\/user\/[^#\/]+#p\/[^#\/]+\/)([^"&?\/ ]{11})/);return o&&o[1]?o[1]:null};a(n,"extractYouTubeVideoId");let r=n(e),s=document.createElement("iframe");return s.src=`https://www.youtube.com/embed/${r}`,s.allowFullscreen=!0,s.style.maxWidth="100%",s.style.width="500px",s.style.height="300px",s.style.borderRadius="2rem",s}if(e.includes("tiktok.com")){let r=function(i){let o=/tiktok\.com\/(?:@[\w.-]+\/video\/|v\/|embed\/v2\/)([\w-]+)/,l=i.match(o);return l?l[1]:null};a(r,"extractTikTokVideoId");let n=document.createElement("iframe"),s=r(e);return n.src=`https://www.tiktok.com/embed/v2/${s}`,n.allowFullscreen=!0,n.style.maxWidth="100%",n.style.width="400px",n.style.height="700px",n.style.borderRadius="2rem",n}if(e.includes("reddit.com")){e=(e.split("?")||[e])[0],e.endsWith("/")||(e+="/");let s=JSON.parse(ke.get(`${e}.json?limit=2`))[0]?.data.children[0]?.data,i=document.createElement("div"),o=s.title,l=s.author;return i.innerHTML=`autor: ${l}<br />tytu\u0142: ${o}`,i}if(e.includes("spotify.com")){let r=function(i){let o=i.match(/track\/([a-zA-Z0-9]+)/);if(o&&o[1])return"track/"+o[1];let l=i.match(/playlist\/([a-zA-Z0-9]+)/);return l&&l[1]?"playlist/"+l[1]:null};a(r,"extractSpotifyId");let n=document.createElement("iframe"),s=r(e);return s?(n.src=`https://open.spotify.com/embed/${s}`,n.allowFullscreen=!0,n.style.maxWidth="100%",n.style.width="400px",n.style.height="84px",n.style.borderRadius="1rem",n):null}}var Ar=b(()=>{mt();T();vn();g("mess/format/media");a(yn,"format_media")});var Bt,Fr,Pr=b(()=>{T();g("mess/format/list");Bt={calculateLevels(e){let t=[],n=null;return e.forEach((r,s)=>{if(r.trim()===""){t.push({line:r,lvl:0});return}let o=r.length-r.trimStart().length;if(n===null&&s>0&&o>0){let l=e[s-1].length-e[s-1].trimStart().length;o>l&&(n=o-l)}if(n!==null&&o%n!==0){let l=Math.round(o/n)*n;t.push({line:r,lvl:l/n})}else{let l=n?o/n:o>0?1:0;t.push({line:r,lvl:l})}}),t},buildTree(e){let t=/^(?:[-*]|\d+[.)]?|[a-zA-Z][.)])\s/,n=[],r=[{children:n,lvl:-1}];function s(i){let o=i.trim();return/^[-*]\s/.test(o)?"bullet":/^\d[.)]?\s/.test(o)?"decimal":/^[a-z][.)]?\s/.test(o)?"lower-alpha":/^[A-Z][.)]?\s/.test(o)?"upper-alpha":null}return a(s,"getBulletType"),e.forEach(({line:i,lvl:o})=>{let l=i.trim(),d=t.test(l)?s(l):null,h={line:i,children:[],bulletType:d};for(;r.length>0&&r[r.length-1].lvl>=o;)r.pop();r[r.length-1].children.push(h),r.push({...h,lvl:o})}),n},treeToHtml(e,t,n){let r="",s=["decimal","lower-alpha","upper-alpha","lower-roman","upper-roman"],i=!0;function o(l,u=0){if(l.bulletType===null)r+=l.line.trim()+"<br />",i=!0;else{let d=s.includes(l.bulletType)?"ol":"ul",[,...h]=l.line.trim().split(/\s+/);i&&(r+=`<${d} style="list-style-type: ${l.bulletType};">`),r+=`<li style="margin-left: ${t*(u+1)}${n}; list-style-type: ${l.bulletType};">${h}</li>`,l.children.length>0&&(i=!0,l.children.forEach(f=>{o(f,u+1)}),i=!1),i&&(r+=`</${d}>`),i=!1}}return a(o,"processNode"),e.forEach(l=>{o(l)}),r},cpu(e,t=0,n=""){let r=e.split(/\n|\<br\>|\<br\/\>|\<br \/>/),s=Bt.calculateLevels(r),i=Bt.buildTree(s);return Bt.treeToHtml(i,t,n).replace(/<br\s*\/?>\s*$/i,"")}},Fr=Bt});function bn(e){let t=e.trim().split(`
`),n='<div class="table_wrap"><table>';return t.forEach((r,s)=>{let i=r.split("|").map(o=>o.trim()).filter(o=>o);s===0?(n+="<thead><tr>",i.forEach(o=>{n+=`<th>${o}</th>`}),n+="</tr></thead><tbody>"):(n+="<tr>",i.forEach(o=>{n+=`<td>${o}</td>`}),n+="</tr>")}),n+="</tbody></table></div>",n}var jr=b(()=>{T();g("mess/format/table");a(bn,"format_wrapTable")});function En(e){e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;");let t=/\`\`\`(.*?)\`\`\`/gs,n=e.match(t),r=[];if(n)for(let s of n){let i=s.slice(3,-3);r.push(i);let o=`@EXCLUSION${r.length}@`;e=e.replace(s,o)}e=e.replace(/((?:^\|.*\|$\n?)+)/gm,s=>bn(s)),e=Nt(e,"**","b"),e=Nt(e,"//","i"),e=Nt(e,"--","strike"),e=Nt(e,"__","u"),e=e.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" onclick="mglInt.mess.linkClick(event)">$1</a>').replace(/(\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b)/g,'<a href="mailto:$1">$1</a>').replace(/##([0-9A-Fa-f]{3,6})\s(.*?)\s#c/g,'<span style="color:#$1">$2</span>').replace(/#([a-zA-Z]+)\s(.*?)\s#c/g,'<span style="color:$1">$2</span>').replace(/#(fc)\s(.*?)\s#c/gi,'<span style="color:var(--accent)">$2</span>').replace(/(?:&lt;|<)\!\s*(.*?)\s*!(?:&gt;|>)/g,'<span class="spoiler" onclick="mglInt.mess.spoiler(event)">$1</span>').replaceAll(`
`,"<br />").replaceAll("\\n","<br />").replace(/(?<=^|\s)---(?=\s|$)/g,"<hr />"),e=Fr.cpu(e,1,"rem");for(let s=0;s<r.length;s++){let i=`<pre>${r[s]}</pre>`,o=`@EXCLUSION${s+1}@`;e=e.replace(o,i)}return e=e.replace(/:([a-z0-9]+-[a-z0-9]+-[a-z0-9]+):/g,(s,i)=>`<img src="/userFiles/realms/${m.chat.to}/emojis/${i}.png" class="message_emoji" alt=":${i}:">`),e}function Nt(e,t,n){let r="",s=!1,i="";for(let o=0;o<e.length;o++)e.slice(o,o+t.length)===t?(s?(i.trim()===""||i.startsWith(" ")||i.endsWith(" ")?r+=t+i+t:r+=`<${n}>${i}</${n}>`,i="",s=!1):(i===""?s=!0:r+=i,i=""),o+=t.length-1):s?i+=e[o]:r+=e[o];return s&&(r+=t+i),r}var Rr=b(()=>{T();$();Pr();jr();g("mess/format/text");a(En,"format_text");a(Nt,"markCpu")});function Ni(e,t){let n=/^[\p{Extended_Pictographic}]+$/u.test(e),r=/^(:[a-z0-9]+-[a-z0-9]+-[a-z0-9]+:)+$/g.test(e);return r&&t.querySelectorAll("img").forEach(s=>{function i(){s.removeEventListener("error",i),t.clR("mess__text__emoji")}a(i,"notLoaded"),s.addEventListener("error",i)}),n||r}var $r,Ze,Wt=b(()=>{T();Ar();Rr();g("mess/format");$r={formatMess(e,t){let n=En(e);t.innerHTML=n;let r=$r.getElements(e);for(let s of r)t.appendChild(document.createElement("br")),t.appendChild(s);Ni(e,t)&&t.classList.add("mess__text__emoji")},getElements(e){let t=/(https?:\/\/[^\s]+)/g,n=e.match(t);return n?n.map(r=>yn(r)).filter(r=>!!r):[]}};a(Ni,"isEmojiMessage");Ze=$r});var zt,Xe,kt=b(()=>{T();V();ie();j();g("file");zt={read(e){let{file:t,callback:n,maxSize:r,maxName:s,endpoint:i}=e;if(!t||!n||!r||!s||!i)return;if(t.size>r){y.uiMsgT(c.ui.file.size_limit,r/1024/1024+"MB");return}if(t.name.length>s){y.uiMsgT(c.ui.file.name_limit,s);return}let o=new FileReader;o.onload=()=>{let l=new XMLHttpRequest;l.open("POST",i),l.onload=()=>{l.status===200?(y.uiMsgT(c.ui.file.uploaded),n(l)):y.uiMsgT(c.ui.file.upload_error,[": "+l.statusText])},l.onerror=()=>{y.uiMsgT(c.ui.file.upload_error)};let u=localStorage.getItem("token");if(!u){y.uiMsgT(c.api.auth_error);return}l.setRequestHeader("Authorization",u);let d=new FormData;d.append("file",t),e.additionalFields&&e.additionalFields(l,d),l.send(d)},o.readAsArrayBuffer(t)},profile(e){let t={file:e,callback:a(()=>{x.msg(1,c.ui.file.uploaded)},"callback"),maxSize:4194304,maxName:60,endpoint:"/api/profile/upload"};zt.read(t)},realm(e,t){let n={file:e,callback:a(()=>{x.msg(1,c.ui.file.uploaded)},"callback"),maxSize:4194304,maxName:60,endpoint:"/api/realm/profile/upload",additionalFields:a(r=>{r.setRequestHeader("realm",t)},"additionalFields")};zt.read(n)},emocji(e,t){let n={file:e,callback:a(()=>{x.msg(1,c.ui.file.uploaded)},"callback"),maxSize:4194304,maxName:100,endpoint:"/api/emoji/upload",additionalFields:a(r=>{r.setRequestHeader("realm",t)},"additionalFields")};zt.read(n)}},Xe=zt});var qr,Ce,Re,Mn,wn=b(()=>{mt();T();K();Q();$();g("components/emoji");qr=JSON.parse(ke.get("/assets/emoji.json")),Ce={categories:[],emojis:{}},Re={getMathEmojisName(e){let t=[...Ce.categories,...qr.categories],n={};function r(s,i){i.includes(e)?(n[s]||(n[s]=[]),n[s].push(i)):Re.getEmojiFromName(i).keywords.filter(l=>l.includes(e)).length>0&&(n[s]||(n[s]=[]),n[s].push(i))}a(r,"processEmoji");for(let s of t)for(let i of s.emojis)r(s.id,i);return n},getEmojiFromName(e){let t=Ce.emojis[e];return t||(t=qr.emojis[e],t||null)},renderEmoji(){let e=ee.input.value,t=Re.getMathEmojisName(e);ee.container.innerHTML="",ee.nav.innerHTML="";for(let n of Object.keys(t)){let r=t[n];if(!r)continue;let s=document.createElement("button");s.classList.add("btn"),s.innerHTML=n,ee.nav.appendChild(s);let i=document.createElement("div");i.innerHTML=`<h1>${n}</h1>`;let o=document.createElement("div");o.classList.add("emoji__category"),i.appendChild(o);for(let l of r){let u=Re.getEmojiFromName(l);if(!u)continue;let d;u.html?(d=document.createElement("img"),d.src=`/userFiles/realms/${m.chat.to}/emojis/${u.id}.png`,d.setAttribute("data-name",u.name),d.classList.add("emoji__img")):(d=document.createElement("span"),d.innerHTML=u.skins[0]?.native),d.classList.add("emoji__item"),o.appendChild(d),d.addEventListener("click",Re.emojiClick)}ee.container.appendChild(i),s.addEventListener("click",()=>{ee.container.scrollTop=i.offsetTop-ee.container.offsetTop-5})}},emojiClick(e){let t="";if(e){let r=e.target,s=r.getAttribute("data-name");if(s){let i=Re.getEmojiFromName(s);i&&(t=`:${i.id}:`)}else t=r.innerHTML}let n=new CustomEvent("emocji",{detail:t});ee.div.dispatchEvent(n)}};ee.input.addEventListener("input",Re.renderEmoji);Re.renderEmoji();Mn=Re;Y.emojiFunc=Re;Y.customEmoji=Ce});var Ct,Qe,Kt=b(()=>{T();ut();Ke();$();W();se();P();V();_n();K();Q();wn();j();g("mess/interact");Ct={replyClose(){M.replyClose.style.display="none",m.temp.replyId&&(document.querySelector("#mess__"+m.temp.replyId).style.backgroundColor=""),m.temp.replyId=null},editMessClose(){M.editClose.style.display="none",M.input.value="",m.temp.editId=null,C.focusInp(),F.sendBtnStyle(),F.messageHeight(),F.setSelectionStart()},linkClick(e){e.preventDefault();let t=e.target.getAttribute("href");if(!t)return;/^(https?:\/\/)/i.test(t)||(t="http://"+t);let n=t.split("/");if(n.length<2)return y.uiMsgT(c.ui.message.invalid_link);let r=n[0]+"//<span>"+n[2]+"</span>/"+n.slice(3).join("/"),s=a(()=>{M.linkClick.fadeOut(),M.linkClick.querySelector("#linkClick_yes").removeEventListener("click",i),M.linkClick.querySelector("#linkClick_no").removeEventListener("click",s)},"end"),i=a(()=>{window.open(t,"_blank"),s()},"handleYesClick");M.linkClick.fadeIn(),M.linkClick.querySelector("#linkClick_link").innerHTML=r,M.linkClick.querySelector("#linkClick_yes").addEventListener("click",i),M.linkClick.querySelector("#linkClick_no").addEventListener("click",s)},emocjiPopup(e){ee.div.fadeIn();function t(n){e(n.detail),ee.div.removeEventListener("emocji",t),ee.div.fadeOut(),setTimeout(()=>{C.focusInp(),F.setSelectionStart()},100)}a(t,"evt"),setTimeout(()=>{ee.div.addEventListener("emocji",t),ee.input.value="",Mn.renderEmoji();let n=m.chat.to;n=="main"||n.startsWith("$")||p.emit("realm.emojis.sync",n,r=>{Ce.categories=[{id:"Custom",emojis:[...r.map(s=>s.name)]}],Ce.emojis={},r.forEach(s=>{Ce.emojis[s.name]={id:s.emoji,name:s.name,keywords:[s.name],skins:[],html:!0}}),Mn.renderEmoji()})},100)},emocji(){Ct.emocjiPopup(e=>{Ct.handleEmocji(e),setTimeout(()=>{F.setSelectionStart()},100)})},handleEmocji(e){e&&(M.input.value+=e)},search(){M.input.value="/search ",Ir(ze.system.search);let e=new Event("input");M.input.dispatchEvent(e),Ut.handleCommandInput()},displayPinned(){if(M.div.innerHTML="<h2>"+c.ui.pinned_messages+"</h2>",m.chat.pinned.length==0){M.div.innerHTML+=c.ui.no_pinned_messages;return}m.chat.pinned.forEach(e=>{Me.addMess(e)})},spoiler(e){e.preventDefault(),e.target.clT("spoiler__show")},thread(e,t){if(!e||!t)return;let{_id:n,name:r,author:s}=e;if(t.querySelector("#thread__"+n))return;let i=document.createElement("div");i.classList.add("thread"),i.id="thread__"+n,i.innerHTML=`
            \`- <span class="thread__author">${E.www.changeUserID(s)}</span> |  
            <span class="thread__name">${r}</span>`,i.addEventListener("click",()=>{C.changeChnl("&"+n)}),t.add(i)}};Ct.replyClose();Qe=Ct;re.mess=Ct});var Ur,Or,Vr=b(()=>{T();g("contextMenuLib");Ur={menuShower(e,t){e.style.display="block",n(t);function n(i){window.getSelection().removeAllRanges(),Ur.menuMax(i,e),document.body.addEventListener("click",r)}a(n,"_handleClick");function r(){s(),e.style.display="none"}a(r,"_click");function s(){document.body.removeEventListener("click",r)}a(s,"_removeClick")},menuMax(e,t){let n=e.clientX,r=e.clientY,s=t.clientWidth,i=t.clientHeight;t.style.left=n+10+"px",t.style.top=r+10+"px",t.style.right="auto",t.style.bottom="auto",n<0&&(t.style.left="10px"),r<0&&(t.style.top="10px");let o=window.innerWidth,l=window.innerHeight;n+s>o&&(t.style.left="auto",t.style.right="10px"),r+i>l&&(t.style.top="auto",t.style.bottom="10px")}},Or=Ur});function zi(e){let t=e.touches[0];return new MouseEvent(e.type,{clientX:t.clientX,clientY:t.clientY})}function Ki(e,t){return e.querySelector(`[data-id='${t}']`).style}function xe(e,t,n){Ki(e,t).display=n?"":"none"}function Xi(e){let t=[1,512,32,256,64],n=m.realms.find(r=>r.realm===e)?.p||0;return te.hasAnyPermission(n,t)}var Wi,fe,xt=b(()=>{T();Vr();Ne();oe();$();g("components/contextMenu");Wi={showMenu(e,t,n){return t.setAttribute("_id",n),Or.menuShower(t,e)},message(e,t,n){let r=document.querySelector("#message_context_menu");xe(r,"pin",n.pin),xe(r,"unpin",!n.pin),xe(r,"delete",n.delete),xe(r,"edit",n.edit),xe(r,"add_reaction",m.realm.chnlPerms[m.chat.chnl]?.react),xe(r,"create_thread",m.realm.chnlPerms[m.chat.chnl]?.threadCreate),this.showMenu(e,r,t)},realm(e,t){let n=document.querySelector("#realm_context_menu");xe(n,"settings",Xi(t)),this.showMenu(e,n,t)},channel(e,t,n){n={type:"text",...n};let r=document.querySelector("#channel_context_menu");xe(r,"subscribe",["announcement","open_announcement"].includes(n.type)),xe(r,"create_thread",m.realm.chnlPerms[m.chat.chnl]?.threadCreate),this.showMenu(e,r,t)},thread(e,t){let n=document.querySelector("#thread_context_menu"),r=m.user._id===t.author||te.isAdmin();xe(n,"delete",r),this.showMenu(e,n,t._id)},menuClickEvent(e,t,n){if(!L.isMobile()){e.addEventListener("contextmenu",l=>{if(!(n&&!n(l.target)))return l.preventDefault(),t(l),!1});return}let r,s;e.addEventListener("mousedown",i),e.addEventListener("touchstart",i),e.addEventListener("mouseup",o),e.addEventListener("touchend",o);function i(l){r=new Date().getTime();let u;l instanceof TouchEvent?u=zi(l):u=l,s=setTimeout(()=>{t(u)},1300)}a(i,"startHold");function o(l){if(clearTimeout(s),r=new Date().getTime()-r,!(r<2e3))return l.preventDefault(),!1}a(o,"cancelHold")}};a(zi,"convertTouchEventToMouseEvent");a(Ki,"getByDataIdStyle");a(xe,"setDisplayByDataId");a(Xi,"canUserManageRealm");fe=Wi});var Yi,me,et=b(()=>{T();g("var/staticData");Yi={baseTitle:"Fusion Chat",messCount:40,uploadImgTypes:["image/png","image/jpeg","image/jpg","image/gif"],contextmenuTags:["img","video","audio","a","input","textarea"]},me=Yi});function Br(e,t){let n=document.createElement("div");if(n.classList.add("embed"),n.innerHTML=`
        <div style="display: flex;">
            ${e.image?`<div style="width: 35%;">
                <img src="${e.image}" style="width: 90%;" />
            </div>`:""}
            <div ${e.image?'style="width: 65%;"':""}>
                ${e.title?`<h1>${e.title}</h1><br />`:""}
                ${e.description?`<p>${e.description}</p><br />`:""}
                ${e.url?`
                    <b>Link: </b>
                    <a href="${e.url}" onclick="mglInt.mess.linkClick(event)">${e.url}</a>
                `:""}
            </div>
        </div>
    `,e.customFields){n.innerHTML+="<br /><hr>";let r=document.createElement("div");r.classList.add("custom-fields");for(let[s,i]of Object.entries(e.customFields)){let o=document.createElement("div");o.classList.add("custom-field");let l=document.createElement("strong");l.innerText=s+": ",o.appendChild(l);let u=document.createElement("span");u.innerText=i,o.appendChild(u),r.appendChild(o)}n.appendChild(r)}t.appendChild(n)}var Nr=b(()=>{T();g("mess/format/embed");a(Br,"format_embed")});function Tn(e,t){let n=document.querySelector(`#mess__${e}`);if(!n)return;let r=n.querySelector(".mess_content").getAttribute("_plain"),s=document.createElement("div");s.innerHTML=r,s.classList.add("res_msg"),s.addEventListener("click",()=>{n.classList.add("res_msg__animate"),setTimeout(()=>n.classList.remove("res_msg__animate"),3e3)}),t.addUp(s)}var Wr=b(()=>{T();g("mess/format/respone");a(Tn,"format_responeMess")});var St,Ln,zr,Me,ut=b(()=>{T();_n();$();Ke();W();Wt();se();oe();P();kt();Kt();K();Q();xt();Ne();et();Nr();Wr();g("mess");St=2e3,Ln='<span class="editMessText noneselect" title="edit $$">(edit)</span>',zr={sendMess(){if(!m.chat.to||!m.chat.chnl||m.chat.to=="main")return;let e=M.input.value.trim();if(e&&!(e.length>St)){if(m.temp.editId)p.emit("message.edit",m.chat.to,m.temp.editId,e),Qe.editMessClose();else{let t={to:m.chat.to,chnl:m.chat.chnl,msg:e,res:m.temp.replyId};Ut.send(t)==0&&p.emit("mess",t)}M.input.value="",Qe.replyClose(),C.focusInp(),F.sendBtnStyle(),F.messageHeight()}},addMess(e,t=!0,n=!1){if(!e)return;let r=document.createElement("div");r.classList.add("mess_message"),r.id="mess__"+e._id,e.res&&r.setAttribute("resMsgID",e.res);let s=document.createElement("div");s.classList.add("mess_meta"),s.setAttribute("_author",e.fr);let i=document.createElement("img");i.src="/api/profile/img?id="+e.fr,s.appendChild(i);let o=document.createElement("div");o.classList.add("mess_meta_text");let l=document.createElement("span");l.innerHTML=E.www.changeUserID(e.fr),l.classList.add("mess_author_name"),["%","^","("].includes(e.fr[0])||l.addEventListener("click",()=>{p.emit("user.profile",e.fr)}),o.appendChild(l);let u=document.createElement("span");u.classList.add("mess_time"),u.innerHTML=L.formatDateFormUnix(L.extractTimeFromId(e._id)),o.appendChild(u),s.appendChild(o),r.appendChild(s);let d=document.createElement("div");if(d.classList.add("mess_content"),Ze.formatMess(e.msg,d),d.setAttribute("_plain",e.msg),r.appendChild(d),e.lastEdit){let h=L.formatDateFormUnix(parseInt(e.lastEdit,36)*1e3);d.innerHTML+=Ln.replace("$$",h)}if(e.embed&&Br(e.embed,d),e.reacts){let h=document.createElement("div");h.classList.add("mess_reacts");let f=Object.keys(e.reacts);for(let v of f){let _=e.reacts[v],w=document.createElement("span");w.setAttribute("_key",v),w.setAttribute("_users",_.join(",")),w.addEventListener("click",()=>{p.emit("message.react",m.chat.to,e._id,v)}),h.appendChild(w)}F.styleMessReacts(h),r.appendChild(h)}n?M.div.addUp(r):M.div.add(r),setTimeout(()=>{let f=M.div.scrollTop+M.div.clientHeight+r.clientHeight+70>=M.div.scrollHeight;e.res&&Tn(e.res,r),t&&f&&r.scrollIntoView({behavior:"smooth"})},100),fe.menuClickEvent(r,h=>{let f=m.chat.pinned.findIndex(_=>_._id==e._id)!=-1,v=e.fr==m.user._id||te.canAction(2);fe.message(h,e._id,{pin:!f,edit:e.fr==m.user._id,delete:v})},h=>!me.contextmenuTags.includes(h.tagName.toLowerCase())),r.addEventListener("click",()=>{m.chat.selectedMess=e._id})},sendFile(e){if(e)t(e);else{let n=document.createElement("input");n.type="file",n.click(),n.addEventListener("change",r=>{let i=r.target.files?.[0];i?t(i):console.error("No file selected.")})}function t(n){let r={file:n,callback:a(s=>{let i=JSON.parse(s.responseText).path,o=location.origin+i,l={to:m.chat.to,chnl:m.chat.chnl,msg:o};p.emit("mess",l)},"callback"),maxSize:8388608,maxName:60,endpoint:"/api/file/upload"};Xe.read(r)}a(t,"read")}},Me=zr;Y.messFunc=zr});var It,dt,F,Ke=b(()=>{T();K();oe();$();W();ut();g("mess/style");({input:It}=M),dt={sendBtnStyle(){let e=It.value.trim().length,t="";e==0?t="grey":e<=St?t="green":e>St&&(t="red"),M.sendBtnImg.style.setProperty("--fil",t),M.sendBtn.disabled=e==0||e>St},messageHeight(){let e=It.value.split(`
`).length-1;e=e>=2?Math.min(e,20):0,It.style.setProperty("--messHeight",e+"rem")},hideFromMessageInfo(){function e(r){let s=r.id.replace("mess__","");return L.extractTimeFromId(s)}a(e,"getTimeFromMess");let t=20,n=document.querySelectorAll(".mess_message");for(let r=1;r<n.length;r++){let s=n[r],i=n[r-1],o=s.querySelector(".mess_meta").getAttribute("_author"),l=i.querySelector(".mess_meta").getAttribute("_author");if(o!=l)continue;let u=e(s),d=e(i),h=s.querySelector(".mess_meta");h.style.display=u-d<t?"none":""}},colorRole(){let e=document.querySelectorAll(".mess_message"),t=m.realm.roles,n=m.realm.users,r=new Map;e.forEach(s=>{let i=s.querySelector(".mess_meta").getAttribute("_author");if(r.has(i)){dt.colorRoleMess(s,r.get(i));return}let o=n.find(u=>u.uid==i);if(!o||o.roles.length==0)return;let l;for(let u=0;u<t.length;u++)if(o.roles.includes(t[u].name)){l=t[u].c,r.set(i,l),dt.colorRoleMess(s,l);return}dt.colorRoleMess(s,"")})},colorRoleMess(e,t){e.querySelector(".mess_author_name").style.color=t},styleMessReacts(e){e.querySelectorAll("span").forEach(n=>{let r=n.getAttribute("_users").split(",");if(r.length==0||r[0]==""){n.remove();return}n.classList.remove("userReacted"),r.includes(m.user._id)&&n.classList.add("userReacted"),n.title=r.map(s=>E.www.changeUserID(s)).join(", "),n.innerHTML=n.getAttribute("_key")+" "+r.length})},setSelectionStart(e=void 0){e||(e=It.value.length),It.setSelectionRange(e,e)}};setTimeout(()=>{dt.sendBtnStyle(),dt.messageHeight()},100);F=dt});var tt,kn=b(()=>{T();g("render/var");tt={chnl_user:!1}});function _e(e,t){let n=document.querySelectorAll(`.userStatusMarker[data-status-id="${e}"]`);n.length!=0&&n.forEach(r=>r.setAttribute("data-status",t||"offline"))}var pt=b(()=>{a(_e,"updateUserProfileMarker")});var Kr,ft,Xt=b(()=>{T();$();W();oe();se();P();xt();K();pt();Ee();g("render/realm");Kr={realms(e){G.realms__content.innerHTML="",m.realms=e,e.forEach(t=>{let n=t.realm,r=document.createElement("div");r.classList.add("realm"),r.id="realm_chat_"+n,t.img?r.innerHTML=`<img src="/userFiles/realms/${n}.png?time=${Date.now()}" alt="${E.www.changeChat(n)}">`:r.innerHTML=E.www.changeChat(n),G.realms__content.appendChild(r),r.addEventListener("click",()=>{C.changeChat(n)}),fe.menuClickEvent(r,s=>{fe.realm(s,n)})}),C.markSelectedChat()},usersInChat(){H.realm__users.innerHTML="";let e=m.realm.roles,t=m.realm.users,n=new Map;function r(s){if(n.has(s))return n.get(s);let i=t.find(o=>o.uid==s);if(i){if(i.roles.length==0)return"";for(let o=0;o<e.length;o++)if(i.roles.includes(e[o].name)){let l=e[o].c;return n.set(s,l),l}return""}}a(r,"getColor"),t.map(s=>s.uid).forEach(s=>{let i=s[0]=="^",o=document.createElement("div");o.classList.add("realm_user_div"),o.classList.add("userStatusMarker"),o.setAttribute("data-status-id",s),i||o.addEventListener("click",()=>{p.emit("user.profile",s)});let l=document.createElement("img");l.src="/api/profile/img?id="+s.replace("^",""),o.appendChild(l);let u=document.createElement("div"),d=document.createElement("div");d.innerHTML=E.www.changeUserID(s),d.style.color=r(s),d.classList.add("realm_user_name"),u.appendChild(d);let h=document.createElement("div");h.innerHTML="",h.id="user_status_"+s,h.classList.add("realm_user_status"),u.appendChild(h),o.appendChild(u),H.realm__users.appendChild(o),Kr.realmUserStatus(s),_e(s,D.user_state[s]?.status.get())})},realmUserStatus(e){let t=document.querySelector("#user_status_"+L.escape(e));if(!t)return;let n=D.user_state[e];if(!n){_e(e,"offline");return}_e(e,n.status.get()||"offline");let r=n.activity.get();if(!r?.state){t.innerHTML=n.statusText.get()||"";return}t.innerHTML=r.state+" | "+r.name}},ft=Kr});var Ji,Ye,Yt=b(()=>{T();oe();Ee();g("render/utils");Ji={sortPrivs(e){let t=[...e];return t.sort((n,r)=>{let s=D.lastMess["$"+n]?.main,i=D.lastMess["$"+r]?.main;return!s||!i?0:L.extractTimeFromId(i.mess)-L.extractTimeFromId(s.mess)}),t},initPopup(e){if(!e)return;if(e.getAttribute("opened")){e.setAttribute("opened","2");return}e.setAttribute("opened","1"),e.fadeIn();let n=a(()=>{setTimeout(()=>{if(e.getAttribute("opened")==="2"){e.setAttribute("opened","1");return}e.fadeOut(),document.body.removeEventListener("click",n),setTimeout(()=>{e.removeAttribute("opened")},800)},100)},"closePopup");setTimeout(()=>{document.body.addEventListener("click",n)},100)},createUpdater(e,t){return{_value:t,get(){return this._value},set(n){this._value=n,e(n)}}}},Ye=Ji});var ht,Jt,we,Ht=b(()=>{Ee();Xt();pt();Yt();ht=D.user_state,Jt={_initUser(e){if(!ht[e]){let t=a(()=>Jt._updateUI(e),"cb");ht[e]={status:Ye.createUpdater(t,"offline"),statusText:Ye.createUpdater(t,""),activity:Ye.createUpdater(t,null)},Jt._updateUI(e)}},_updateUI(e){ft.realmUserStatus(e),_e(e,ht[e].status.get())},set(e,t){let{status:n,statusText:r,activity:s}=t;Jt._initUser(e),n&&ht[e].status.set(n),r&&ht[e].statusText.set(r),s&&ht[e].activity.set(s)}},we=Jt});function Yr(){return new Promise((e,t)=>{let n=indexedDB.open("socket",1);n.onupgradeneeded=()=>{let r=n.result;r.objectStoreNames.contains("general")||r.createObjectStore("general",{keyPath:"id"})},n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}function Gi(e){return new Promise(async(t,n)=>{let r=await Yr(),o=r.transaction("general","readwrite").objectStore("general").put(e);o.onsuccess=()=>{r.close(),t()},o.onerror=()=>n(o.error)})}function Zi(e){return new Promise(async(t,n)=>{let r=await Yr(),o=r.transaction("general","readonly").objectStore("general").get(e);o.onsuccess=()=>{r.close(),t(o.result)},o.onerror=()=>n(o.error)})}var Cn,Xr,Jr=b(()=>{P();T();g("cacheControllers/socketGeneral");Cn=class{static{a(this,"SocketController")}evtName;cb;constructor(t,n){p.on(t,n),this.evtName=t,this.cb=n}async sendToSocket(t,...n){let r=typeof n[n.length-1]=="function"?n.pop():null;p.emit(this.evtName,...n,async(...s)=>{await Gi({id:t,data:[...s]}),r?r(...s):this.cb(...s)})}async emitId(t="",...n){let r=this.evtName+(t?"-"+t:"");if(p.connected)await this.sendToSocket(r,...n);else{let s=await Zi(r),i=typeof n[n.length-1]=="function"?n.pop():null;s?i?i(...s.data):this.cb(...s.data):await this.sendToSocket(r,...n)}}async emit(...t){this.emitId("",...t)}async emitDataId(t,...n){this.emitId(t,t,...n)}},Xr=Cn;a(Yr,"openDB");a(Gi,"saveToDB");a(Zi,"getFromDB")});var Zr={};le(Zr,{default:()=>xn});var Gr,xn,Sn=b(()=>{T();V();P();gt();K();Q();j();$();g("interact/mainView");Gr={showNav(){q.nav.clientHeight==0?q.nav.fadeIn():q.nav.fadeOut()},async addFriend(e){e||(e=await y.prompt(c.ui.enter_friend)),e&&p.emit("friend.request",e)},changeView(e){Se.changeView(e)},requestFriendResponse(e,t){if(!e)return;let n=q.div.querySelector(`.main__view__friend[data-status-id="${e}"]`);n&&(p.emit("friend.response",e,t),n.remove(),m.mainView.requests=m.mainView.requests.filter(r=>r!=e),q.requestCount.innerHTML=`(${m.mainView.requests.length})`,t&&p.emit("friend.get.all"))}},xn=Gr;re.mainView=Gr});var Qr=b(()=>{});var Qi,nt,Gt=b(()=>{T();$();W();Yt();se();P();gt();Sn();K();Qr();oe();j();pt();Ht();g("render/user");Qi={localUserProfile(){H.user__name.innerHTML=E.www.changeUserID(m.user._id),H.user__status.innerHTML=m.user.statusText||m.user.status||"Online",_e(m.user._id,m.user.status||"online")},userProfile(e){if(!e)return;let t=e._id==m.user._id,n="/api/profile/img?id="+e._id;if(G.userProfile.innerHTML=`
            <div id="userProfileInfo" class="userStatusMarker">
                <img src="${n}" onclick="mglInt.createMediaPopup('${n}')" alt="User logo">
                <div>
                    <h1>${e.name}</h1>
                    <p>${e.status}${e.statusText?" | "+e.statusText:""}</p>
                    <div id="userProfileBtns" style="margin-top: 10px;"></div>
                </div>
            </div>
            <div id="userProfileActivity"></div>
            <div id="userProfileAbout"></div>
        `.trim(),(e.statusText||e.status)&&we.set(e._id,{status:e.status,statusText:e.statusText}),G.userProfile.querySelector("#userProfileInfo").setAttribute("data-status-id",e._id),!t){let s=document.createElement("button");s.classList.add("btn");let i;switch(e.friendStatus){case 0:i=c.ui.friend.add,s.onclick=()=>xn.addFriend(e._id);break;case 1:i=c.ui.friend.remove,s.onclick=()=>Se.removeFriend(e._id);break;case 2:i=c.ui.friend.request_sent,s.onclick=()=>Se.removeFriendRequest(e._id);break;case 3:i=c.ui.friend.request_received,s.onclick=()=>{C.changeChat("main"),Se.changeView("requests")};break}s.innerHTML=i;let o=G.userProfile.querySelector("#userProfileBtns");o.appendChild(s);let l=document.createElement("button");l.classList.add("btn"),l.style.marginLeft="10px",l.innerHTML=e.isBlocked?c.ui.friend.unblock:c.ui.friend.block,l.onclick=()=>{e.isBlocked=!e.isBlocked,p.emit("dm.block",e._id,e.isBlocked)},o.appendChild(l);let u=document.createElement("button");u.classList.add("btn"),u.style.marginLeft="10px",u.innerHTML=c.ui.friend.open_dm,u.onclick=()=>{C.changeChat("$"+e._id)},o.appendChild(u)}let r=G.userProfile.querySelector("#userProfileActivity");if(e.activity?.state){let s=e.activity;if(r.innerHTML=`
                <h2>Activity</h2>
                <p>${s.state} | ${s.name}</p>
                ${s.details?"<p>"+s.details+"</p>":""}
                ${s.startTime?'<p>Time: <span id="userProfileActivityTime"></span></p>':""}
                ${s.party?"<p>Party: "+s.party.id+" | "+s.party.state+(s.party.max?" / "+s.party.max:"")+"</p>":""}
            `.trim(),we.set(e._id,{activity:L.rmRef(s)}),s.startTime){let o=function(){let u=new Date().getTime()-new Date(s.startTime).getTime(),d=Math.floor(u/1e3/60/60),h=Math.floor(u/1e3/60)-d*60,f=Math.floor(u/1e3)-d*60*60-h*60;i.innerHTML=`${d}:${h}:${f}`};a(o,"update");let i=r.querySelector("#userProfileActivityTime"),l=setInterval(()=>{if(!i)return clearInterval(l);o()},1e3);o()}}Ye.initPopup(G.userProfile),we.set(e._id,e)}},nt=Qi});var es={};le(es,{default:()=>Dt});var B,rt,Dt,Zt=b(()=>{T();K();Q();P();W();V();$();j();ie();g("components/voice");B={local_stream:null,muteMic:!1,sending:!1,joined:!1},rt={async initCall(){try{if(ge.voiceShow.style.display="",B.local_stream)return;let e=await this.getStream(!0,!1);B.local_stream=e,ge.div.fadeIn()}catch(e){console.error("initCall",`Error joining voice channel: ${e.message}`)}},async joinToVoiceChannel(e){await this.initCall(),B.joined=e,p.emit("voice.join",e),p.emit("voice.get.users"),ge.muteMic.innerHTML=B.muteMic?c.ui.mute.unmute:c.ui.mute.mute},send(){if(B.sending)return;let e=[],t=new MediaRecorder(B.local_stream,{mimeType:"video/webm; codecs=vp8,opus"});t.ondataavailable=n=>{n.data.size!=0&&e.push(n.data)},t.onstop=()=>{if(e.length==0)return x.msg(2,"no voice data");p.volatile.emit("voice.sendData",e),e=[]},B.sending=setInterval(()=>{t.stop(),setTimeout(()=>{B.sending&&t.start()},10)},100),t.start(100)},endCall(){typeof B.sending=="number"&&clearInterval(B.sending),B.sending=!1,B.joined=!1,p.emit("voice.leave"),ge.div.fadeOut(),ge.mediaContainer.innerHTML="",ge.voiceShow.style.display="none",E.app.apiType=="rn"?E.api.send({type:"stopAudio"}):(B.local_stream.getTracks().forEach(e=>{e.stop()}),B.local_stream=null)},async startCall(){let e=m.chat.to.replace("$","");e=="main"||!await y.confirm(U(c.ui.confirm.call_to,E.www.changeUserID(e))+"?")||p.emit("call.dm.init",e)},toggleMute(){B.muteMic=!B.muteMic,E.app.apiType=="rn"?E.api.send({type:B.muteMic?"stopAudio":"startAudio"}):B.local_stream.getAudioTracks().forEach(t=>{t.enabled=!B.muteMic}),ge.muteMic.innerHTML=B.muteMic?c.ui.mute.unmute:c.ui.mute.mute},async getStream(e=!0,t=!1){if(E.app.apiType==="rn")return await window.processMediaRN.getStream();let n=new MediaStream;async function r(i){if(navigator.mediaDevices?.getUserMedia)return await navigator.mediaDevices.getUserMedia(i);if("webkitGetUserMedia"in navigator){let o=navigator.webkitGetUserMedia.bind(navigator);return new Promise((l,u)=>{o(i,l,u)})}else if("mozGetUserMedia"in navigator){let o=navigator.mozGetUserMedia.bind(navigator);return new Promise((l,u)=>{o(i,l,u)})}}a(r,"getUserMedia");async function s(i,o){if(i.length===0){y.uiMsgT("No devices found");return}let l=i.map(h=>h.label||"Unknown Device"),u=i.map(h=>h.deviceId),d=await y.selectPrompt(o,l,u);return u[d]}a(s,"selectDevice");try{let i=await r({audio:e,video:t});if(!i)return y.uiMsgT("Error getting temporary stream"),n;setTimeout(()=>{i.getTracks().forEach(v=>v.stop())},200);let o=await navigator.mediaDevices.enumerateDevices(),l=o.filter(v=>v.kind==="audioinput"),u=o.filter(v=>v.kind==="videoinput"),d=e?{deviceId:await s(l,c.ui.call.select_audio_device)}:!1,h=t?{deviceId:await s(u,c.ui.call.select_video_device)}:!1,f=await r({audio:d,video:h});return f&&f.getTracks().forEach(v=>n.addTrack(v)),n}catch(i){return console.error(`Error getting stream: ${i.message}`),y.uiMsgT("An error occurred while getting the stream"),n}},isInUserCall(e){return"user_"+[e,m.user._id].sort().join("=")==B.joined}};p.on("voice.sendData",(e,t)=>{let n=new Blob(t,{type:"audio/webm; codecs=vp8,opus"}),r=URL.createObjectURL(n);new Audio(r).play().catch(()=>{})});p.on("connect",()=>{B.joined&&(x.msg(1,"reconnected to voice channel"),rt.joinToVoiceChannel(B.joined))});p.on("voice.get.users",e=>{ge.users.innerHTML="",e.forEach(t=>{let n=document.createElement("li");n.innerHTML=E.www.changeUserID(t),ge.users.appendChild(n)}),e.length>1?rt.send():e.length==1&&(typeof B.sending=="number"&&clearInterval(B.sending),B.sending=!1)});p.on("call.dm.init",(e,t=!1)=>{if(t){if(y.uiMsgT(c.ui.call.offline,E.www.changeUserID(e)),!confirm(c.ui.call.wait+"?"))return}else{if(rt.isInUserCall(e))return p.emit("call.dm.answer",e,!0);let r=confirm(U(c.ui.call.called,E.www.changeUserID(e))+"?");if(p.emit("call.dm.answer",e,r),!r)return}let n="user_"+[e,m.user._id].sort().join("=");rt.joinToVoiceChannel(n)});p.on("call.dm.answer",(e,t)=>{if(!t)return alert(c.ui.call.rejected);if(!confirm(U(c.ui.call.answer,E.www.changeUserID(e))+"?"))return;let r="user_"+[e,m.user._id].sort().join("=");rt.joinToVoiceChannel(r)});p.on("voice.leave",e=>{y.uiMsgT(c.ui.call.left,E.www.changeUserID(e))});p.on("voice.join",e=>{y.uiMsgT(c.ui.call.joined,E.www.changeUserID(e))});Dt=rt;Y.voiceFunc=rt});var At,_t,en=b(()=>{T();$();W();Q();Zt();j();P();Ne();Wt();K();In();V();g("render/event");At={show(){m.chat.to=="main"||m.chat.to.startsWith("$")||p.emit("realm.event.list",m.chat.to,!1,e=>{G.events__container.innerHTML="",G.events__add.style.display=te.isAdmin()?"":"none",e.forEach(At.renderEvent),G.events.fadeIn(),H.realm__panel.querySelector("#navs__realm__events").setAttribute("data-count",e.length.toString())})},renderEvent(e){let{type:t,where:n,topic:r,time:s,desc:i,img:o,_id:l,author:u}=e,d=s*1e3,h=new Date(d).getTime(),f=document.createElement("div");f.clA("realm_event"),f.innerHTML+=`
            <img src="${o||"/favicon.svg"}" />
            <div class="realm_event__info">
                <h2>${r}</h2>
                ${i?'<div data-id="eventDesc"></div>':""}
                <p>${c.ui.author}: ${E.www.changeUserID(u)}</p>
                <p>${new Date(d).toLocaleString()} (<span data-id="cutdown"></span>)</p>
            </div>
            <div class="realm_event__users">
                <button data-id="users-join" class="btn">${c.uni.join}</button>
                <div>
                    <p>
                        ${c.ui.users}:
                        <span data-id="users-count"></span>
                        <button data-id="users-show" class="btn">${c.uni.show}</button>
                    </p>
                    <br />
                    <div data-id="users" style="display: none;" class="realm_event__users__list"></div>
                </div>
            </div>
        `;let v=f.querySelector(".realm_event__info");if(i){let z=f.querySelector("[data-id='eventDesc']");Ze.formatMess(i,z)}if(te.isAdmin()){let z=document.createElement("button");z.innerHTML=c.uni.delete,z.clA("btn"),z.addEventListener("click",async()=>{await y.confirm(c.ui.confirm.sure+"?")&&(p.emit("realm.event.delete",m.chat.to,l),setTimeout(()=>{At.show()},100))});let R=document.createElement("div");R.clA("realm_event__delete"),R.appendChild(z),f.appendChild(R)}function _(z){return z<10?"0"+z:z}a(_,"addZero");let w=f.querySelector("[data-id='cutdown']"),I,J=a(()=>{let z=new Date().getTime(),R=h-z;if(R<=0){if(w.textContent="0h 0m 0s",t=="custom"){let N=document.createElement("div");Ze.formatMess(n,N),v.appendChild(N)}else if(t=="voice"){let N=document.createElement("button");N.innerHTML=c.ui.call.call,N.clA("btn"),N.style.marginTop="5px",N.addEventListener("click",()=>{Dt.joinToVoiceChannel(n)}),v.appendChild(N)}clearInterval(I)}else{let N=Math.floor(R/36e5),ne=Math.floor(R%(1e3*60*60)/(1e3*60)),ce=Math.floor(R%(1e3*60)/1e3);w.textContent=`${_(N)}h ${_(ne)}m ${_(ce)}s`}},"updateCutdown");new Date().getTime()<h&&(I=setInterval(J,1e3)),J();let he=f.querySelector("[data-id='users-join']"),Be=e.users.includes(m.user._id);he.textContent=Be?c.uni.leave:c.uni.join,he.addEventListener("click",()=>{Be?(p.emit("realm.event.leave",m.chat.to,l),Be=!1,he.textContent=c.uni.join,e.users=e.users.filter(z=>z!=m.user._id)):(p.emit("realm.event.join",m.chat.to,l),Be=!0,he.textContent=c.uni.leave,e.users.push(m.user._id)),Tt()});let Ge=f.querySelector("[data-id='users-count']"),je=f.querySelector("[data-id='users-show']"),Te=f.querySelector("[data-id='users']");je.addEventListener("click",()=>{Te.style.display!="none"?(Te.style.display="none",je.innerHTML=c.uni.show):(Te.style.display="",je.innerHTML=c.uni.hide)});function Tt(){Te.innerHTML="",Ge.textContent=e.users.length.toString();for(let z of e.users){let R=document.createElement("div");R.textContent=E.www.changeUserID(z),R.style.cursor="pointer",R.addEventListener("click",()=>{p.emit("user.profile",z)}),Te.appendChild(R)}}a(Tt,"renderJoinedUsers"),Tt(),G.events__container.appendChild(f)},exit(){G.events.fadeOut(()=>{G.events__container.innerHTML=""})},async create(){if(m.chat.to=="main"||m.chat.to.startsWith("$")||!te.isAdmin())return;let e=G.events__container;e.innerHTML="";function t(_,w){let I=document.createElement("label");I.textContent=_,I.htmlFor=w,I.style.marginRight="1rem",e.appendChild(I),e.appendChild(document.createElement("br"))}a(t,"createLabel");function n(){e.appendChild(document.createElement("br")),e.appendChild(document.createElement("br"))}a(n,"br"),t(c.ui.event.topic,"event-topic");let r=document.createElement("input");r.type="text",r.placeholder=c.ui.event.topic,r.id="event-topic",e.appendChild(r),n(),t(c.ui.event.time,"event-time");let s=document.createElement("input");s.type="datetime-local",s.id="event-time",e.appendChild(s),n(),t(c.ui.event.desc,"event-desc");let i=document.createElement("input");i.type="text",i.placeholder=c.ui.event.desc,i.id="event-desc",e.appendChild(i),n(),t(c.ui.event.type,"event-type");let o=document.createElement("select");o.id="event-type",[{name:c.ui.event.type_custom,type:"custom"},{name:c.ui.event.type_voice,type:"voice"}].forEach(_=>{let w=document.createElement("option");w.value=_.type,w.textContent=_.name,o.appendChild(w)}),o.addEventListener("change",d),e.appendChild(o),n(),t(c.ui.event.where,"event-where");let l=document.createElement("div");e.appendChild(l),n();let u=document.createElement("select");u.id="event-where",h();function d(){if(l.innerHTML="",o.value=="custom"){let _=document.createElement("input");_.type="text",_.placeholder=c.ui.event.where,_.id="event-where",l.appendChild(_)}else o.value=="voice"&&l.appendChild(u)}a(d,"whereRender");function h(){H.realm__channels.querySelectorAll(".channel_voice:not(details .channel_voice)").forEach(_=>{let w=_.id.replace("channel_",""),I=_.textContent.replace(Qt("voice")+" | ",""),J=document.createElement("option");J.value=w,J.textContent=I,u.appendChild(J)}),H.realm__channels.querySelectorAll("details").forEach(_=>{let w=_.querySelector("summary").textContent,I=document.createElement("optgroup");I.label=w,u.appendChild(I),_.querySelectorAll(".channel_voice").forEach(J=>{let he=J.id.replace("channel_",""),Be=J.textContent.replace(Qt("voice")+" | ",""),Ge=document.createElement("option");Ge.value=he,Ge.textContent=Be,I.appendChild(Ge)})})}a(h,"renderWhereOptions"),d(),t(c.ui.event.img,"event-img");let f=document.createElement("input");f.type="text",f.placeholder=c.ui.event.img,f.id="event-img",e.appendChild(f),n();let v=document.createElement("button");v.textContent=c.uni.add,v.clA("btn"),v.addEventListener("click",()=>{let _={topic:r.value,time:Math.floor(new Date(s.value).getTime()/1e3),desc:i.value,type:o.value,where:l.querySelector("select, input").value,img:f.value};p.emit("realm.event.create",m.chat.to,_),setTimeout(()=>{At.show()},100)}),e.appendChild(v),n()}},_t=At;re.realmEvents=At});function eo(e=0){m.realm={users:[],roles:[],permission:e,text:[],desc:{},chnlPerms:{},threads:[]}}function to(e,t){H.realm__name.innerHTML="";let n=document.createElement("div");n.innerHTML=e,n.title=e,n.id="navs__realm__name__text",H.realm__name.appendChild(n),no(),so(t)}function no(){let e=document.createElement("span");e.innerHTML="\u{1F465}",e.classList.add("realm_nav_btn"),e.addEventListener("click",ro),H.realm__name.appendChild(e)}function ro(){tt.chnl_user=!tt.chnl_user,H.realm__channels.style.display=tt.chnl_user?"none":"",H.realm__users.style.display=tt.chnl_user?"":"none"}function so(e){let t=document.createElement("span");t.classList.add("realm_nav_btn"),t.innerHTML="\u2B07\uFE0F",t.addEventListener("click",n=>{setTimeout(()=>{fe.realm(n,e)},20)}),H.realm__name.appendChild(t)}function oo(e,t,n){let{name:r,type:s,desc:i,id:o}=e,l=document.createElement("div");l.onclick=()=>ao(s,o,n),l.id="channel_"+o,l.classList.add("channel_"+s),fe.menuClickEvent(l,d=>{fe.channel(d,o,{type:s})});let u=Qt(s);l.innerHTML=`${u} | ${r}`,t.appendChild(l),m.realm.desc[o]=i}function Qt(e){switch(e){case"text":return"\u{1F4DD}";case"voice":return"\u{1F3A4}";case"announcement":return"\u{1F4E3}";case"open_announcement":return"\u{1F4E3}";case"forum":return"\u{1F4DC}";default:console.error(e)}}function ao(e,t,n){e==="text"||e==="announcement"||e==="open_announcement"?C.changeChnl(t):e==="voice"?co(t,n):e==="forum"&&C.changeToForum(t)}function co(e,t){let n=m.realm.chnlPerms[e];if(!n||!n.write){y.uiMsgT(c.ui.channel.no_permission,["!"]);return}Dt.joinToVoiceChannel(t+"="+e)}function mo(e,t,n){let r=document.createElement("details");r.open=!0;let s=document.createElement("summary");s.innerHTML=e.name,r.appendChild(s),e.chnls.forEach(i=>{oo(i,r,n),m.realm.chnlPerms[i.id]=i.perms}),t.appendChild(r)}function uo(e){for(let t of e){let n=t.chnls.find(r=>r.type==="text");if(n)return n.id}return null}function po(){let e=H.realm__panel;e.innerHTML="",fo(e)}function fo(e){let t=document.createElement("button");t.innerHTML="\u{1FA87}",t.title="Events",t.id="navs__realm__events",t.clA("btn"),t.addEventListener("click",_t.show),e.appendChild(t),p.emit("realm.event.list",m.chat.to,!0,n=>{t.setAttribute("data-count",n.toString())})}function ho(e,t,n,r){if(eo(r),to(t,e),H.realm__channels.innerHTML="",n.length===0||n.every(s=>s.chnls.length===0)){H.realm__channels.innerHTML="No channels in this realm",m.chat.chnl=null;return}n.forEach(s=>mo(s,H.realm__channels,e)),po(),m.chat.chnl===null&&(m.chat.chnl=uo(n)),C.changeChnl(m.chat.chnl),pe["realm.thread.list"].emitId(e+"=null",e,null)}var ts,In=b(()=>{T();$();kn();V();se();Zt();K();xt();j();P();en();vt();g("render/realmInit");a(eo,"initRealmState");a(to,"createRealmNameSection");a(no,"addUsersDisplayButton");a(ro,"toggleUserDisplay");a(so,"addMenuButton");a(oo,"createChannel");a(Qt,"getChannelTypeEmoticon");a(ao,"handleChannelClick");a(co,"handleVoiceChannelJoin");a(mo,"createCategory");a(uo,"findFirstTextChannel");a(po,"downPanel");a(fo,"downPanel_events");a(ho,"realmInit");ts=ho});var tn,$e,Ft=b(()=>{T();K();$();se();Yt();oe();W();P();pt();Ee();g("render/dm");tn={chats(){H.priv.innerHTML="",Ye.sortPrivs(m.privs).forEach(e=>{let t=document.createElement("button");t.classList.add("priv_chat"),t.classList.add("btn"),t.classList.add("userStatusMarker"),t.id="priv_chat_"+e,t.setAttribute("data-status-id",e);let n=document.createElement("div"),r=document.createElement("img");r.src="/api/profile/img?id="+e,n.appendChild(r),n.innerHTML+=E.www.changeUserID(e),t.appendChild(n),H.priv.appendChild(t),t.addEventListener("click",()=>{C.changeChat("$"+e),setTimeout(()=>{tn.privsRead()},100)}),t.addEventListener("contextmenu",s=>{s.preventDefault(),p.emit("user.profile",e)}),_e(e,D.user_state[e]?.status.get())}),tn.privsRead(),C.markSelectedChat()},privsRead(){m.privs.forEach(e=>{let t=document.querySelector("#priv_chat_"+e)?.classList;if(!t)return;let n=D.lastMess["$"+e]?.main;if(!n)return;let r=!1;n.read!=null&&n.mess!=null?r=L.extractTimeFromId(n.read)<L.extractTimeFromId(n.mess):n.read==null&&n.mess!=null&&(r=!0),r?t.add("unreadPriv"):t.remove("unreadPriv")})},dm_get(e,t){e.forEach(n=>{let r="$"+n.priv;D.lastMess[r]=D.lastMess[r]||{},D.lastMess[r].main={read:n.last?.main??null,mess:n.lastMessId??null}}),m.privs=e.map(n=>n.priv),tn.chats(),m.blocked=t,m.chat.to.startsWith("$")&&C.dmPlaceholder(m.chat.to.substring(1))}},$e=tn});function go(){return ns||(ns=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function _o(){return rs||(rs=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}function vo(e){let t=new Promise((n,r)=>{let s=a(()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},"unlisten"),i=a(()=>{n(st(e.result)),s()},"success"),o=a(()=>{r(e.error),s()},"error");e.addEventListener("success",i),e.addEventListener("error",o)});return nn.set(t,e),t}function yo(e){if(Fn.has(e))return;let t=new Promise((n,r)=>{let s=a(()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},"unlisten"),i=a(()=>{n(),s()},"complete"),o=a(()=>{r(e.error||new DOMException("AbortError","AbortError")),s()},"error");e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});Fn.set(e,t)}function as(e){Pn=e(Pn)}function bo(e){return _o().includes(e)?function(...t){return e.apply(jn(this),t),st(this.request)}:function(...t){return st(e.apply(jn(this),t))}}function Eo(e){return typeof e=="function"?bo(e):(e instanceof IDBTransaction&&yo(e),An(e,go())?new Proxy(e,Pn):e)}function st(e){if(e instanceof IDBRequest)return vo(e);if(Hn.has(e))return Hn.get(e);let t=Eo(e);return t!==e&&(Hn.set(e,t),nn.set(t,e)),t}function cs(e,t,{blocked:n,upgrade:r,blocking:s,terminated:i}={}){let o=indexedDB.open(e,t),l=st(o);return r&&o.addEventListener("upgradeneeded",u=>{r(st(o.result),u.oldVersion,u.newVersion,st(o.transaction),u)}),n&&o.addEventListener("blocked",u=>n(u.oldVersion,u.newVersion,u)),l.then(u=>{i&&u.addEventListener("close",()=>i()),s&&u.addEventListener("versionchange",d=>s(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}function ss(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(Dn.get(t))return Dn.get(t);let n=t.replace(/FromIndex$/,""),r=t!==n,s=wo.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(s||Mo.includes(n)))return;let i=a(async function(o,...l){let u=this.transaction(o,s?"readwrite":"readonly"),d=u.store;return r&&(d=d.index(l.shift())),(await Promise.all([d[n](...l),s&&u.done]))[0]},"method");return Dn.set(t,i),i}async function*ko(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;let n=new Proxy(t,Lo);for(ls.set(n,t),nn.set(n,jn(t));t;)yield n,t=await(Rn.get(n)||t.continue()),Rn.delete(n)}function os(e,t){return t===Symbol.asyncIterator&&An(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&An(e,[IDBIndex,IDBObjectStore])}var An,ns,rs,Fn,Hn,nn,Pn,jn,Mo,wo,Dn,To,is,Rn,ls,Lo,ms=b(()=>{An=a((e,t)=>t.some(n=>e instanceof n),"instanceOfAny");a(go,"getIdbProxyableTypes");a(_o,"getCursorAdvanceMethods");Fn=new WeakMap,Hn=new WeakMap,nn=new WeakMap;a(vo,"promisifyRequest");a(yo,"cacheDonePromiseForTransaction");Pn={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return Fn.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return st(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};a(as,"replaceTraps");a(bo,"wrapFunction");a(Eo,"transformCachableValue");a(st,"wrap");jn=a(e=>nn.get(e),"unwrap");a(cs,"openDB");Mo=["get","getKey","getAll","getAllKeys","count"],wo=["put","add","delete","clear"],Dn=new Map;a(ss,"getMethod");as(e=>({...e,get:a((t,n,r)=>ss(t,n)||e.get(t,n,r),"get"),has:a((t,n)=>!!ss(t,n)||e.has(t,n),"has")}));To=["continue","continuePrimaryKey","advance"],is={},Rn=new WeakMap,ls=new WeakMap,Lo={get(e,t){if(!To.includes(t))return e[t];let n=is[t];return n||(n=is[t]=function(...r){Rn.set(this,ls.get(this)[t](...r))}),n}};a(ko,"iterate");a(os,"isIteratorProp");as(e=>({...e,get(t,n,r){return os(t,n)?ko:e.get(t,n,r)},has(t,n){return os(t,n)||e.has(t,n)}}))});async function qn(e){if(!e&&$n)return $n;let t=Date.now(),n=await cs(Co,t,{upgrade(r){e&&e(r)}});return $n=n,n}async function yt(e){let t=await qn();return t.objectStoreNames.contains(e)||(t.close(),t=await qn(n=>{n.createObjectStore(e,{keyPath:"_id"}).createIndex("chnl","chnl",{unique:!1})})),t}async function us(e,t,n){let r=e.transaction(t,"readwrite"),s=r.objectStore(t),o=await s.index("chnl").getAll(n);if(o.length<=150)return;o.sort((u,d)=>L.extractTimeFromId(d._id)-L.extractTimeFromId(u._id));let l=o.length-150;for(let u=0;u<l;u++)await s.delete(o[u]._id);await r.done}var Co,$n,Un,xo,qe,rn=b(()=>{oe();$();Pt();ms();Co="messages",$n=null;a(qn,"getDB");a(yt,"createCollection");Un=class{static{a(this,"MessageCacheController")}constructor(){qn()}async addMessage(t,n,r){let s={...r,chnl:n},i=await yt(t);await i.put(t,s),await us(i,t,n)}async addMessages(t,n,r){if(r.length===0)return;let s=await yt(t),i=s.transaction(t,"readwrite"),o=i.objectStore(t);for(let l of r){let u={...l,chnl:n};await o.put(u)}await i.done,await us(s,t,n)}async getMessagesRaw(t,n){return await(await yt(t)).transaction(t,"readonly").objectStore(t).index("chnl").getAll(n)}async getMessages(){let{to:t,chnl:n}=m.chat,r=await this.getMessagesRaw(t,n);m.chat.actMess=r.length,r.reverse(),sn(r)}async deleteMessage(t,n){await(await yt(t)).transaction(t,"readwrite").objectStore(t).delete(n)}async deleteMessages(t,n){let s=(await yt(t)).transaction(t,"readwrite"),i=s.objectStore(t);for(let o of n)i.delete(o);await s.done}async editMessage(t,n,r,s){let o=(await yt(s)).transaction(s,"readwrite"),l=o.objectStore(s),u=await l.get(t);if(!u)return;let d={...u,msg:n,lastEdit:r};await l.put(d),await o.done}};a(us,"enforceChannelCacheLimit");xo=new Un,qe=xo});function ps(e){D.lastMess[e.to]=D.lastMess[e.to]||{},D.lastMess[e.to][e.chnl]=D.lastMess[e.to][e.chnl]||{read:null,mess:null},D.lastMess[e.to][e.chnl].mess=e._id,qe.addMessage(e.to,e.chnl,ds(e));let t=e.to.startsWith("$"),n=m.chat.to.startsWith("$"),r=e.fr===m.user._id;if(t&&!n&&!r){let s=U(c.ui.new_message,E.www.changeUserID(e.fr));y.uiMsg(s),m.settings.notifications&&m.user.status!=="dnd"&&L.sendNotification(s,e.msg,{msg:e})}t&&$e.chats(),!(m.chat.to!==e.to||m.chat.chnl!==e.chnl)&&(D.lastMess[e.to][e.chnl].read=e._id,t&&$e.privsRead(),Me.addMess(ds(e)),F.hideFromMessageInfo(),F.colorRole(),setTimeout(()=>{D.lastMess[e.to][e.chnl].mess===e._id&&p.emit("message.mark.read",e.to,e.chnl,e._id)},1e3))}function ds(e){let t={_id:e._id,fr:e.fr,msg:e.msg};return e.embed&&(t.embed=e.embed),e.res&&(t.res=e.res),t}function sn(e){try{e.forEach(t=>{try{Me.addMess(t,!1,!0)}catch(n){console.error(n),console.error(t);let r=document.createElement("div");r.innerHTML=`<span style="color: red;">${c.ui.failed_to_load_message}!</span>`,M.div.add(r)}}),F.hideFromMessageInfo(),setTimeout(C.scrollToBottom,30)}catch(t){console.error(t);let n=document.createElement("div");n.innerHTML=`<span style="color: red;">${c.ui.failed_to_load_messages}! :(</span>`,M.div.add(n)}F.colorRole()}function fs(e,t){document.querySelector("#mess__"+e)?.remove(),F.hideFromMessageInfo(),qe.deleteMessage(t,e)}function hs(e,t){e.forEach(n=>{document.querySelector("#mess__"+n)?.remove()}),F.hideFromMessageInfo(),qe.deleteMessages(t,e)}function gs(e,t,n,r){let s=document.querySelector("#mess__"+e+" .mess_content");if(!s)return;s.setAttribute("_plain",t),Ze.formatMess(t,s),s.innerHTML+=Ln.replace("$$",L.formatDateFormUnix(parseInt(n,36)*1e3)),document.querySelectorAll(`[resMsgID=${e}] .res_msg`).forEach(o=>{o.innerHTML=t}),F.hideFromMessageInfo(),qe.editMessage(e,t,n,r)}function _s(e,t,n,r){if(m.chat.to!=t)return;let s=document.querySelector("#mess__"+n);if(!s)return;let i=s.querySelector(`span[_key="${r}"]`);if(!i){let l=document.createElement("span");l.setAttribute("_key",r),l.setAttribute("_users",e),l.innerHTML=r+" 1",l.title=E.www.changeUserID(e),l.addEventListener("click",()=>{p.emit("message.react",t,n,r)}),s.querySelector(".mess_reacts").appendChild(l),F.styleMessReacts(s.querySelector(".mess_reacts"));return}let o=i.getAttribute("_users").split(",");o.includes(e)?o=o.filter(l=>l!=e):o.push(e),i.setAttribute("_users",o.join(",")),F.styleMessReacts(s.querySelector(".mess_reacts"))}function vs(e){if(e.length==0){M.div.innerHTML+=c.ui.message.search_no_results;return}M.div.innerHTML="<h2>"+c.ui.message.search_results+":</h2>",e.forEach(t=>{Me.addMess(t,!1)})}function ys(e){m.chat.pinned=e}function on(e){m.realm.threads=[...new Set([...m.realm.threads,...e])],e.forEach(t=>{let n=document.querySelector("#channel_"+t.thread);if(!n)return;if(!document.querySelector("#channel_\\&"+t._id)){let s=document.createElement("div");s.classList.add("channel_text"),s.id="channel_&"+t._id,s.style.paddingLeft="2.4rem",s.innerHTML=`\`- ${t.name}`,s.addEventListener("click",()=>{C.changeChnl("&"+t._id)}),n.insertAdjacentElement("afterend",s),fe.menuClickEvent(s,i=>{fe.thread(i,t)})}if(t.reply){let s=document.querySelector("#mess__"+t.reply);s&&Qe.thread(t,s)}})}function bs(e){document.querySelector("#channel_\\&"+e)?.remove(),document.querySelector("#thread__"+e)?.remove()}var Pt=b(()=>{T();P();$();W();se();oe();Ke();Wt();K();Ft();Kt();V();ut();xt();j();Ee();rn();g("socket/mess");a(ps,"mess");a(ds,"convertReceivedMessageToDbMessage");a(sn,"message_fetch");a(fs,"message_delete");a(hs,"messages_delete");a(gs,"message_edit");a(_s,"message_react");a(vs,"message_search");a(ys,"message_fetch_pinned");a(on,"realm_thread_list");a(bs,"realm_thread_delete")});var Es={};le(Es,{socketEvt:()=>pe});var So,pe,vt=b(()=>{Jr();an();Xt();Gt();In();Ft();gt();T();Pt();g("socket/engine");So=[["self.status.get",Ts],["realm.users.sync",Ls],["realm.users.activity.sync",ks],["realm.event.notify",Cs],["user.status.update",On],["user.status.update",On],["dm.get",$e.dm_get],["realm.get",ft.realms],["realm.setup",ts],["user.profile",nt.userProfile],["friend.get.all",Ms],["friend.requests.get",ws],["message.fetch.pinned",ys],["realm.thread.list",on]],pe=Object.fromEntries(So.map(([e,t])=>[e,new Xr(e,t)]))});function Ms(e){m.mainView.friends=e,Ue.renderFriends()}function ws(e){m.mainView.requests=e,Ue.renderRequests()}var Ue,Se,gt=b(()=>{T();$();K();se();W();P();V();j();pt();Ee();Ht();vt();g("components/mainView");Ue={show(){p.emit("friend.get.all"),p.emit("friend.requests.get")},renderFriends(){if(q.friendsContainer.innerHTML="",m.mainView.friends.length==0){q.noFriends.style.display="";return}else q.noFriends.style.display="none";m.mainView.friends.forEach(e=>{let t=document.createElement("div");t.classList.add("main__view__friend"),t.classList.add("userStatusMarker"),t.setAttribute("data-status-id",e._id),t.innerHTML=`
                <img class="friend__avatar" src="/api/profile/img?id=${e._id}" />
                <div>
                    <span class="friend__name">${E.www.changeUserID(e._id)}</span>
                    <br />
                    <span class="friend__status">${e.status}</span>
                    ${e.text?`<span class="friend__status_text">${e.text}</span>`:""}
                </div>
            `.trim(),t.querySelector(".friend__name").addEventListener("click",n=>{n.stopPropagation(),pe["user.profile"].emitDataId(e._id)}),t.addEventListener("click",()=>{C.changeChat("$"+e._id)}),q.friendsContainer.appendChild(t),we.set(e._id,{status:e?.status,statusText:e?.text})}),Ue.sortFriends(m.mainView.page)},changeView(e){m.mainView.page=e,["all","online","offline"].includes(e)?(Ue.sortFriends(e),q.friends.style.display="",q.requests.style.display="none",Ue.renderFriends()):e=="requests"&&(Ue.renderRequests(),q.requests.style.display="",q.friends.style.display="none"),q.div.querySelectorAll("[main_view]").forEach(t=>t.style.backgroundColor=""),document.querySelector(`[main_view="${e}"]`).style.backgroundColor="var(--accent)"},sortFriends(e){let t=q.div.querySelectorAll(".main__view__friend");if(t.length==0)return;q.noFriends.style.display="none";let n=t.length;t.forEach(r=>{let s=r.getAttribute("data-status")||"offline";e=="all"||e=="online"&&(s=="online"||s=="idle"||s=="dnd")||e=="offline"&&s=="offline"?r.style.display="":(r.style.display="none",n--)}),n==0&&(q.noFriends.style.display="")},renderRequests(){if(q.requestsContainer.innerHTML="",q.requestCount.innerHTML=`(${m.mainView.requests.length})`,m.mainView.requests.length==0){q.noRequests.style.display="";return}else q.noRequests.style.display="none";m.mainView.requests.forEach(e=>{let t=document.createElement("div");t.classList.add("main__view__friend"),t.classList.add("userStatusMarker"),t.setAttribute("data-status-id",e),t.innerHTML=`
                <img class="friend__avatar" src="/api/profile/img?id=${e}" />
                <div>
                    <div class="friend__name">${E.www.changeUserID(e)}</div>
                    <button onclick="mglInt.mainView.requestFriendResponse('${e}', true)" class="request__btn">Accept</button>
                    <button onclick="mglInt.mainView.requestFriendResponse('${e}', false)" class="request__btn">Decline</button>
                </div>
            `;function n(){p.emit("user.profile",e)}a(n,"showUser"),t.querySelector(".friend__name").addEventListener("click",n),t.querySelector(".friend__avatar").addEventListener("click",n),q.requestsContainer.appendChild(t),_e(e,D.user_state[e]?.status.get())})},async removeFriend(e){!e||!await y.confirm(U(c.ui.confirm.remove_friend,E.www.changeUserID(e))+"?")||!await y.confirm(U(c.ui.confirm.sure,E.www.changeUserID(e))+"?")||(p.emit("friend.remove",e),p.emit("friend.get.all"))},async removeFriendRequest(e){!e||!await y.confirm(U(c.ui.confirm.remove_friend,E.www.changeUserID(e))+"?")||p.emit("friend.request.remove",e)}};Ue.changeView("online");a(Ms,"friend_get_all");a(ws,"friend_requests_get");p.on("friend.request",e=>{let t=U(c.ui.friend.request,E.www.changeUserID(e));y.uiMsg(t,{onClick:a(()=>{C.changeChat("main"),Ue.changeView("requests")},"onClick")}),p.emit("friend.requests.get")});p.on("friend.response",(e,t)=>{if(!t){y.uiMsgT(c.ui.friend.declined,E.www.changeUserID(e));return}y.uiMsgT(c.ui.friend.request,E.www.changeUserID(e)),m.chat.to=="main"&&p.emit("friend.get.all")});Se=Ue});function Vn(e,t){let n=document.createElement("div"),r=document.createElement("button");r.classList.add("btn"),r.id="forum_add",r.innerHTML=c.ui.create_thread,r.addEventListener("click",async()=>{let s=await y.prompt(c.ui.create_thread_name);s&&p.emit("realm.thread.create",m.chat.to,t,s,null,i=>{C.changeChnl("&"+i)})}),n.appendChild(r),n.appendChild(document.createElement("hr")),n.appendChild(document.createElement("br")),e.forEach(s=>{let i=document.createElement("div");i.classList.add("forum"),i.id="forum__"+s._id,i.innerHTML=`
            <div class="forum__author">${E.www.changeUserID(s.author)}</div>
            <div class="forum__name">${s.name}</div>
        `,n.appendChild(i),i.addEventListener("click",()=>{on([s]),C.changeChnl("&"+s._id)})}),M.div.appendChild(n)}var xs=b(()=>{W();se();Pt();P();j();K();$();V();a(Vn,"render_forum")});var Ie,C,se=b(()=>{T();$();W();oe();P();Ke();kn();gt();wn();K();Q();et();j();Ft();xs();vt();rn();g("coreFunc");Ie={async changeChat(e,t=null){if(M.div.innerHTML="",Ce.categories=[],Ce.emojis={},m.realm=Rt(),e=="main"){m.chat.to="main",M.bar.style.display="none",document.querySelector("title").innerHTML=me.baseTitle,H.main.style.display="",H.realms.style.display="none",H.main__call.style.display="none",M.nav.style.display="none",q.div.style.display="",M.div.style.display="none",Se.show(),this.markSelectedChat();return}if(setTimeout(()=>{L.ss()&&(e!="main"&&!e.startsWith("$")||(document.querySelector("nav").style.left="-360px"))},300),M.bar.style.display="block",M.div.style.display="",M.nav.style.display="",q.div.style.display="none",m.chat.to=e,m.chat.actMess=0,e.startsWith("$")){if(document.querySelector("title").innerHTML=me.baseTitle+" | "+E.www.changeUserID(e.substring(1)),H.main.style.display="",H.realms.style.display="none",m.chat.chnl="main",!m.privs.includes(e.substring(1))){let n=e.substring(1),r=await new Promise(s=>{p.emit("dm.create",n,()=>{p.emit("dm.get",(i,o)=>{s([i,o])})})});$e.dm_get(r[0],r[1])}Ie.loadChat(),Ie.fetchPinned(),m.realm.users=[],m.realm.roles=[],m.realm.chnlPerms={},Ie.dmPlaceholder(e.substring(1)),H.main__call.style.display="",M.nav_priv.style.display="",M.nav_realm.style.display="none"}else document.querySelector("title").innerHTML=me.baseTitle+" | "+E.www.changeChat(e),H.main.style.display="none",H.realms.style.display="",M.nav_priv.style.display="none",M.nav_realm.style.display="",m.chat.chnl=t,tt.chnl_user=!1,H.realm__channels.style.display="",H.realm__users.style.display="none",pe["realm.setup"].emitDataId(e),pe["realm.users.sync"].emitDataId(e),pe["realm.users.activity.sync"].emitDataId(e);Ie.markSelectedChat()},changeChnl(e){m.chat.chnl=e,m.chat.actMess=0,m.chat.selectedMess=null,document.querySelectorAll(".channel_textActive").forEach(n=>n.classList.remove("channel_textActive")),document.querySelector("#channel_"+L.escape(e))?.classList?.add("channel_textActive"),$t.messages_nav__realm__description.innerHTML=m.realm.desc[e]||"",Ie.loadChat(),Ie.fetchPinned(),e.startsWith("&")||setTimeout(()=>{pe["realm.thread.list"].emitId(m.chat.to+"="+m.chat.chnl,m.chat.to,m.chat.chnl)},100);let t=!1;if(e.startsWith("&")){let n=e.substring(1),r=m.realm.threads.find(s=>s._id==n);r&&(t=m.realm.chnlPerms[r.thread].threadWrite)}else if(e.startsWith("^"))t=m.realm.chnlPerms[e]?.threadWrite||!1;else{let n=m.realm.chnlPerms[e];n&&(t=n.write)}M.input.placeholder=t?c.ui.message.placeholder+"...":c.ui.message.read_only+"!",M.input.disabled=!t,M.bar.style.display=""},loadChat(){Ie.loadMess(),setTimeout(Ie.focusInp,100),setTimeout(()=>{M.div.scrollTop=M.div.scrollHeight},300)},focusInp(e=!1){L.ss()||setTimeout(()=>{M.input.focus(),e&&F.setSelectionStart()},100)},loadMess(){M.div.innerHTML="";let e=m.chat.actMess;m.chat.actMess+=me.messCount,m.chat.to!="main"&&(p.connected?(p.emit("message.fetch",m.chat.to,m.chat.chnl,e,m.chat.actMess),p.emit("message.mark.read",m.chat.to,m.chat.chnl,"last")):qe.getMessages())},scrollToBottom(){m.temp.scrollBlock||(m.temp.scrollBlock=!0,setTimeout(()=>{M.div.scrollTop=M.div.scrollHeight},50),setTimeout(()=>{m.temp.scrollBlock=!1},300))},markSelectedChat(){document.querySelectorAll(".priv_chat").forEach(t=>{t.classList.remove("priv_chatActive")}),document.querySelectorAll(".realm").forEach(t=>{t.classList.remove("realm_chatActive")});let e=m.chat.to;e=="main"||(e.startsWith("$")?document.querySelector("#priv_chat_"+e.substring(1)).classList.add("priv_chatActive"):document.querySelector("#realm_chat_"+e).classList.add("realm_chatActive"))},dmPlaceholder(e){function t(s,i){M.input.placeholder=s,M.input.disabled=i}if(a(t,"set"),m.blocked.some(s=>s.block==e))return t(c.ui.message.block_placeholder.block+"!",!0);if(m.blocked.some(s=>s.blocked==e))return t(c.ui.message.block_placeholder.blocked+"!",!0);t(c.ui.message.placeholder+"...",!1)},async changeToForum(e){m.chat.chnl="";let t=await new Promise(n=>{pe["realm.thread.list"].emitId(m.chat.to+"="+e,m.chat.to,e,n)});M.div.innerHTML="",Vn(t,e),M.input.placeholder=c.ui.message.read_only+"!",M.input.disabled=!0,M.bar.style.display="none"},fetchPinned(){pe["message.fetch.pinned"].emitId(m.chat.to+"="+m.chat.chnl,m.chat.to,m.chat.chnl)}},C=Ie;Y.coreFunc=Ie});var it,Bn,Ss=b(()=>{T();g("var/keys");it={shift:!1,ctrl:!1,alt:!1},Bn=it;document.addEventListener("keydown",e=>{it.shift=e.shiftKey,it.ctrl=e.ctrlKey,it.alt=e.altKey});document.addEventListener("keyup",e=>{it.shift=e.shiftKey,it.ctrl=e.ctrlKey,it.alt=e.altKey})});var Io,He,cn=b(()=>{T();$();K();se();Ke();P();V();Ss();j();vt();g("interact/ui");Io={editMess(e){let t=document.querySelector("#mess__"+e+" .mess_content");if(!t)return;let n=t.getAttribute("_plain");M.input.value=n,m.temp.editId=e,M.editClose.style.display="block",C.focusInp(!0),F.sendBtnStyle(),F.messageHeight(),F.setSelectionStart()},clipboardError(e){let t=document.createElement("div");t.style.opacity="0",t.classList.add("prompt"),t.innerHTML="<h2>"+c.ui.clipboard.error+".</h2>",t.innerHTML+="<h3>"+c.ui.clipboard.error_text+".</h3>",t.appendChild(document.createElement("br"));let n=document.createElement("textarea");n.value=e,t.appendChild(n),t.appendChild(document.createElement("br"));let r=document.createElement("button");r.innerHTML="OK",t.appendChild(r),r.addEventListener("click",()=>{t.fadeOut(),setTimeout(()=>{t.remove()},2e3)}),bt.appendChild(t),t.fadeIn(()=>{n.select()})},async createThread(e=null){let{to:t,chnl:n}=m.chat;if(!t||!n||t.startsWith("$")||!m.realm.chnlPerms[n]?.threadCreate)return;let r=await y.prompt(c.ui.create_thread_name);r&&p.emit("realm.thread.create",t,n,r,e,()=>{pe["realm.thread.list"].emitId(t+"="+n,t,n)})},async deleteMess(e){!(Bn.shift||Bn.ctrl)&&!await y.confirm(c.ui.confirm.delete_message+"?")||p.emit("message.delete",m.chat.to,e)}},He=Io});var Ho,L,oe=b(()=>{T();W();cn();g("utils");Ho={ss(){return window.innerWidth<800},isMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},extractTimeFromId(e){if(!e)return 0;let t=e.split("-")[0];return parseInt(t,36)},formatDateFormUnix(e){let t=new Date(e),n=t.getDate(),r=t.getMonth()+1,s=t.getFullYear(),i=t.getHours(),o=t.getMinutes();return`${n}.${r}.${s} ${i}:${o<10?"0":""}${o}`},validId(e){return!(!e||typeof e!="string"||e.split("-").length!=3)},writeToClipboard(e){return new Promise(t=>{navigator.clipboard.writeText(e).then(()=>{t(!0)}).catch(()=>{He.clipboardError(e),t(!1)})})},sendNotification(e,t,n={}){switch(E.app.apiType){case"rn":case"ele":E.api.send({type:"notif",title:e,msg:t,payload:n});break;case"web":if(Notification.permission==="granted"){let r=new Notification(e,{body:t});r.onclick=()=>{window.focus(),r.close()}}break;default:break}},escape(e){return e.replace(/([.&*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},rmRef(e){return JSON.parse(JSON.stringify(e))}},L=Ho});function U(e,...t){return e.replace(/\\\$|(?<!\\)\$/g,n=>n==="\\$"?"$":t.shift()?.toString()||"$")}async function Is(){document.querySelectorAll("[translate]").forEach(t=>{t.getAttribute("translate")||t.setAttribute("translate",t.innerHTML.trim())}),ot.localesList=ke.get("lang/list.txt").split(`
`),ot.localesList.unshift("en");let e=localStorage.getItem("lang");if(!e){let t=navigator.language.split("-")[0],n=ot.localesList.indexOf(t);e=n>-1?ot.localesList[n]:"en"}await Wn(e)}async function Wn(e="en"){if(!ot.localesList.includes(e))return;localStorage.setItem("lang",e);let t={api:await De(e,"api"),media:await De(e,"media"),settings:await De(e,"settings"),settings_realm:await De(e,"settings.realm"),settings_user:await De(e,"settings.user"),socket:await De(e,"socket"),ui:await De(e,"ui"),uni:await De(e,"uni"),common:await De(e,"common"),InternalCode:await De(e,"code")};for(let n in t)Nn[n]=t[n];Do()}function Do(){document.querySelectorAll("[translate]").forEach(e=>{let t=e.getAttribute("translate");e.innerHTML=Ao(t)})}function Ao(e){let t=e.split("."),n=L.rmRef(Nn);for(let r of t.slice(0,-1))if(n=n[r],!n)return null;return n?.[t[t.length-1]]}async function De(e,t){return(await new Function("path","return import(path);")(`./lang/${e}/${t}.js`)).default}var ot,Nn,c,j=b(()=>{T();mt();oe();g("translate");ot={localesList:[]},Nn={};a(U,"langFunc");a(Is,"init_translate");a(Wn,"load_translate");a(Do,"translateHTML");a(Ao,"getDataByKey");a(De,"importData");c=Nn});var zn,bt,Kn,y,V=b(()=>{T();ie();j();g("helpers/uiFunc");zn=document.querySelector("#errMesses"),bt=document.querySelector("#prompt"),Kn={async uiMessage(e,t={}){t={displayTime:6e3,...t};let n=document.createElement("div");n.innerHTML=e,n.style.top=`-${n.offsetHeight+20}px`,t.className&&n.classList.add(t.className),t.backgroundColor&&(n.style.backgroundColor=t.backgroundColor);let r=10,s=i();function i(){let u=0;for(let d of zn.children)u+=d.offsetHeight+r;return u}a(i,"calculateTopPosition");let o=!1;async function l(){o=!0,n.style.top=`-${n.offsetHeight+20}px`,await delay(700);for(let u of zn.children){let d=u,h=parseInt(d.style.top.replace("px",""));d.style.top=`${h-r-n.offsetHeight}px`}n.remove()}a(l,"end"),n.addEventListener("click",l),t.onClick&&n.addEventListener("click",t.onClick),zn.appendChild(n),await delay(100),n.style.top=`${10+s}px`,await delay(t.displayTime-700),!o&&await l()},uiMsg(e,t={}){x.msg(1,"uiMsg:",e),t={extraTime:0,...t};let n=1/3,s={displayTime:(e.split(" ").length*n+6+t.extraTime)*1e3,className:"uiMsgClass"};t.onClick&&(s.onClick=t.onClick),Kn.uiMessage(e,s)},uiMsgT(e,...t){let n="";t.length>0&&Array.isArray(t[0])&&(n=t.shift()),e=U(e,...t)+n,Kn.uiMsg(e)},prompt(e,t=""){return new Promise(n=>{function r(){n(i.value),s.fadeOut(),setTimeout(()=>{s.remove()},2e3)}a(r,"end");let s=document.createElement("div");s.style.opacity="0",s.classList.add("prompt"),s.innerHTML="<p>"+e+"<p><br />";let i=document.createElement("input");i.type="text",i.value=t,i.addEventListener("keydown",l=>{l.key=="Enter"&&r()}),s.appendChild(i),setTimeout(()=>{i.focus()},100),s.appendChild(document.createElement("br"));let o=document.createElement("button");o.innerHTML="OK",s.appendChild(o),o.addEventListener("click",r),bt.appendChild(s),s.fadeIn()})},confirm(e,t=c.uni.ok,n=c.uni.cancel){return new Promise(r=>{function s(d){return()=>{r(d),i.fadeOut(),setTimeout(()=>{i.remove()},2e3)}}a(s,"end");let i=document.createElement("div");i.style.opacity="0",i.classList.add("prompt"),i.innerHTML="<p>"+e+"<p><br />";let o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-evenly";let l=document.createElement("button");l.innerHTML=n||c.uni.cancel,l.addEventListener("click",s(!1)),o.appendChild(l);let u=document.createElement("button");u.innerHTML=t||c.uni.ok,u.addEventListener("click",s(!0)),o.appendChild(u),i.appendChild(o),bt.appendChild(i),i.fadeIn()})},selectPrompt(e,t,n=[],r=[]){return new Promise(s=>{function i(){s(l.value),o.fadeOut(),setTimeout(()=>{o.remove()},2e3)}a(i,"end");let o=document.createElement("div");o.style.opacity="0",o.classList.add("prompt"),o.innerHTML="<p>"+e+"<p><br />";let l=document.createElement("select");for(let d=0;d<r.length;d++){let h=r[d],f=document.createElement("optgroup");f.label=h.name;for(let v=0;v<h.options.length;v++){let _=document.createElement("option");_.value=h.options[v]||h.options[v],_.innerHTML=h.options[v],f.appendChild(_)}l.appendChild(f)}for(let d=0;d<t.length;d++){let h=document.createElement("option");h.value=n[d]||t[d],h.innerHTML=t[d],l.appendChild(h)}l.querySelector("option").selected=!0,o.appendChild(l),o.appendChild(document.createElement("br"));let u=document.createElement("button");u.innerHTML="OK",o.appendChild(u),u.addEventListener("click",i),bt.appendChild(o),o.fadeIn()})},promptTime(e,t="datetime-local",n,r){return new Promise(s=>{function i(){s(l.value),o.fadeOut(),setTimeout(()=>{o.remove()},2e3)}a(i,"end");let o=document.createElement("div");o.style.opacity="0",o.classList.add("prompt"),o.innerHTML="<p>"+e+"<p><br />";let l=document.createElement("input");l.type=t,l.value="00:00",n&&(l.min=new Date(n).toISOString()),r&&(l.max=new Date(r).toISOString()),l.addEventListener("keydown",d=>{d.key=="Enter"&&i()}),o.appendChild(l),setTimeout(()=>{l.focus()},100),o.appendChild(document.createElement("br"));let u=document.createElement("button");u.innerHTML="OK",o.appendChild(u),u.addEventListener("click",i),bt.appendChild(o),o.fadeIn()})}},y=Kn});function Fo(e){let t=Hs[e[0]],n=Ds[e[1]];return c.InternalCode[t][n][e]||e}var Hs,Ds,ln,Xn=b(()=>{j();Hs=(i=>(i[i.Info=1]="Info",i[i.Success=2]="Success",i[i.RedirectOrWaiting=3]="RedirectOrWaiting",i[i.UserError=4]="UserError",i[i.ServerError=5]="ServerError",i))(Hs||{}),Ds=(r=>(r[r.General=0]="General",r[r.Socket=1]="Socket",r[r.Express=2]="Express",r))(Ds||{});a(Fo,"changeCodeToString");ln=Fo});var As={};le(As,{send:()=>Po});var Po,Fs=b(()=>{V();Po=a(e=>{y.uiMsg(e)},"send")});var Yn,jo,at,mn=b(()=>{T();W();se();P();oe();$();V();j();en();gt();g("helpers/stateManager");Yn={handle(e,...t){let n=jo[e];return n?n(...t)||!0:!1},async handleArray(e){for(let t of e){let n=Array.isArray(t.value)?t.value:[t.value];await Yn.handle(t.type,...n),await delay(100)}},async handleGetParam(){let e=new URLSearchParams(window.location.search),t=[];for(let[n,r]of e.entries()){let[s,i,o]=n.split("_");if(s!="ctrl"||!i||!o)continue;let l=parseInt(i);isNaN(l)||t.push({type:o,value:r,num:l})}t.sort((n,r)=>n.num-r.num),await Yn.handleArray(t)},removeControlParams(){let e=new URLSearchParams(window.location.search);Array.from(e.entries()).forEach(([r])=>{r.startsWith("ctrl_")&&e.delete(r)});let t=e.toString(),n=window.location.origin+window.location.pathname+(t?"?"+t:"");window.history.replaceState({},"",n)},extractUrl(){let e=window.location.origin+window.location.pathname,t=new URLSearchParams(window.location.search);m.chat.to.startsWith("$")?t.set("ctrl_1_chat",m.chat.to):t.set("ctrl_1_cc",m.chat.to+"_"+m.chat.chnl);let n=e+"?"+t.toString();setTimeout(()=>{L.writeToClipboard(n).then(r=>{r&&y.uiMsgT(c.ui.copied)})},2e3)}},jo={chat(e){L.validId(e)&&C.changeChat(e)},chnl(e){L.validId(e)&&C.changeChnl(e)},cc(e){let[t,n]=e.split("_");L.validId(t)&&(!L.validId(n)&&n!="main"||C.changeChat(t,n))},async call(e){!L.validId(e)||!await y.confirm(U(c.ui.confirm.call_to,E.www.changeUserID(e)))||p.emit("call.dm.init",e)},realmEvt(){_t.show()},friendReq(){Se.changeView("requests")}},at=Yn});var Rs={};le(Rs,{receiveMessage:()=>js,send:()=>Ps});var Ps,js,un,$s=b(()=>{$();ie();P();mn();Ps=a(e=>{window.electronAPI.send(JSON.stringify(e))},"send"),js=a(e=>{switch(e=JSON.parse(e),e.type){case"debug":x.msg(1,e.msg);break;case"status":if(!m.settings.desktopHandling)return;let t=e.data;t==="clear"?p.emit("status.activity.remove"):typeof t=="object"&&!Array.isArray(t)&&p.emit("status.activity.set",e.data);break;case"ctrl":typeof e.ctrl=="object"&&!Array.isArray(e.ctrl)&&(e.ctrl=[e.ctrl]);let n=e.ctrl.map(r=>({type:r[0],value:r.slice(1)}));at.handleArray(n);break}},"receiveMessage"),un=document.createElement("div");un.style.display="none";un.id="electronApiDiv";un.addEventListener("electronAPI",e=>{js(e.detail)});document.querySelector("#assets").appendChild(un);setTimeout(()=>{Ps({type:"desktopHandling",data:m.settings.desktopHandling})},5e3)});var qs={};le(qs,{receiveAudio:()=>$o,receiveMessage:()=>Ro,send:()=>Gn});var Gn,Ro,Jn,$o,Us=b(()=>{P();ie();mn();Gn=a(e=>{window.ReactNativeWebView.postMessage(JSON.stringify(e))},"send"),Ro=a(e=>{switch(e=JSON.parse(e),e.type){case"debug":x.msg(1,e.msg);break;case"close":p.disconnect();break;case"unclose":p.connect();break;case"ctrl":typeof e.ctrl=="object"&&!Array.isArray(e.ctrl)&&(e.ctrl=[e.ctrl]);let t=e.ctrl.map(n=>({type:n[0],value:n.slice(1)}));at.handleArray(t);break}},"receiveMessage"),Jn={init(){this.audioContext=new AudioContext,this.destination=this.audioContext.createMediaStreamDestination();let e=this.destination.stream.getAudioTracks()[0];this.mediaStream=new MediaStream([e])},base64ToArrayBuffer(e){let t=window.atob(e),n=t.length,r=new Uint8Array(n);for(let s=0;s<n;s++)r[s]=t.charCodeAt(s);return r.buffer},async handleAudioData(e){try{let t=await this.audioContext.decodeAudioData(e),n=this.audioContext.createBufferSource();n.buffer=t,n.connect(this.destination),n.start()}catch(t){x.msg(4,"Error processing audio data: "+t)}},async getStream(){return Gn({type:"startAudio"}),await globalThis.delay(1e3),this.mediaStream}},$o=a(async e=>{let t=Jn.base64ToArrayBuffer(e);Jn.handleAudioData(t)},"receiveAudio");setTimeout(()=>{try{Jn.init()}catch(e){x.msg(4,e)}},1e3);setTimeout(()=>{p.emit("fireToken.get",localStorage.getItem("token"),e=>{Gn({type:"fireToken",fireToken:e})})},5e3)});var Os={};le(Os,{send:()=>qo});var qo,Vs=b(()=>{V();qo=a(e=>{y.uiMsg(e)},"send");setTimeout(()=>{y.uiMsg("Warning: Fusion Chat is being loaded within an external source. Proceed with caution.")},5500)});var Ae,E,W=b(()=>{T();ie();V();$();Q();mt();j();Xn();Ee();g("apis");Ae={www:{changeUserID(e){let t=m.chat.to,n=D.temp.user;if(t.startsWith("$")||t=="main"){if(n.main[e])return n.main[e];let s=Ae.www.getInServer("/api/id/u?id="+e).name;return s?(n.main[e]=s,s):"Unknown"}n[t]||(n[t]={});let r=n[t][e];if(r)return r;if(r==0)return n.main[e];if(e.startsWith("%")){let s=Ae.www.getInServer("/api/id/wh?id="+e.replace("%","")+"&chat="+t).name+" (APP)";return s?(n[t][e]=s,s):"Unknown"}else if(e.startsWith("^")){let s=Ae.www.getInServer("/api/id/bot?id="+e.replace("^","")+"&chat="+t).name+" (BOT)";return s?(n[t][e]=s,s):"Unknown"}else if(e.startsWith("(")){let s=Ae.www.getInServer("/api/id/event?id="+e.replace("(","")).name+" (EVENT)";return s?(n[t][e]=s,s):"Unknown"}else{let s=Ae.www.getInServer("/api/id/u?id="+e+"&chat="+t);if(!s)return"Unknown";if(s.c==1)return n[t][e]=s.name,s.name;if(s.c==0){if(n[t][e]=0,n.main[e])return n.main[e];let i=Ae.www.getInServer("/api/id/u?id="+e).name;return i?(n.main[e]=i,i):"Unknown"}else return n.main[e]=s.name,s.name}},changeChat(e){if(D.temp.realm[e])return D.temp.realm[e];let t=Ae.www.getInServer("/api/id/chat?chat="+e).name;return D.temp.realm[e]=t,t},getInServer(e){let t=ke.get(e),n=JSON.parse(t);return n.err?(y.uiMsgT(c.api.error_fetch,["."]),y.uiMsgT(c.api.error,ln(n.c)),x.msg(4,n),null):n}},app:{async init(){let e={isElectron:navigator.userAgent.toLowerCase().includes("electron"),isInIframe:window.self!==window.top,isReactNative:!!window.ReactNativeWebView},t="web";e.isElectron?t="ele":e.isReactNative?t="rn":e.isInIframe&&(t="if"),this.apiType=t;let n={web:a(()=>Promise.resolve().then(()=>(Fs(),As)),"web"),ele:a(()=>Promise.resolve().then(()=>($s(),Rs)),"ele"),rn:a(()=>Promise.resolve().then(()=>(Us(),qs)),"rn"),if:a(()=>Promise.resolve().then(()=>(Vs(),Os)),"if")};Ae.api=await n[t](),x.msg(1,"load api: "+t)},apiType:""},api:{send(e){x.msg(1,"default api: "+JSON.stringify(e))}}},E=Ae;Y.apis=Ae});var Et,x,ie=b(()=>{T();W();Q();g("debug");Et={isDebug:localStorage.getItem("config.debug")=="true",lvl:parseInt(localStorage.getItem("config.debugLvl"),10)||0,init(){setTimeout(()=>{E.app.apiType=="rn"&&(this.isDebug=!0,this.lvl=15)},1e3)},msg(e,...t){this.isDebug&&(this.lvl&e)!==0&&(lo(...t),E.app.apiType=="rn"&&E.api.send({type:"debug",msg:t.length==1?t[0]:t}))}},x=Et;re.debug={enable(e,t,n,r){Et.isDebug=e||t||n||r;let s=(e?1:0)|(t?2:0)|(n?4:0)|(r?8:0);localStorage.setItem("config.debug",Et.isDebug.toString()),localStorage.setItem("config.debugLvl",s.toString())},disable(){Et.isDebug=!1,Et.lvl=0,localStorage.setItem("config.debug",Et.isDebug.toString()),localStorage.setItem("config.debugLvl","0")}}});function Bs(){x.msg(1,"connected to socket"),p.emit("realm.get"),p.emit("self.status.get"),p.emit("dm.get")}function Ns(e,...t){if(x.msg(4,e,...t),t.length==0)return;let n=t[0];if(/^[1-5][0-2]\.\d{3}$/.test(n)){y.uiMsgT(c.api.error,ln(n));return}y.uiMsg(n)}function Ws(e,t,...n){y.uiMsgT(c.socket.valid_error),x.msg(4,`Valid error: ${e} - ${t}`,...n)}function zs(e,...t){let n=c.socket.spam,s={"last warning":n.last,ban:n.ban,warn:n.warn}[e]||n.spam;y.uiMsgT(s,[],...t)}function Ks(e){localStorage.getItem("token")||(window.location.href="/login?err=true"),x.msg(8,e);let t=e.toString();if(t.includes("Error: Authentication error"))window.location.href="/login?err=true";else if(t.includes("Ban:")){let n=t.match(/Ban: You are temporarily banned. Please try again after (\d+) minutes./),r="",s="";n?(r=c.socket.ban,s=n[1]):(r=t,s=""),y.uiMsgT(r,s);return}y.uiMsg(e.toString(),{extraTime:10})}function Xs(e,t){localStorage.setItem("token",e),p.auth.token=e,t(!0)}async function Ys(e,...t){let n=[];if(Array.isArray(e))n=e;else if(typeof e=="string")n=[e];else if(typeof e=="object"){let{realm:r,chnl:s,evt:i,wait:o}=e;if(n=typeof i=="string"?[i]:Array.isArray(i)?i:[],r&&r!=m.chat.to&&r!=="*"||s&&s!=m.chat.chnl&&s!=="*")return;o&&await delay(o)}else return;n.forEach(r=>{p.emit(r,...t)})}function Ts(e,t){m.user.status=e,m.user.statusText=t,nt.localUserProfile()}function Js(e,t,n){if(!(!e||!t||!n))try{D.lastMess[e]=D.lastMess[e]||{},D.lastMess[e][t]=D.lastMess[e][t]||{read:null,mess:null},D.lastMess[e][t].read=n,e.startsWith("$")&&$e.chats()}catch{}}function Ls(e,t){m.realm.users=e,m.realm.roles=t,ft.usersInChat()}function ks(e){e.forEach(t=>{let{uid:n,status:r,activity:s}=t;!r&&!s||we.set(n,t)})}function Cs(e,t){p.emit("realm.event.get.topic",e,t,n=>{let r=U(c.ui.event.notif,`<b>"${n}"</b>`,`<b>${E.www.changeChat(e)}</b>`);y.uiMsg(r,{onClick:a(()=>{C.changeChat(e).then(()=>{_t.show()})},"onClick")})})}function On(e,t,n){we.set(e,{status:t,statusText:n})}var an=b(()=>{T();P();$();ie();W();se();Ft();V();Gt();Xt();en();j();Xn();Ee();Ht();g("socket/evt");a(Bs,"connect");a(Ns,"error");a(Ws,"error_valid");a(zs,"error_spam");a(Ks,"connect_error");a(Xs,"system_refreshToken");a(Ys,"refreshData");a(Ts,"self_status_get");a(Js,"message_mark_read");a(Ls,"realm_users_sync");a(ks,"realm_users_activity_sync");a(Cs,"realm_event_notify");a(On,"user_status_update")});var Uo={};var Gs=b(()=>{T();P();an();g("socket/_evt");p.on("connect",Bs);p.on("error",Ns);p.on("error.valid",Ws);p.on("error.spam",zs);p.on("connect_error",Ks);p.on("system.refreshToken",Xs);p.on("refreshData",Ys)});var Oo={};var Zs=b(()=>{T();P();Pt();an();$();rn();g("mess/socket");p.on("mess",ps);p.on("message.fetch",sn);p.on("message.fetch",e=>{qe.addMessages(m.chat.to,m.chat.chnl,e)});p.on("message.delete",fs);p.on("messages.delete",hs);p.on("message.edit",gs);p.on("message.react",_s);p.on("message.search",vs);p.on("realm.thread.delete",bs);p.on("message.mark.read",Js)});var No={};function Vo(e){if(!Qs())return;e.preventDefault();let t=(e.clipboardData||window.clipboardData).getData("text");ve.value+=t,F.setSelectionStart(),F.sendBtnStyle(),F.messageHeight()}function Bo(e){if(!Qs())return;let t=(e.clipboardData||e.originalEvent.clipboardData).items;for(let n of t){if(n.type.indexOf("image")===-1)continue;e.preventDefault();let r=n.getAsFile();Me.sendFile(r)}}function Qs(){let e=document.activeElement.tagName.toLowerCase();return!(e=="input"||e=="textarea")}var ve,ei=b(()=>{T();ut();Ke();$();K();cn();g("mess/listeners");({input:ve}=M);ve.addEventListener("keydown",e=>{e.key=="Enter"&&(e.shiftKey||(e.preventDefault(),Me.sendMess()))});ve.addEventListener("keydown",e=>{if(e.key!="ArrowUp"||ve.value.length>0)return;e.preventDefault();let t=document.querySelectorAll(".mess_message"),n=Array.from(t).reverse().find(s=>s.querySelector(".mess_meta").getAttribute("_author")===m.user._id);if(!n)return;let r=n.id.split("mess__")[1];r&&He.editMess(r)});ve.addEventListener("keydown",e=>{if(e.key!="ArrowDown"||ve.value.length>0)return;e.preventDefault();let t=document.querySelector(".mess_message:last-child");if(!t)return;let n=t.id.split("mess__")[1];n&&(m.temp.replyId=n,M.replyClose.style.display="block",t.style.backgroundColor="var(--panel)")});ve.addEventListener("input",F.sendBtnStyle);ve.addEventListener("input",F.messageHeight);a(Vo,"pasteText");a(Bo,"pasteImage");a(Qs,"pasteCheck");document.addEventListener("paste",Vo);document.addEventListener("paste",Bo);document.addEventListener("paste",()=>{if(ve==document.activeElement)return;let e=document.activeElement.tagName.toLowerCase();e=="input"||e=="textarea"||(ve.focus(),F.setSelectionStart())});document.addEventListener("keydown",e=>{if(ve==document.activeElement||e.ctrlKey||e.altKey)return;let t=document.activeElement.tagName.toLowerCase();t=="input"||t=="textarea"||(ve.focus(),F.setSelectionStart())});document.addEventListener("keydown",e=>{e.key=="Delete"&&m.chat.selectedMess&&He.deleteMess(m.chat.selectedMess)})});function Wo(e,t,n,r,s){let i,o,l,u;e.addEventListener("touchstart",_=>{i=_.touches[0].clientX,o=_.touches[0].clientY}),e.addEventListener("touchend",_=>{l=_.changedTouches[0].clientX,u=_.changedTouches[0].clientY,!v(_.target)&&f()}),e.addEventListener("mousedown",_=>{i=_.clientX,o=_.clientY,e.addEventListener("mouseup",h)});function h(_){l=_.clientX,u=_.clientY,v(_.target)||f(),e.removeEventListener("mouseup",h)}a(h,"onMouseUp");function f(){let _=i-l,w=o-u;if(Math.abs(_)>Math.abs(w)){if(Math.abs(_)<100)return;_>0?t&&t():n&&n()}else{if(Math.abs(w)<100)return;w>0?r&&r():s&&s()}}a(f,"handleSwipe");function v(_){let w=Math.abs(i-l),I=Math.abs(o-u);return w>I&&_.scrollWidth!=_.clientWidth||I>w&&_.scrollHeight!=_.clientHeight}a(v,"shouldIgnoreSwipe")}var ti,ni=b(()=>{T();g("swipeLib");a(Wo,"setupSwipe");ti=Wo});var zo={};var ri=b(()=>{T();$();ut();ni();et();K();g("features");document.querySelector("#nav__toggle").addEventListener("click",()=>{let e=document.querySelector("nav").style;e.left=e.left=="0px"?"-360px":"0px"});document.querySelector("#navs__user img").src="/api/profile/img?id="+m.user._id;H.navs__user.setAttribute("data-status-id",m.user._id);document.querySelector("#app").addEventListener("contextmenu",e=>{let n=e.target.tagName.toLowerCase();me.contextmenuTags.includes(n)||e.preventDefault()});ti(document.body,()=>{document.querySelector("nav").style.left="-360px"},()=>{document.querySelector("nav").style.left="0px"},()=>{},()=>{});a(function(){let t=document.querySelector("#app");t.addEventListener("dragover",function(n){n.preventDefault(),n.stopPropagation()}),t.addEventListener("dragenter",function(n){n.preventDefault(),n.stopPropagation()}),t.addEventListener("drop",function(n){if(n.preventDefault(),n.stopPropagation(),m.chat.to=="main")return;let r=n.dataTransfer.files;for(let s of r)Me.sendFile(s)})},"initDragAndDrop")()});function si(e){let n=`img[src*="${L.escape(`/api/profile/img?id=${e}`)}"]`;document.querySelectorAll(n).forEach(s=>{let i=new URL(s.src);i.searchParams.set("t",new Date().getTime().toString()),s.src=i.toString()})}var ii=b(()=>{T();oe();g("helpers/reloadImages");a(si,"reloadProfileImages")});var Ko,Zn,oi=b(()=>{T();$();W();kt();V();Gt();P();et();ii();j();Ee();Ht();g("settingsData");Ko={user:a(()=>[{name:"User settings",txt:c.settings_user.user_settings,type:"obj",settings:[{name:"Status",txt:c.settings_user.status,type:"select",defaultValue:m.user.status||"online",options:["online","idle","dnd","offline"]},{name:"Status text",txt:c.settings_user.status_text,type:"text",defaultValue:m.user.statusText||""},{name:"Nickname",txt:c.settings_user.nick,type:"text",defaultValue:E.www.changeUserID(m.user._id)||m.user.fr}]},{name:"Profile image",txt:c.settings_user.image,type:"fn",settings:a(()=>{let e=document.createElement("div"),t={img:null};e.innerHTML=`
                    <div id="_1" style="display: flex; align-items: center; column-gap: 2rem;"></div>
                `.trim();let n=e.querySelector("#_1"),r=document.createElement("img");r.src="/api/profile/img?id="+m.user._id+"&t="+Date.now(),r.css("width: 128px; height: 128px; object-fit: cover;"),n.appendChild(r);let s=document.createElement("input");return s.type="file",s.accept=me.uploadImgTypes.join(", "),s.addEventListener("change",i=>{let o=i.target;if(o.files&&o.files[0]){let l=o.files[0];t.img=l,r.src=URL.createObjectURL(l)}}),n.appendChild(s),[e,t]},"settings"),save:a((e,t)=>(t.img&&(Xe.profile(t.img),setTimeout(()=>{si(m.user._id)},3e3)),{}),"save")},{name:"Client settings",txt:c.settings_user.client_settings,type:"obj",settings:[{name:"Language",txt:c.settings_user.lang,type:"select",defaultValue:localStorage.getItem("lang")||"en",options:ot.localesList},{name:"Notifications",txt:c.settings_user.notifications,type:"checkbox",defaultValue:localStorage.getItem("notifications")=="true"||!1,only:["web","ele"]},{txt:c.settings_user.check_notifications_permissions,type:"button",onclick:a(()=>{window.Notification.requestPermission(e=>{e=="granted"?y.uiMsgT(c.uni.ok):y.uiMsgT(c.settings_user.notifications_error)})},"onclick"),only:["web","ele"]},{type:"hr"},{txt:c.settings_user.experimental_features,type:"h2"},{txt:c.settings_user.experimental_warning,type:"h3"},{name:"desktopHandling",txt:"Desktop app handling fullscreen and set activity",type:"checkbox",only:"ele",defaultValue:localStorage.getItem("desktopHandling")=="true"||!1}]},{name:"Account settings",txt:c.settings_user.account_settings,type:"obj",settings:[{name:"Logout",txt:c.settings_user.logout,type:"button",onclick:a(async()=>{let e=c.settings_user.confirm_logout+"?";await y.confirm(e)&&await y.confirm(e+" ("+c.settings_user.double_check+")")&&(localStorage.removeItem("user_id"),localStorage.removeItem("from"),localStorage.removeItem("token"),p.emit("logout",()=>{location.href="/login"}))},"onclick"),css:{color:"red"}},{name:"Delete Account",txt:c.settings_user.delete,type:"button",onclick:a(async()=>{await y.confirm(c.settings_user.confirm_delete.w1+"?")&&await y.confirm(c.settings_user.confirm_delete.w2+"?")&&await y.confirm(c.settings_user.confirm_delete.w3+"?")&&p.emit("user.delete",()=>{localStorage.removeItem("user_id"),localStorage.removeItem("from"),localStorage.removeItem("token"),alert(c.settings_user.after_delete),location.href="/login"})},"onclick"),css:{color:"red"}}]}],"user"),userSave:a(e=>{e.Status!=null&&(m.user.status=e.Status),e["Status text"]!=null&&(m.user.statusText=e["Status text"]),(e.Status!=null||e["Status text"]!=null)&&(p.emit("self.status.update",m.user.status,m.user.statusText),nt.localUserProfile(),we.set(m.user._id,{status:m.user.status,statusText:m.user.statusText})),e.Nickname!=null&&(p.emit("profile.set_nickname",e.Nickname),D.temp.user.main[m.user._id]=e.Nickname,nt.localUserProfile());let t=e.Language;t!=null&&t!=localStorage.getItem("lang")&&Wn(t);let n=e.Notifications;n!=null&&(localStorage.setItem("notifications",n),m.settings.notifications=n,n&&window.Notification.requestPermission(s=>{s!="granted"&&y.uiMsgT(c.settings_user.notifications_error)}));let r=e.desktopHandling;r!=null&&(localStorage.setItem("desktopHandling",r),m.settings.desktopHandling=r,r||p.emit("status.activity.remove"),E.app.apiType=="ele"&&E.api.send({type:"desktopHandling",data:r}))},"userSave")},Zn=Ko});var jt,Qn,ai,ci=b(()=>{T();W();j();g("settingsLib");jt={createCheckbox(e){let t=document.createElement("input");return t.type="checkbox",t.checked=e.defaultValue,t.classList.add("checkbox_switch"),t},createTextInput(e){let t=document.createElement("input");return t.type="text",t.value=e.defaultValue,t},createSelectInput(e){let t=document.createElement("select");return e.options.forEach(n=>{let r=document.createElement("option");r.value=n,r.textContent=n,n===e.defaultValue&&(r.selected=!0),t.appendChild(r)}),t},createButton(e){let t=document.createElement("button");return t.textContent=e.txt||e.name,t.onclick=e.onclick,t}},Qn=class{static{a(this,"SettingsManager")}settings;saveCallback;exitCallback;container;constructor(t,n,r,s){this.settings=t,this.saveCallback=r,this.exitCallback=s,this.container=n,this.init()}init(){this.container.innerHTML="";let t=[];function n(i){return i.filter(o=>{if(!("only"in o)||!o.only)return!0;let l=o.only;return typeof l=="string"&&(l=[l]),!!l.includes(E.app.apiType)})}a(n,"onlyFilter"),this.settings=n(this.settings),this.settings.forEach(i=>{i.type=="obj"&&(i.settings=n(i.settings))}),this.renderCategorySwitcher(),this.settings.forEach(i=>{let o=document.createElement("div");if(o.className="settings__category",o.setAttribute("data-id",i.name),o.innerHTML=`<h1>${i.txt||i.name}</h1>`,i.type=="obj")i.settings.forEach(l=>{let u=document.createElement("div");u.className="settings__setting";function d(){let f=document.createElement("label");f.textContent=l.txt||l.name,f.setAttribute("data-txt",l.name),u.appendChild(f)}a(d,"createLabel");let h;switch(l.type){case"checkbox":d(),h=jt.createCheckbox(l);break;case"text":d(),h=jt.createTextInput(l);break;case"select":d(),h=jt.createSelectInput(l);break;case"button":h=jt.createButton(l);break;case"hr":h=document.createElement("hr");break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":case"p":h=document.createElement(l.type),h.textContent=l.txt||l.name;break;default:d()}h&&(u.appendChild(h),l.css&&h.css(l.css)),o.appendChild(u)});else if(i.type=="fn"){let[l,u]=i.settings(jt);o.appendChild(l),t.push({div:l,save:i.save,tmpData:u})}this.container.appendChild(o)}),this.changeDisplay(this.settings[0]?.name);let r=document.createElement("button");r.textContent=c.settings.save,r.className="settings__exitButton",r.onclick=()=>this.saveSettings(t);let s=document.createElement("button");s.textContent=c.settings.exit_without_save,s.className="settings__exitButton",s.onclick=()=>this.exitWithoutSaving(),this.container.appendChild(document.createElement("br")),this.container.appendChild(r),this.container.appendChild(s),this.container.fadeIn()}renderCategorySwitcher(){let t=document.createElement("div");t.className="settings__categorySwitcher",this.settings.map(r=>r.name).forEach(r=>{let s=document.createElement("button");s.textContent=r,s.className="btn",s.onclick=()=>this.changeDisplay(r),t.appendChild(s)}),this.container.appendChild(t)}changeDisplay(t){let n=this.container;this.settings.map(r=>r.name).forEach(r=>{let s=n.querySelector(`[data-id="${r}"]`);s&&(s.style.display=r===t?"":"none")})}saveSettings(t){if(this.saveCallback&&typeof this.saveCallback=="function"){let n=this.getCurrentSettings(),r=t.map(i=>i.save(i.div,i.tmpData)),s=Object.assign({},n,...r);this.saveCallback(s)}this.container.innerHTML="",this.container.fadeOut()}exitWithoutSaving(){this.exitCallback&&typeof this.exitCallback=="function"&&this.exitCallback(),this.container.innerHTML="",this.container.fadeOut()}getCurrentSettings(){let t={};return this.container.querySelectorAll(".settings__setting").forEach(n=>{let r=n.querySelector("label"),s=n.querySelector("input, select, ul");if(r&&s){let i=s.type==="checkbox"?s.checked:s.value;t[r.getAttribute("data-txt")]=i}}),t}},ai=Qn});var Fe,Z,A,Mt,S,Oe=b(()=>{T();g("rs/utils");Fe=a(function(e){let t=document.createElement("div");return t.className="settings__category",e&&e.appendChild(t),t},"initCategoryElement"),Z=a(function(e,t,n){let r=document.createElement("div");r.innerHTML=`<label>${t}</label>`;let s=document.createElement("input");return s.type="text",s.value=n,r.appendChild(s),e.appendChild(r),s},"initInputText"),A=a(function(e,t,n){let r=document.createElement("button");return r.innerHTML=t,r.onclick=n,r.style.marginInline="3px",e.appendChild(r),r},"initButton"),Mt=a(function(e,t,n){let r=document.createElement("div");r.style.marginBottom="3px";let s=document.createElement("input");s.type="checkbox",s.checked=n||!1,s.classList.add("checkbox_switch"),r.appendChild(s);let i=document.createElement("label");return i.innerHTML=t,r.appendChild(i),e.appendChild(r),s},"initCheckbox"),S=a(function(e=void 0,t=0){let n=document.createElement("div");return n.style.height=t+"px",e&&e.appendChild(n),n},"addSeparator")});function Xo(e){return{meta:Fe(e),category:Fe(e),editChannel:Fe(e),role:Fe(e),editRole:Fe(e),usersManager:Fe(e),emoji:Fe(e),webhook:Fe(e),editWebhook:Fe(e)}}function mi(e){let{settings:t,realmId:n,container:r}=e;li={html:Xo(r),container:r,settings:t,realmId:n,_this:e}}var li,X,Pe=b(()=>{T();Oe();g("rs/var");a(Xo,"initCategories");X=a(()=>li,"default");a(mi,"setData")});var er,tr,dn,nr=b(()=>{T();Pe();V();j();g("rs/save");er=a(async function(){let e=X(),t=e._this,n=e.settings;if(!t.saveCallback&&typeof t.saveCallback!="function"){e.container.innerHTML="";return}t.saveMetaSettings();let r=JSON.parse(JSON.stringify(n.addons));delete n.addons;let s=await t.saveCallback(n);if(n.addons=r,!s){y.uiMsgT(c.settings_realm.failed_to_save);return}return!0},"saveSettings"),tr=a(function(){let e=X(),t=e._this;t.exitCallback&&typeof t.exitCallback=="function"&&t.exitCallback(),e.container.fadeOut(),e.container.innerHTML=""},"exitWithoutSaving"),dn=a(async function(){await er()&&tr()},"saveAndExitSettings")});var pn,rr=b(()=>{T();P();V();kt();se();Pe();Oe();ie();et();j();nr();g("rs/meta");pn=a(function(){let e=X(),t=e.settings;if(!t||!t.meta)return x.msg(4,c.settings_realm.no_data);let n=e.html.meta;n.innerHTML=`<h1>${c.settings_realm.basic_settings}</h1>`;let r=t.meta,s=!1,i=Z(n,c.settings_realm.realm_name,r.name);S(n,10);let o=document.createElement("img");o.id="settings__realmImg",r.img?o.src="/userFiles/realms/"+e.realmId+".png":o.style.display="none",n.appendChild(o);let l=document.createElement("input");l.type="file",l.accept=me.uploadImgTypes.join(", "),l.addEventListener("change",u=>{r.img=!0,s=u.target.files[0],o.src=URL.createObjectURL(u.target.files[0]),o.style.display=""}),n.appendChild(l),S(n,5),A(n,c.settings_realm.remove_image,()=>{o.style.display="none",r.img=!1}),S(n,15),A(n,c.settings_realm.delete_realm,async()=>{let u="? ("+r.name+")",d=[c.settings_realm.delete_realm_confirm.w1,c.settings_realm.delete_realm_confirm.w2,c.settings_realm.delete_realm_confirm.w3];for(let f of d)if(!await y.confirm(f+u))return;let h=await y.prompt(c.settings_realm.confirm_realm_name+"?");if(h!==r.name)return y.uiMsgT(c.settings_realm.delete_wrong_name);dn(),C.changeChat("main"),setTimeout(()=>{p.emit("realm.delete",e.realmId,h)},1e3)}).style.color="red",e._this.saveMetaSettings=()=>{t.meta.name=i.value,s&&Xe.realm(s,e.realmId)}},"renderMeta")});function Yo(e=[1,1]){let t=di();return ui(t,e)}function ui(e,t){let n=t.map(s=>Jo(s)),r=[e,...n].join("-");return sr.has(r)?(e=di(),ui(e,t)):(sr.set(r,!0),setTimeout(()=>{sr.delete(r)},1e3),r)}function Jo(e){return Math.floor(Math.random()*Math.pow(36,e)).toString(36)}function di(){return new Date().getTime().toString(36)}var sr,ct,fn=b(()=>{T();g("genId");sr=new Map;a(Yo,"genId");a(ui,"getUniqueRandom");a(Jo,"getRandom");a(di,"getTime");ct=Yo});var Ve,Go,ir=b(()=>{T();Ne();$();fn();Pe();ie();Oe();j();V();g("rs/roles");Ve=a(function(){let e=X(),t=e.settings;if(!t||!t.roles)return x.msg(4,c.settings_realm.no_data);let n=e.html.role;n.innerHTML=`<h1>${c.settings_realm.roles}</h1>`;let r=t.roles,s=new Map;function i(){r.sort((l,u)=>l.lvl-u.lvl).forEach((l,u)=>l.lvl=u)}a(i,"repairHierarchy");function o(l,u){let d=document.createElement("details");s.set(l._id,d),S(d,5);let h=document.createElement("summary");h.innerHTML=l.name,h.style.color=l.c??"",d.appendChild(h);let f=document.createElement("div");if(l.p<0)f.innerHTML=c.settings_realm.no_perm_to_edit_role;else{let v={summary:h};if(A(d,c.uni.edit,()=>Go(l,v)),l.lvl!=0&&A(d,c.uni.delete,()=>{t.roles=r.filter(_=>_._id!==l._id),i(),Ve()}),u>0){let _=r[u-1];_.p>=0&&A(d,c.settings_realm.move_up,()=>{let w=l.lvl;l.lvl=_.lvl,_.lvl=w,i(),Ve()})}u<r.length-1&&A(d,c.settings_realm.move_down,()=>{let _=r[u+1],w=l.lvl;l.lvl=_.lvl,_.lvl=w,i(),Ve()})}d.appendChild(f),n.appendChild(d),S(d,5)}a(o,"renderRole"),S(n,10),A(n,c.uni.add,async()=>{let l=ct(),d={name:await y.prompt(c.settings_realm.enter_name)||"New role",lvl:r.length,p:0,_id:l};t.roles.push(d),i(),Ve()});for(let l=0;l<t.roles.length;l++)o(t.roles[l],l)},"renderRoles"),Go=a(function(e,t){let n=X().html.editRole;n.innerHTML=`<h1>${c.settings_realm.edit_role}</h1>`;let r=Z(n,c.settings.name,e.name);r.onchange=()=>{e.name=r.value,t.summary.innerHTML=e.name},S(n,5);let s=document.createElement("input");s.type="color",s.value=e.c||"",s.onchange=()=>{e.c=s.value,t.summary.style.color=e.c??null},n.appendChild(s),S(n,5);function i(){let d=0;return o.forEach((h,f)=>{h.checked&&(d+=1<<f)}),d}a(i,"caclulatePermissionsByCheckBoxs");let o=[],l=["admin","manage_messages","ban_user","mute_user","kick_user","manage_roles","manage_emojis","manage_invites","manage_webhooks","manage_channels"],u=m.realm.permission||0;l.forEach((d,h)=>{let f=te.hasPermission(e.p,1<<h),v=Mt(n,c.settings_realm.role_permissions[d],f);if(te.hasPermission(u,1<<h))v.onchange=()=>e.p=i();else{v.disabled=!0;let _=v.nextElementSibling;_.style.textDecoration="line-through"}o.push(v)}),S(n,10),A(n,c.uni.close,()=>{Ve(),n.fadeOut()}),n.fadeIn()},"renderRoleEdit")});var wt,or=b(()=>{T();P();kt();ie();Pe();Oe();et();j();g("rs/emoji");wt=a(function(){let e=X(),t=e.settings;if(!t||!t.emojis)return x.msg(4,c.settings_realm.no_data);e.html.emoji.innerHTML=`<h1>${c.settings_realm.emoji_manager}</h1>`;let n=document.createElement("button");n.innerHTML=c.settings_realm.upload_emoji,n.onclick=()=>{let s=document.createElement("input");s.type="file",s.accept=me.uploadImgTypes.join(","),s.onchange=async()=>{let i=s.files[0];i&&(Xe.emocji(i,e.realmId),setTimeout(()=>{p.emit("realm.emojis.sync",e.realmId,o=>{t.emojis=o,wt()})},1e3))},s.click()},e.html.emoji.appendChild(n);function r(s){let i=document.createElement("div");i.classList.add("emoji__container");let o=document.createElement("img");o.src="/userFiles/realms/"+e.realmId+"/emojis/"+s.emoji+".png",o.style.width="64px",i.appendChild(o);let l=Z(i,c.settings.name,s.name);l.addEventListener("change",()=>{s.name=l.value}),A(i,c.uni.delete,()=>{let u=t.emojis;u.splice(u.indexOf(s),1),wt()}),e.html.emoji.appendChild(i)}a(r,"renderEmoji");for(let s of t.emojis)r(s)},"renderEmojis")});var ae,Zo,Qo,ea,ar=b(()=>{T();Pe();W();fn();V();ie();P();j();Oe();g("rs/channels");ae=a(function(){let e=X(),t=e.settings;if(!t||!t.categories||!t.channels)return x.msg(4,c.settings_realm.no_data);let n=e.html.category;n.innerHTML=`<h1>${c.settings_realm.categories_and_channels}</h1>`;let r=t.categories.sort((i,o)=>i.i-o.i),s=t.channels;A(n,c.settings_realm.add_category,async()=>{let i=await y.prompt(c.settings_realm.enter_name);t.categories.push({cid:ct(),name:i||"New Category",i:t.categories.length}),ae()}),r.forEach(i=>{S(n,15);let o=document.createElement("div");o.innerHTML=`<span style="font-size: 1.5rem" class="settings__nameSpan">- ${i.name}</span>`,A(o,c.settings_realm.move_up,()=>{if(i.i===0)return;let u=i.i;t.categories[u].i=u-1,t.categories[u-1].i=u,ae()}),A(o,c.settings_realm.move_down,()=>{if(i.i===r.length-1)return;let u=i.i;t.categories[u].i=u+1,t.categories[u+1].i=u,ae()}),A(o,c.uni.edit,()=>{n.querySelectorAll("div").forEach(u=>u.style.border=""),o.style.border="3px dotted var(--accent)",Qo(i)}),A(o,c.settings_realm.add_channel,async()=>{let u=await y.prompt(c.settings_realm.enter_name),{text:d,voice:h,announcement:f,open_announcement:v,forum:_}=c.settings_realm.channel_types,w=await y.selectPrompt(c.settings_realm.select_type,[d,h,f,v,_],["text","voice","announcement","open_announcement","forum"]),I={name:u||"New Channel",type:w||"text",category:i.cid,i:s.filter(J=>J.category===i.cid).length,rp:[],chid:ct(),desc:""};t.channels.push(I),ae()}),S(o,10);let l=s.filter(u=>u.category===i.cid).sort((u,d)=>u.i-d.i);l.forEach(u=>{let d=document.createElement("div");d.innerHTML=`<span style="font-size: 1.2rem" class="settings__nameSpan">${"&nbsp;".repeat(3)}+ ${u.name} (${u.type})</span>`,A(d,c.settings_realm.move_up,()=>{if(u.i===0)return;let h=u.i,f=t.channels.findIndex(_=>_.category!==u.category?!1:_.i===h),v=t.channels.findIndex(_=>_.category!==u.category?!1:_.i===h-1);f===-1||v===-1||(t.channels[f].i=h-1,t.channels[v].i=h,ae())}),A(d,c.settings_realm.move_down,()=>{if(u.i>=l.length-1)return;let h=u.i,f=t.channels.findIndex(_=>_.category!==u.category?!1:_.i===h),v=t.channels.findIndex(_=>_.category!==u.category?!1:_.i===h+1);f===-1||v===-1||(t.channels[f].i=h+1,t.channels[v].i=h,ae())}),A(d,c.uni.edit,()=>{n.querySelectorAll("div").forEach(h=>h.style.border=""),d.style.border="3px dotted var(--accent)",Zo(u)}),o.appendChild(d),S(o,10)}),n.appendChild(o)})},"renderChannels"),Zo=a(function(e){let t=X(),n=t.html.editChannel,r=t.settings;n.innerHTML=`<h1>${c.settings_realm.edit_channel}</h1>`;let s=Z(n,c.settings.name,e.name),i=Z(n,c.settings.description,e.desc||"");function o(u){let d=document.createElement("details"),h=document.createElement("summary");h.innerHTML=u.name,d.appendChild(h);let f=e.rp.find(v=>v.startsWith(u._id));f=f?parseInt(f.split("/")[1]):0,ea().forEach((v,_)=>{let w=f&1<<_,I=Mt(d,v,!!w);I.setAttribute("data-role",u._id),I.setAttribute("data-perm",_.toString())}),n.appendChild(d),S(d,5)}a(o,"renderRole"),r.roles.forEach(o);let l=r.addons.subscribedChannels.filter(u=>u.tc===e.chid);if(l.length>0){S(n,10);let u=document.createElement("details"),d=document.createElement("summary");d.innerHTML=c.settings_realm.subscribed_channels,u.appendChild(d);let h=document.createElement("ul");l.forEach(f=>{let v=document.createElement("li");v.style.marginLeft="1.2rem",v.innerHTML=E.www.changeChat(f.sr)+" - "+f.name;let _=document.createElement("button");_.style.marginLeft="1rem",_.innerHTML=c.settings_realm.unsubscribe_channel,_.addEventListener("click",async()=>{let w=U(c.settings_realm.confirm_unsubscribe,E.www.changeChat(f.sr)+" - "+f.name)+"?";await y.confirm(w)&&(p.emit("realm.announcement.channel.unsubscribe",f.sr,f.sc,t.realmId,f.tc),r.addons.subscribedChannels=r.addons.subscribedChannels.filter(J=>J!==f),v.remove())}),v.appendChild(_),h.appendChild(v)}),u.appendChild(h),n.appendChild(u)}S(n,15),A(n,c.settings.save,()=>{e.name=s.value;let u=i.value;e.desc=u.trim()===""?void 0:u;let d=r.roles,h=new Map;d.forEach(f=>h.set(f._id,0)),n.querySelectorAll("input[type=checkbox][data-role][data-perm]").forEach(f=>{if(!f.checked)return;let v=f.getAttribute("data-role"),_=f.getAttribute("data-perm"),w=h.get(v),I=1<<parseInt(_);h.set(v,w|I)}),e.rp=Array.from(h).filter(([,f])=>f!==0).map(([f,v])=>`${f}/${v}`),ae(),n.fadeOut()}),A(n,c.uni.cancel,()=>{ae(),n.fadeOut()}),A(n,c.uni.delete,()=>{let u=r.channels.findIndex(d=>d===e);u!==-1&&(r.channels.splice(u,1),ae(),n.fadeOut())}),n.fadeIn()},"renderEditChannel"),Qo=a(function(e){let t=X(),n=t.settings;if(!n||!n.categories)return x.msg(4,"No settings data");let r=t.html.editChannel;r.innerHTML=`<h1>${c.settings_realm.edit_category}</h1>`;let s=Z(r,c.settings.name,e.name);S(r,15),A(r,c.settings.save,()=>{e.name=s.value,ae(),r.fadeOut()}),A(r,c.uni.cancel,()=>{ae(),r.fadeOut()}),A(r,c.uni.delete,()=>{let i=n.categories.findIndex(o=>o.cid===e.cid);i!==-1&&(n.categories.splice(i,1),ae(),r.fadeOut())}),r.fadeIn()},"renderEditCategory"),ea=a(()=>[c.settings_realm.mess_permissions.view,c.settings_realm.mess_permissions.write,c.settings_realm.mess_permissions.files,c.settings_realm.mess_permissions.reactions,c.settings_realm.mess_permissions.thread,c.settings_realm.mess_permissions.thread_view,c.settings_realm.mess_permissions.thread_write],"vars_channelsFlags")});var ta,lt,pi,cr=b(()=>{T();fn();V();Pe();oe();Oe();j();ie();P();g("rs/webhooks");ta=["text","open_announcement","announcement"],lt=a(function(){let e=X(),t=e.settings;if(!t||!t.webhooks)return x.msg(4,c.settings_realm.no_data);let n=e.html.webhook;n.innerHTML=`<h1>${c.settings_realm.webhooks.webhook}</h1>`,A(n,c.settings_realm.add_webhook,()=>{function r(l,u){l=l.sort((d,h)=>d.i-h.i);for(let d of l){let h=u.filter(f=>f.type==="text"&&f.category===d.cid).sort((f,v)=>f.i-v.i);if(h.length>0)return h[0].chid}return null}a(r,"findFirstTextChannel");let s="$"+ct(),i=r(t.categories,t.channels);if(!i)return y.uiMsgT(c.settings_realm.no_channels);let o={whid:s,name:"Webhook",template:"$content",chnl:i,ajv:{},required:[]};t.webhooks.push(o),lt(),pi(s)}),S(n,15),t.webhooks.forEach(r=>{let s=document.createElement("div");s.innerHTML=r.name,A(s,"Edit",()=>{pi(r.whid)}),n.appendChild(s)})},"renderWebhooks"),pi=a(function(e){let t=X(),n=t.settings,r=t.html.editWebhook;r.innerHTML=`<h1>${c.settings_realm.edit_webhook}</h1>`;let s=n.webhooks.find(R=>R.whid==e);if(!s)return y.uiMsgT(c.settings_realm.webhooks.not_found);if(s.whid.startsWith("$")){let R=document.createElement("span");R.innerHTML=c.settings_realm.webhooks.get_url_before,r.appendChild(R)}else{let R=document.createElement("button");R.innerHTML="URL (POST) "+c.uni.copy,R.onclick=()=>{p.emit("realm.webhook.token.get",t.realmId,s.whid,N=>{let ne=`${window.location.origin}/api/webhook/custom?token=${N}`;L.writeToClipboard(ne).then(ce=>{ce&&y.uiMsgT(c.ui.copied)})})},r.appendChild(R)}let i=c.settings_realm.webhooks;S(r,15);let o=Z(r,c.settings.name,s.name);S(r,5);let l=Z(r,i.template,s.template);function u(R,N){let ne=document.createElement("select");R=R.sort((ce,ye)=>ce.i-ye.i);for(let ce of R){let ye=document.createElement("optgroup");ye.label=ce.name,N.filter(be=>be.category===ce.cid).filter(be=>ta.includes(be.type)).sort((be,Le)=>be.i-Le.i).forEach(be=>{let Le=document.createElement("option");Le.value=be.chid,Le.innerHTML=be.name,ye.appendChild(Le)}),ne.appendChild(ye)}return ne}a(u,"renderChnls"),S(r,5);let d=document.createElement("label");d.innerHTML=i.channel,r.appendChild(d);let h=u(n.categories,n.channels);h.value=s.chnl,r.appendChild(h),S(r,10);let f=document.createElement("div");f.innerHTML=`<h2>${i.advanced}</h2>`;let v=Z(f,i.ajv,JSON.stringify(s.ajv)||"{}");S(f,5);let _=Z(f,i.required_fields,JSON.stringify(s.required)||"[]");r.appendChild(f),S(r,10);let w=document.createElement("div");w.innerHTML=`<h2>${i.embed_settings}</h2>`,S(w,5);let I=s.embed,J=Z(w,i.title,I?.title||"");S(w,5);let he=Z(w,i.url,I?.url||"");S(w,5);let Be=Z(w,c.settings.description,I?.description||"");S(w,5);let Ge=Z(w,i.image,I?.image||"");S(w,5);let je=document.createElement("div");je.innerHTML=`<h3>${i.custom_fields}</h3>`,w.appendChild(je),S(je,5);let Te=[];function Tt(R,N){let ne=document.createElement("li"),ce=document.createElement("input"),ye=document.createElement("input");ce.type="text",ye.type="text",ce.value=R,ye.value=N,ye.classList.add("margin-left");let be={name:ce,value:ye},Le=document.createElement("button");Le.innerHTML=c.uni.delete,Le.classList.add("margin-left"),Le.addEventListener("click",()=>{Te.splice(Te.indexOf(be),1),ne.remove()}),ne.appendChild(ce),ne.appendChild(ye),ne.appendChild(Le),S(ne,5),z.appendChild(ne),Te.push(be)}a(Tt,"createEmbedCustomFields"),A(je,c.uni.add,()=>Tt("","")),S(w,5);let z=document.createElement("ul");z.style.listStyleType="none",z.style.paddingLeft="3px",je.appendChild(z),S(z,5),s.embed&&s.embed.customFields&&Object.entries(s.embed.customFields).forEach(([R,N])=>Tt(R,N)),r.appendChild(w),S(r,15),A(r,c.settings.save,()=>{if(s.name=o.value,s.template=l.value,s.ajv=v.value?JSON.parse(v.value):{},s.required=_.value?JSON.parse(_.value):[],s.chnl=h.value,J.value.trim()!==""){let R={title:J.value.trim(),url:he.value.trim(),description:Be.value.trim(),image:Ge.value.trim(),customFields:Te.map(({name:N,value:ne})=>({name:N.value.trim(),value:ne.value.trim()})).reduce((N,{name:ne,value:ce})=>(N[ne]=ce,N),{})};s.embed=R}else s.embed=void 0;lt(),r.fadeOut()}),A(r,c.uni.cancel,()=>{r.fadeOut(),s.embed?.title||(s.embed=void 0)}),A(r,c.uni.delete,()=>{n.webhooks=n.webhooks.filter(R=>R.whid!=e),lt(),r.fadeOut()}),r.fadeIn()},"renderWebhookEdit")});var Je,lr=b(()=>{T();W();$();P();ie();Pe();Oe();j();V();g("rs/users");Je=a(function(){let e=X(),t=e.settings;if(!t||!t.users)return x.msg(4,c.settings_realm.no_data);let n=e.html.usersManager;n.innerHTML=`<h1>${c.settings_realm.users_manager}</h1>`;let r=t.users,s=t.roles;function i(o){let l=document.createElement("details"),u=document.createElement("summary");u.innerHTML=E.www.changeUserID(o.u),l.appendChild(u);let d=document.createElement("div"),h=o.r,f=[];return s.forEach(v=>{if(!v._id)return;let _=Mt(d,v.name,h.includes(v._id));f.push({id:v._id,checkbox:_})}),S(d,10),A(d,c.uni.update,()=>{let v=[];f.forEach(_=>{let{id:w,checkbox:I}=_;I.checked&&v.push(w)}),t.users.find(_=>_===o).r=v,Je()}),o.u!=m.user._id&&(S(d,10),A(d,c.settings_realm.role_permissions.kick_user,async()=>{let v=U(c.settings_realm.user_mgmt_confirms.kick_sure,E.www.changeUserID(o.u))+"?";await y.confirm(v)&&(t.users=t.users.filter(w=>w.u!==o.u),p.emit("realm.user.kick",e.realmId,o.u),Je())}),A(d,c.settings_realm.role_permissions.ban_user,async()=>{let v=U(c.settings_realm.user_mgmt_confirms.ban_sure,E.www.changeUserID(o.u))+"?";await y.confirm(v)&&(t.users=t.users.filter(w=>w.u!==o.u),p.emit("realm.user.kick",e.realmId,o.u,!0),Je())})),l.appendChild(d),S(l,10),l}if(a(i,"renderUser"),r.forEach(o=>{n.appendChild(i(o)),S(n,10)}),t.banUsers.length>0){let o=document.createElement("details"),l=document.createElement("summary");l.innerHTML=c.settings_realm.banned_users,o.appendChild(l),t.banUsers.forEach(u=>{let d=document.createElement("span");d.innerHTML=E.www.changeUserID(u),o.appendChild(d),A(o,c.settings_realm.unban_user,async()=>{let h=U(c.settings_realm.user_mgmt_confirms.unban_sure,E.www.changeUserID(u))+"?";await y.confirm(h)&&(t.banUsers=t.banUsers.filter(v=>v!==v),p.emit("realm.user.unban",e.realmId,u),Je())})}),n.appendChild(o)}},"renderUserRoleManager")});var fi,hi=b(()=>{fi=["meta","category","editChannel","role","editRole","usersManager","emoji","webhook","editWebhook"]});function na(e){let t=a(()=>mr({[e.name]:!0}),"updateDisplay"),n=X(),r=n.settings,s=e.req;if(!s)return t();let i=s.filter(o=>!r[o]);if(i.length==0)return t();p.emit("realm.settings.get",n.realmId,i,o=>{n.settings={...r,...o},e.render?.(),t()})}var mr,gi,_i=b(()=>{T();j();Ne();P();Pe();rr();cr();or();lr();ir();ar();Oe();hi();g("rs/nav");mr=a(function(e){let t=X();for(let n of fi){let r=t.html[n];r.style.display=e[n]?"block":"none"}},"changeDisplay"),gi=a(function(){let t=[{text:c.settings_realm.basic_settings,name:"meta",req:["meta"],render:pn},{text:c.settings_realm.categories_and_channels,name:"category",req:["categories","channels"],p:512,render:ae},{text:c.settings_realm.roles,name:"role",req:["roles"],p:32,render:Ve},{text:c.settings_realm.users_manager,req:["users","banUsers","roles"],name:"usersManager",p:4,render:Je},{text:c.settings_realm.emoji_manager,name:"emoji",req:["emojis"],p:64,render:wt},{text:c.settings_realm.webhooks.webhook,name:"webhook",req:["webhooks"],p:256,render:lt}].map(s=>{let i=!0;s.p&&!te.canAction(s.p)&&(i=!1);let o=document.createElement("button");return o.className="btn",o.textContent=s.text,o.disabled=!i,i&&(o.onclick=()=>{na(s)}),o}),n=document.createElement("div");n.className="settings__categorySwitcher",t.forEach(s=>{n.appendChild(s)});let r=X();r.container.insertAdjacentElement("afterbegin",S(void 0,20)),r.container.insertAdjacentElement("afterbegin",n)},"renderCategorySwitcher");a(na,"categorySwitcherButtonOnClick")});var ur,vi,yi=b(()=>{T();Pe();rr();ir();or();ar();cr();lr();nr();_i();j();g("realmSettings");ur=class{static{a(this,"RealmSettingsManager")}settings;saveCallback;exitCallback;container;realmId;saveMetaSettings;constructor(t,n,r,s,i){if(this.settings=t,this.saveCallback=s,this.exitCallback=i,this.container=r,this.realmId=n,!this.settings){console.warn("No settings found");return}this.container.innerHTML="",mi(this)}init(){if(!this.settings)return console.warn("No settings found");gi(),pn(),ae(),Ve(),Je(),wt(),lt(),mr({meta:!0});let t=document.createElement("button");t.textContent=c.settings.save_and_exit,t.className="settings__exitButton",t.onclick=()=>dn();let n=document.createElement("button");n.textContent=c.settings.save,n.className="settings__exitButton",n.onclick=()=>er();let r=document.createElement("button");r.textContent=c.settings.exit_without_save,r.className="settings__exitButton",r.onclick=()=>tr(),this.container.appendChild(document.createElement("br")),this.container.appendChild(t),this.container.appendChild(n),this.container.appendChild(r),this.container.fadeIn()}},vi=ur});var Ei={};le(Ei,{default:()=>ra});var bi,dr,ra,Mi=b(()=>{T();Q();ie();oi();ci();P();yi();g("settings");bi=document.querySelector("#settings"),dr={showUserSettings(){new ai(Zn.user(),bi,Zn.userSave,()=>{})},showRealmSettings(e,t){new vi(e,t,bi,r=>new Promise(s=>{p.emit("realm.settings.set",t,r,(...i)=>{if(i.length==1&&i[0]===!1)return s(!0);s(!1),x.msg(4,"Error saving realm settings: ",...i)})}),()=>{}).init()}};p.on("realm.settings.get",dr.showRealmSettings);ra=dr;re.settingsFunc=dr});var wi={};le(wi,{default:()=>fr});var pr,fr,hr=b(()=>{T();W();Q();P();g("interact/subscribeEventChnl");pr={popup:document.querySelector("#subscribeEventChnl"),init(){let e=this.popup;this.realms=e.querySelector("#subscribeEventChnl_realms"),this.channels=e.querySelector("#subscribeEventChnl_channels"),this.okBtn=e.querySelector("#subscribeEventChnl_subscribe"),this.cancelBtn=e.querySelector("#subscribeEventChnl_exit")},loadChannels(){let e=this.realms.value;if(!e)return;let t=this;this.channels.innerHTML="",p.emit("realm.announcement.channel.list",e,n=>{n.forEach(r=>{let s=document.createElement("option");s.value=r.chid,s.innerHTML=r.name,t.channels.appendChild(s)})})},show(e,t){this.realms.innerHTML="",this.realms.onchange=()=>this.loadChannels();let n=this;p.emit("realm.announcement.channel.available",r=>{r.forEach(s=>{let i=document.createElement("option");i.value=s,i.innerHTML=E.www.changeChat(s),n.realms.appendChild(i)}),this.loadChannels()}),this.okBtn.onclick=()=>{let r=this.realms.value,s=this.channels.value;r&&s&&(p.emit("realm.announcement.channel.subscribe",e,t,r,s),this.popup.fadeOut())},this.cancelBtn.onclick=()=>{this.popup.fadeOut()},this.popup.fadeIn()}};pr.init();fr=pr;re.subscribeEventChnl=pr});var Li={};le(Li,{default:()=>sa});var Ti,sa,ki=b(()=>{T();cn();$();W();oe();V();se();P();Ne();K();Q();Kt();hr();j();g("interact/context");Ti={message(e){let t=document.querySelector("#message_context_menu").getAttribute("_id");switch(e){case"copy":let n=document.querySelector("#mess__"+t+" .mess_content").getAttribute("_plain");L.writeToClipboard(n).then(i=>{i&&y.uiMsgT(c.ui.copied)});break;case"edit":He.editMess(t);break;case"delete":He.deleteMess(t);break;case"reply":m.temp.replyId=t,M.replyClose.style.display="block",document.querySelector("#mess__"+t).style.backgroundColor="var(--panel)";break;case"copy_id":L.writeToClipboard(t).then(i=>{i&&y.uiMsgT(c.ui.copied)});break;case"add_reaction":let r=m.chat.chnl;if(r&&!m.realm.chnlPerms[r].react)return y.uiMsgT(c.ui.message.no_react,["!"]);Qe.emocjiPopup(i=>{i&&p.emit("message.react",m.chat.to,t,i)});break;case"pin":case"unpin":p.emit("message.pin",m.chat.to,m.chat.chnl,t,e==="pin");break;case"create_thread":He.createThread(t);break;default:console.error(e)}},async realm(e){let t=document.querySelector("#realm_context_menu").getAttribute("_id");switch(e){case"copy_id":L.writeToClipboard(t).then(v=>{v&&y.uiMsgT(c.ui.copied)});break;case"copy_invite":let n=location.protocol+"//"+location.host+"/ir?id="+t;L.writeToClipboard(n).then(v=>{v&&y.uiMsgT(c.ui.copied)});break;case"exit":await y.confirm(U(c.ui.confirm.exit_realm,E.www.changeChat(t))+"?")&&(p.emit("realm.exit",t),C.changeChat("main"));break;case"mute":let s=m.realms.find(v=>v.realm==t);if(!s)return;let i=!1,o;s.muted!=null&&(s.muted==-1?i=!1:s.muted==0?i=!0:s.muted>new Date().getTime()?(i=!0,o=new Date(s.muted).toLocaleString()):i=!1);let l=i?c.ui.muted:c.ui.unmuted,u="";if(i){if(s.muted===0)u=c.ui.mute.is_permanent;else if(s.muted>new Date().getTime()){let v=new Date(s.muted).toLocaleString();u=U(c.ui.mute.ends_at,v)}}let d=`
                    ${U(c.ui.mute.realm,E.www.changeChat(t))}
                    <br />
                    ${c.ui.status}: ${l}
                    ${u?"<br />"+u:""}
                `,h=c.ui.durations;y.selectPrompt(d,[h.minutes15,h.hour1,h.day1,h.permanently,c.ui.mute.unmute,c.uni.cancel]).then(v=>{if(!v)return;let _=new Date,w=-1;switch(v){case h.minutes15:_.setMinutes(_.getMinutes()+15),w=_.getTime();break;case h.hour1:_.setHours(_.getHours()+1),w=_.getTime();break;case h.day1:_.setDate(_.getDate()+1),w=_.getTime();break;case h.permanently:w=0;break;case c.ui.mute.unmute:w=-1;break;case c.uni.cancel:return}p.emit("realm.mute",t,w),s.muted=w});break;case"settings":p.emit("realm.settings.get",t);break;default:console.error(e)}},channel(e){let t=document.querySelector("#channel_context_menu").getAttribute("_id");switch(e){case"copy_id":L.writeToClipboard(t).then(r=>{r&&y.uiMsgT(c.ui.copied)});break;case"subscribe":fr.show(m.chat.to,t);break;case"create_thread":He.createThread();break;default:console.error(e)}},async thread(e){let t=document.querySelector("#thread_context_menu").getAttribute("_id");switch(e){case"copy_id":L.writeToClipboard(t).then(i=>{i&&y.uiMsgT(c.ui.copied)});break;case"delete":if(!await y.confirm(c.ui.confirm.delete_thread+"?"))return;let r=m.realm.threads.find(i=>i._id==t);if(!r||m.user._id!==r.author&&!te.isAdmin())return;p.emit("realm.thread.delete",m.chat.to,t),document.querySelector("#channel_\\&"+r._id)?.remove(),document.querySelector("#thread__"+r._id)?.remove(),m.chat.chnl=="&"+r._id&&C.changeChnl(r.thread);break;default:console.error(e)}}};re.contextFunc=Ti;sa=Ti});var Si={};le(Si,{default:()=>ia});var Ci,xi,ia,Ii=b(()=>{T();V();P();K();Q();j();g("interact/relations");Ci=qt.makeRealm,xi={async addDm(){let e=await y.prompt(c.ui.enter_dm);e&&p.emit("dm.create",e)},async createRealm(){Ci.fadeOut();let e=await y.prompt(c.ui.create_realm_name);e&&(p.emit("realm.create",e),setTimeout(()=>{p.emit("realm.get")},1500))},async joinRealm(){Ci.fadeOut();let e=await y.prompt(c.ui.enter_realm_invite);e&&(e=e.replace(location.protocol+"//","").replace(location.host,"").replace("/ir?id=",""),p.emit("realm.join",e))}},ia=xi;Y.buttonFunc=xi});var oa={};var Hi=b(async()=>{T();ie();W();se();P();mn();j();g("start");x.init();await E.app.init();C.changeChat("main");await Is();p.connect();setTimeout(async()=>{await at.handleGetParam(),at.removeControlParams()},3e3);setTimeout(async()=>{let e=yr(),t=vr(),n=Er().length,r=br().length;x.msg(1,`Loaded ${n}/${r} (${Math.round(n/r*100)}%) modules.`),e.length>0&&x.msg(2,"Unexpected modules:",e),t.length>0&&x.msg(2,"Unregistered modules:",t)},1e3)});var aa={};var Di=b(()=>{T();ie();j();g("warning");(function(){if(x.isDebug)return;let e=c.common.console_warning;["60px;color:gold","20px","20px;color:red","20px"].forEach((n,r)=>{console.log(`%c${e["w"+(r+1)]}`,`font-size:${n}`)})})()});await Promise.resolve().then(()=>(Mr(),Ai));await Promise.resolve().then(()=>($(),Tr));await Promise.resolve().then(()=>(K(),kr));await Promise.resolve().then(()=>(P(),xr));await Promise.resolve().then(()=>(Gs(),Uo));await Promise.resolve().then(()=>(vt(),Es));await Promise.resolve().then(()=>(Zs(),Oo));await Promise.resolve().then(()=>(ei(),No));await Promise.resolve().then(()=>(ri(),zo));await Promise.resolve().then(()=>(vn(),Dr));await Promise.resolve().then(()=>(Zt(),es));await Promise.resolve().then(()=>(Mi(),Ei));await Promise.resolve().then(()=>(ki(),Li));await Promise.resolve().then(()=>(Sn(),Zr));await Promise.resolve().then(()=>(Ii(),Si));await Promise.resolve().then(()=>(hr(),wi));await Hi().then(()=>oa);await Promise.resolve().then(()=>(Di(),aa));
//# sourceMappingURL=startApp.js.map
