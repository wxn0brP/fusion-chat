import { genId } from "@wxn0brp/db";
import PermissionSystem from "./permission-system/index.js";
import Permissions, { getAllPermissions } from "./permission-system/permission.js";
import db from "../dataBase.js";
export function combineId(id_1, id_2) {
    const [id1, id2] = [id_1, id_2].sort();
    const p1 = id1.split("-")[0];
    const p2 = id2.split("-")[0];
    const mix = (a, b) => a.split("-")[1].slice(0, 3) + b.split("-")[1].slice(0, 3);
    const pp = mix(id1, id2);
    const chatId = [p1, p2, pp].join("-");
    return chatId;
}
export async function chatExists(chatId) {
    return await db.realmConf.issetCollection(chatId);
}
export async function createChat(name, ownerId) {
    const chatId = genId();
    await db.realmConf.add(chatId, {
        name,
        owner: ownerId,
        img: false,
        _id: "set"
    });
    const permSys = new PermissionSystem(chatId);
    const rootRole = await permSys.createRole("root", { p: getAllPermissions(Permissions) });
    const categoryId = genId();
    await db.realmConf.add(chatId, {
        cid: categoryId,
        name: "general",
        i: 0,
    }, false);
    await db.realmConf.add(chatId, {
        chid: genId(),
        name: "main",
        type: "text",
        category: categoryId,
        i: 0,
        rp: []
    }, false);
    await db.realmConf.add(chatId, {
        chid: genId(),
        name: "general",
        type: "voice",
        category: categoryId,
        i: 1,
        rp: []
    }, false);
    await db.mess.checkCollection(chatId);
    await addUserToChat(chatId, ownerId, [rootRole._id]);
    return chatId;
}
export async function addUserToChat(chatId, userId, roles = []) {
    await db.realmUser.add(chatId, {
        u: userId,
        r: roles
    }, false);
    await db.userData.add(userId, {
        realm: chatId,
    }, false);
}
export async function exitChat(chatId, userId) {
    await db.realmUser.removeOne(chatId, { u: userId });
    await db.userData.removeOne(userId, { realm: chatId });
}
export async function createPriv(toId, fromId) {
    await db.userData.add(toId, {
        priv: fromId
    }, false);
    await db.userData.add(fromId, {
        priv: toId
    }, false);
    await db.mess.checkCollection(combineId(toId, fromId));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hhdE1nbXQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9iYWNrL2xvZ2ljL2NoYXRNZ210LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxnQkFBZ0IsTUFBTSwyQkFBMkIsQ0FBQztBQUN6RCxPQUFPLFdBQVcsRUFBRSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDaEYsT0FBTyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBVXJCLE1BQU0sVUFBVSxTQUFTLENBQUMsSUFBUSxFQUFFLElBQVE7SUFDeEMsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUd2QyxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdCLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFHN0IsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBR2hGLE1BQU0sRUFBRSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFHekIsTUFBTSxNQUFNLEdBQUcsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxH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