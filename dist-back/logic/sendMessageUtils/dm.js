import NodeCache from "node-cache";
import db from "../../dataBase.js";
import { combineId } from "../chatMgmt.js";
import InternalCode from "../../codes/index.js";
import getCacheSettings from "../cacheSettings.js";
const blockedCache = new NodeCache(getCacheSettings("DmBlock"));
const userDmCache = new NodeCache(getCacheSettings("UserDm"));
async function blocked(fr, to, combined) {
    if (blockedCache.has(combined))
        return blockedCache.get(combined);
    const blocked = await db.userData.findOne("blocked", {
        $or: [
            { fr: fr, to: to },
            { fr: to, to: fr }
        ]
    });
    const isBlocked = !!blocked;
    blockedCache.set(combined, isBlocked);
    return isBlocked;
}
async function exists(fr, to, combined) {
    if (userDmCache.has(combined))
        return userDmCache.get(combined);
    const priv = await db.userData.findOne(fr, { priv: to });
    const toPriv = await db.userData.findOne(to, { priv: fr });
    const exists = !!priv && !!toPriv;
    userDmCache.set(combined, exists);
    return exists;
}
async function checkDmChat(fr, to, combined, validE) {
    const isBlocked = await blocked(fr, to, combined);
    if (isBlocked)
        return validE.err(InternalCode.UserError.Socket.Dm_Blocked);
    const isExists = await exists(fr, to, combined);
    if (!isExists)
        return validE.err(InternalCode.UserError.Socket.Dm_NotFound);
}
export default checkDmChat;
export function clearBlockedCache(fr, to) {
    const combined = combineId(fr, to);
    blockedCache.del(combined);
}
export function clearUserDmCache(fr, to) {
    const combined = combineId(fr, to);
    userDmCache.del(combined);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG0uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9iYWNrL2xvZ2ljL3NlbmRNZXNzYWdlVXRpbHMvZG0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxTQUFTLE1BQU0sWUFBWSxDQUFDO0FBQ25DLE9BQU8sRUFBRSxNQUFNLEtBQUssQ0FBQztBQUNyQixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBSXhDLE9BQU8sWUFBWSxNQUFNLFFBQVEsQ0FBQztBQUNsQyxPQUFPLGdCQUFnQixNQUFNLGtCQUFrQixDQUFDO0FBRWhELE1BQU0sWUFBWSxHQUFHLElBQUksU0FBUyxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7QUFDaEUsTUFBTSxXQUFXLEdBQUcsSUFBSSxTQUFTLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztBQUU5RCxLQUFLLFVBQVUsT0FBTyxDQUFDLEVBQU0sRUFBRSxFQUFNLEVBQUUsUUFBWTtJQUMvQyxJQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQUUsT0FBTyxZQUFZLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRWpFLE1BQU0sT0FBTyxHQUFHLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFO1FBQ2pELEdBQUcsRUFBRTtZQUNELEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFO1lBQ2xCLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFO1NBQ3JCO0tBQ0osQ0FBQyxDQUFDO0lBQ0gsTUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztJQUM1QixZQUFZLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxTQUFTLENBQUMsQ0FBQztJQUN0QyxPQUFPLFNBQVMsQ0FBQztBQUNyQixDQUFDO0FBRUQsS0FBSyxVQUFVLE1BQU0sQ0FBQyxFQUFNLEVBQUUsRUFBTSxFQUFFLFFBQVk7SUFDOUMsSUFBRyxXQUFXLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUFFLE9BQU8sV0FBVyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUUvRCxNQUFNLElBQUksR0FBRyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ3pELE1BQU0sTUFBTSxHQUFHLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDM0QsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQ2xDLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQ2xDLE9BQU8sTUFBTSxDQUFDO0FBQ2xCLENBQUM7QUFFRCxLQUFLLFVBQVUsV0FBVyxDQUFDLEVBQU0sRUFBRSxFQUFNLEVBQUUsUUFBWSxFQUFFLE1BQWtCO0lBQ3ZFLE1BQU0sU0FBUyxHQUFHLE1BQU0sT0FBTyxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDbEQsSUFBRyxTQUFTO1FBQUUsT0FBTyxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBRTFFLE1BQU0sUUFBUSxHQUFHLE1BQU0sTUFBTSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsUUFBUSxDQUFDLENBQUM7SUFDaEQsSUFBRyxDQUFDLFFBQVE7UUFBRSxPQUFPLE1BQU0sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7QUFDL0UsQ0FBQztBQUVELGVBQWUsV0FBVyxDQUFDO0FBRTNCLE1BQU0sVUFBVSxpQkFBaUIsQ0FBQyxFQUFNLEVBQUUsRUFBTTtJQUM1QyxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLFlBQVksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsQ0FBQztBQUVELE1BQU0sVUFBVSxnQkFBZ0IsQ0FBQyxFQUFNLEVBQUUsRUFBTTtJQUMzQyxNQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ25DLFdBQVcsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDOUIsQ0FBQyJ9