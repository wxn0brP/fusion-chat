import valid from "../../../../logic/validData.js";
import ValidError from "../../../../logic/validError.js";
import permissionSystem from "../../../../logic/permission-system/index.js";
import Permissions, * as PermissionFunctions from "../../../../logic/permission-system/permission.js";
import db from "../../../../dataBase.js";
const DEFAULT_SECTIONS = [
    "meta",
    "categories",
    "channels",
    "roles",
    "users",
    "banUsers",
    "emojis",
    "webhooks"
];
const REQUIRED_PERMISSIONS = {
    meta: [],
    categories: [Permissions.manageChannels],
    channels: [Permissions.manageChannels],
    roles: [Permissions.manageRoles],
    emojis: [Permissions.manageEmojis],
    webhooks: [Permissions.manageWebhooks],
    banUsers: [Permissions.banUser],
    users: []
};
export default async function realm_settings_get(suser, id, sections = []) {
    const validator = new ValidError("realm.settings.get");
    if (!valid.id(id))
        return validator.valid("id");
    if (!valid.arrayString(sections))
        return validator.valid("sections");
    sections = sections.length ? sections : [...DEFAULT_SECTIONS];
    const permSystem = new permissionSystem(id);
    const userPerms = await permSystem.getUserPermissions(suser._id);
    if (!hasRequiredPermissions(userPerms)) {
        return validator.err("You don't have permission to edit this realm");
    }
    const data = {
        addons: {}
    };
    const dbData = await fetchRequiredData(id, sections);
    await Promise.all(sections.map(section => processSection(section, data, dbData, userPerms, id, suser._id)));
    return { err: false, res: data };
}
function hasRequiredPermissions(userPerms) {
    const requiredPerms = [
        Permissions.admin,
        Permissions.manageEmojis,
        Permissions.manageInvites,
        Permissions.manageMessages,
        Permissions.manageRoles,
        Permissions.manageWebhooks
    ];
    return PermissionFunctions.hasAnyPermission(userPerms, requiredPerms);
}
function canAccessData(userPerms, requiredPerms = []) {
    return PermissionFunctions.hasAnyPermission(userPerms, [
        Permissions.admin,
        ...requiredPerms
    ]);
}
async function fetchRequiredData(id, sections) {
    const sectionsRequiringDb = ["meta", "categories", "channels", "banUsers", "emojis", "webhooks"];
    if (!sections.some(section => sectionsRequiringDb.includes(section))) {
        return null;
    }
    return await db.realmConf.find(id, {});
}
async function processSection(section, data, dbData, userPerms, realmId, userId) {
    if (!canAccessData(userPerms, REQUIRED_PERMISSIONS[section])) {
        return;
    }
    switch (section) {
        case "meta":
            const metaData = dbData.find(d => d._id === "set");
            if (metaData) {
                const { _id, ...meta } = metaData;
                data.meta = meta;
            }
            break;
        case "categories":
            data.categories = dbData.filter(d => !!d.cid);
            break;
        case "channels":
            data.channels = dbData.filter(d => !!d.chid);
            data.addons.subscribedChannels = await getSubscribedChannels(realmId);
            break;
        case "roles":
            data.roles = await getAdjustedRoles(realmId, userId);
            break;
        case "emojis":
            data.emojis = dbData.filter(d => !!d.emoji);
            break;
        case "webhooks":
            data.webhooks = dbData.filter(d => !!d.whid);
            break;
        case "banUsers":
            data.banUsers = dbData.filter(d => !!d.ban).map(u => u.ban);
            break;
        case "users":
            const users = await db.realmUser.find(realmId, {});
            data.users = users.map(u => {
                let uid = u.u;
                if (u.bot)
                    uid = "^" + u.bot;
                return { u: uid, r: u.r };
            });
            break;
        default:
            const n = section;
            return n;
    }
}
async function getAdjustedRoles(realm, userId) {
    const permSys = new permissionSystem(realm);
    const allRoles = await permSys.getAllRolesSorted();
    const userHighestRole = await permSys.getUserHighestRole(userId);
    const highestLvl = userHighestRole.lvl;
    const adjustedData = [];
    for (const role of allRoles) {
        const adjRole = { _id: role._id, lvl: role.lvl, name: role.name, p: -1, c: role.c };
        if (role.lvl >= highestLvl) {
            adjRole.p = role.p;
        }
        adjustedData.push(adjRole);
    }
    return adjustedData;
}
async function getSubscribedChannels(realmId) {
    const channels = await db.realmData.find("announcement.channels", { tr: realmId }, {}, {}, { exclude: ["tr"] });
    const realms = groupBySource(channels);
    for (const realm of realms) {
        const names = await db.realmConf.find(realm.sr, {
            $or: realm.scs.map(sc => ({ chid: sc })),
        }, {}, {}, {
            select: ["chid", "name"]
        });
        channels.forEach(channel => {
            channel.name = names.find(n => n.chid == channel.sc).name;
        });
    }
    return channels;
}
function groupBySource(data) {
    const grouped = {};
    data.forEach((chnl) => {
        const { sr, sc } = chnl;
        if (!grouped[sr]) {
            grouped[sr] = { sr, scs: [] };
        }
        grouped[sr].scs.push(sc);
    });
    return Object.values(grouped);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vYmFjay9zb2NrZXQvY2hhdC9sb2dpYy9yZWFsbVNldHRpbmdzL2dldC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssTUFBTSxrQkFBa0IsQ0FBQztBQUNyQyxPQUFPLFVBQVUsTUFBTSxtQkFBbUIsQ0FBQztBQUMzQyxPQUFPLGdCQUFnQixNQUFNLGdDQUFnQyxDQUFDO0FBQzlELE9BQU8sV0FBVyxFQUFFLEtBQUssbUJBQW1CLE1BQU0scUNBQXFDLENBQUM7QUFDeEYsT0FBTyxFQUFFLE1BQU0sS0FBSyxDQUFDO0FBT3JCLE1BQU0sZ0JBQWdCLEdBQUc7SUFDckIsTUFBTTtJQUNOLFlBQVk7SUFDWixVQUFVO0lBQ1YsT0FBTztJQUNQLE9BQU87SUFDUCxVQUFVO0lBQ1YsUUFBUTtJQUNSLFVBQVU7Q0FDSixDQUFDO0FBSVgsTUFBTSxvQkFBb0IsR0FBRztJQUN6QixJQUFJLEVBQUUsRUFBRTtJQUNSLFVBQVUsRUFBRSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUM7SUFDeEMsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQztJQUN0QyxLQUFLLEVBQUUsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDO0lBQ2hDLE1BQU0sRUFBRSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUM7SUFDbEMsUUFBUSxFQUFFLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQztJQUN0QyxRQUFRLEVBQUUsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDO0lBQy9CLEtBQUssRUFBRSxFQUFFO0NBQ1osQ0FBQztBQVNGLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxVQUFVLGtCQUFrQixDQUFDLEtBQWtCLEVBQUUsRUFBTSxFQUFFLFdBQW9CLEVBQUU7SUFDL0YsTUFBTSxTQUFTLEdBQUcsSUFBSSxVQUFVLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUN2RCxJQUFHLENB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