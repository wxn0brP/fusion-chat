import { db, processDbChanges } from "./imports.js";
import fs from "fs";
export default async (id, data, suser, dbData) => {
    const oldEmojis = dbData.filter(d => "emoji" in d);
    const changes = processDbChanges(oldEmojis, data.emojis, ["name"], "emoji");
    await processEmojis(id, changes);
};
async function processEmojis(id, changes) {
    const basePath = `userFiles/realms/${id}/emojis/`;
    for (const rmEmoji of changes.itemsToRemove) {
        const path = `${basePath}${rmEmoji.emoji}.png`;
        if (fs.existsSync(path))
            fs.unlinkSync(path);
    }
    if (changes.itemsToRemove.length > 0) {
        const statements = changes.itemsToRemove.map(e => ({ emoji: e.emoji }));
        await db.realmConf.remove(id, {
            $or: statements
        });
    }
    for (const item of changes.itemsToUpdate) {
        await db.realmConf.updateOne(id, { emoji: item.emoji }, item);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW1vamlzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vYmFjay9zb2NrZXQvY2hhdC9sb2dpYy9yZWFsbVNldHRpbmdzL3NldC9lbW9qaXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEVBQUUsRUFBb0IsZ0JBQWdCLEVBQTZELE1BQU0sV0FBVyxDQUFDO0FBQzlILE9BQU8sRUFBRSxNQUFNLElBQUksQ0FBQztBQUVwQixlQUFlLEtBQUssRUFBRSxFQUFNLEVBQUUsSUFBMEIsRUFBRSxLQUFrQixFQUFFLE1BQXdCLEVBQUUsRUFBRTtJQUN0RyxNQUFNLFNBQVMsR0FBeUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN6RSxNQUFNLE9BQU8sR0FBRyxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzVFLE1BQU0sYUFBYSxDQUFDLEVBQUUsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUNyQyxDQUFDLENBQUE7QUFLRCxLQUFLLFVBQVUsYUFBYSxDQUFDLEVBQU0sRUFBRSxPQUErQjtJQU1oRSxNQUFNLFFBQVEsR0FBRyxvQkFBb0IsRUFBRSxVQUFVLENBQUM7SUFDbEQsS0FBSSxNQUFNLE9BQU8sSUFBSSxPQUFPLENBQUMsYUFBYSxFQUFDLENBQUM7UUFDeEMsTUFBTSxJQUFJLEdBQUcsR0FBRyxRQUFRLEdBQUcsT0FBTyxDQUFDLEtBQUssTUFBTSxDQUFDO1FBQy9DLElBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUM7WUFDbEIsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QixDQUFDO0lBR0QsSUFBRyxPQUFPLENBQUMsYUFBYSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUMsQ0FBQztRQUNqQyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4RSxNQUFNLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRTtZQUMxQixHQUFHLEVBQUUsVUFBVTtTQUNsQixDQUFDLENBQUM7SUFDUCxDQUFDO0lBR0QsS0FBSSxNQUFNLElBQUksSUFBSSxPQUFPLENBQUMsYUFBYSxFQUFDLENBQUM7UUFDckMsTUFBTSxFQUFFLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ2xFLENBQUM7QUFDTCxDQUFDIn0=